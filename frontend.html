<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MommyShops - Cosmetic Ingredient Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f6f6fb;
            --bg-hero: linear-gradient(120deg, #fdf8ff 0%, #f6f9ff 45%, #f9fffb 100%);
            --color-primary: #7C3AED;
            --color-primary-accent: #F472B6;
            --color-secondary: #FDB8C6;
            --color-dark: #0F172A;
            --color-muted: #6b7280;
            --color-card: #ffffff;
            --color-border: rgba(15, 23, 42, 0.08);
            --shadow-soft: 0 20px 45px rgba(15, 23, 42, 0.08);
            --shadow-strong: 0 35px 65px rgba(124, 58, 237, 0.16);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 0;
            color: var(--color-dark);
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        .site-nav {
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
            background: rgba(246, 246, 251, 0.96);
            border-bottom: 1px solid rgba(124, 58, 237, 0.08);
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 32px;
        }

        .nav-logo {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            font-weight: 600;
            color: var(--color-muted);
        }

        .nav-links a {
            padding: 8px 4px;
            position: relative;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            height: 2px;
            width: 100%;
            background: var(--color-primary);
            transform: scaleX(0);
            transform-origin: center;
            transition: transform 0.2s ease;
        }

        .nav-links a:hover::after {
            transform: scaleX(1);
        }

        .nav-cta {
            display: flex;
            gap: 12px;
        }

        .btn {
            border-radius: 999px;
            padding: 10px 20px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(120deg, #7C3AED, #EC4899);
            color: white;
            box-shadow: 0 15px 30px rgba(124, 58, 237, 0.25);
        }

        .btn-secondary {
            background: rgba(124, 58, 237, 0.08);
            color: var(--color-primary);
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .site-hero {
            background: var(--bg-hero);
            padding: 80px 24px 60px;
        }

        .hero-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 40px;
            align-items: center;
        }

        .hero-copy h1 {
            font-size: clamp(2rem, 4vw, 3.2rem);
            line-height: 1.1;
            margin-bottom: 18px;
        }

        .hero-copy p {
            font-size: 1.1rem;
            color: var(--color-muted);
            margin-bottom: 28px;
        }

        .hero-metrics {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .metric-card {
            background: #fff;
            border-radius: 18px;
            padding: 16px;
            flex: 1;
            min-width: 120px;
            box-shadow: var(--shadow-soft);
        }

        .metric-card strong {
            font-size: 1.8rem;
            display: block;
        }

        .hero-visual {
            background: linear-gradient(140deg, rgba(124, 58, 237, 0.08), rgba(14, 165, 233, 0.15));
            border-radius: 28px;
            padding: 28px;
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        .hero-visual::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 20%, rgba(252, 231, 243, 0.8), transparent 60%);
            pointer-events: none;
        }

        .hero-visual h3 {
            margin-bottom: 12px;
            color: var(--color-primary);
        }

        .hero-visual ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 10px;
        }

        .hero-visual li {
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 14px;
            border-radius: 14px;
            font-weight: 600;
        }

        .trust-bar {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            color: var(--color-muted);
            font-size: 0.9rem;
        }

        .trust-logos {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .trust-logos span {
            font-weight: 600;
            color: #94a3b8;
        }

        .site-section {
            padding: 60px 24px;
        }

        .journey-section {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 28px;
        }

        .journey-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .journey-card {
            background: var(--color-card);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--color-border);
            scroll-snap-align: start;
        }

        .journey-card span {
            font-size: 0.85rem;
            color: var(--color-muted);
        }

        .journey-card strong {
            font-size: 1.2rem;
            display: block;
            margin-bottom: 8px;
            color: var(--color-primary);
        }

        .pillars-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
        }

        .pillar-card {
            border-radius: 18px;
            padding: 18px 20px;
            border: 1px solid rgba(124, 58, 237, 0.15);
            background: rgba(255, 255, 255, 0.9);
            scroll-snap-align: start;
        }

        .pillar-card h4 {
            margin-bottom: 6px;
            color: var(--color-primary);
        }

        .sticky-assistant {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 40;
            background: linear-gradient(135deg, #7C3AED, #EC4899);
            color: white;
            border-radius: 16px;
            padding: 18px 22px;
            box-shadow: 0 18px 35px rgba(124, 58, 237, 0.4);
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: min(280px, 80vw);
        }

        .sticky-assistant summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .sticky-assistant summary::-webkit-details-marker { display: none; }

        .sticky-assistant button {
            margin-top: 6px;
            border: none;
            border-radius: 12px;
            padding: 10px;
            background: rgba(15, 23, 42, 0.15);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .assistant-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
            padding: 20px;
        }

        .modal-backdrop.is-visible {
            display: flex;
        }

        .signup-modal {
            background: #fff;
            border-radius: 24px;
            max-width: 480px;
            width: 100%;
            padding: 28px;
            box-shadow: var(--shadow-strong);
        }

        .signup-modal h3 {
            margin-bottom: 8px;
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .signup-modal p {
            color: var(--color-muted);
            margin-bottom: 20px;
        }

        .modal-form {
            display: grid;
            gap: 12px;
        }

        .modal-form label {
            font-size: 0.85rem;
            color: var(--color-muted);
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            font-family: inherit;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 8px;
        }

        .profile-wizard-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
            padding: 24px;
        }

        .profile-wizard-backdrop.is-visible {
            display: flex;
        }

        .profile-wizard {
            background: #fff;
            border-radius: 28px;
            width: min(640px, 100%);
            padding: 28px;
            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.25);
            position: relative;
        }

        .wizard-close {
            position: absolute;
            top: 18px;
            right: 18px;
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--color-muted);
        }

        .wizard-progress {
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 12px;
        }

        .wizard-step {
            display: none;
            animation: fadeSlide 0.25s ease;
        }

        .wizard-step.is-active {
            display: block;
        }

        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .wizard-chip {
            border: 1px solid rgba(124, 58, 237, 0.18);
            border-radius: 16px;
            padding: 10px 14px;
            background: #fff;
            font-weight: 600;
            color: var(--color-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .wizard-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
        }

        .wizard-chip.is-active {
            border-color: transparent;
            background: rgba(124, 58, 237, 0.15);
            color: var(--color-primary);
            box-shadow: 0 8px 18px rgba(124, 58, 237, 0.25);
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 18px;
        }

        .wizard-actions .btn-secondary {
            flex: 1;
            margin-right: 12px;
        }

        .wizard-actions .btn-primary {
            flex: 1;
        }

        .progress-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }

        .progress-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(124, 58, 237, 0.12);
            color: var(--color-primary);
            font-size: 0.82rem;
            font-weight: 600;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto 60px;
            background: var(--color-card);
            border-radius: 24px;
            box-shadow: var(--shadow-strong);
            overflow: hidden;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 24px;
            padding: 32px 40px 48px;
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            .hero-inner {
                grid-template-columns: 1fr;
            }
            .hero-visual {
                order: -1;
            }
            .app-shell {
                grid-template-columns: 1fr;
                padding: 24px;
            }
            .sticky-assistant {
                right: 12px;
                bottom: 12px;
            }
            .journey-grid,
            .pillars-grid {
                display: flex;
                overflow-x: auto;
                padding-bottom: 6px;
                scroll-snap-type: x mandatory;
                gap: 14px;
            }
            .journey-card,
            .pillar-card {
                min-width: 240px;
            }
            .steps-pane {
                position: static;
                max-height: none;
                overflow: visible;
            }
        }

        .steps-pane {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow-soft);
            position: sticky;
            top: 24px;
            align-self: start;
            max-height: calc(100vh - 48px);
            overflow-y: auto;
        }

        .steps-pane h2 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 16px;
        }

        .steps-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 14px;
        }

        .steps-item {
            display: grid;
            grid-template-columns: 36px 1fr;
            gap: 12px;
            align-items: center;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(168, 85, 247, 0.18);
            background: rgba(255, 255, 255, 0.85);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .steps-item .step-index {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            background: rgba(168, 85, 247, 0.12);
            color: var(--color-primary);
        }

        .steps-item .step-label {
            font-weight: 600;
            color: var(--color-dark);
        }

        .steps-item .step-hint {
            font-size: 0.82rem;
            color: var(--color-muted);
        }

        .steps-item.is-active {
            border-color: var(--color-primary);
            box-shadow: 0 10px 22px rgba(168, 85, 247, 0.16);
            transform: translateY(-2px);
        }

        .steps-item.is-active .step-index {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-accent));
            color: #fff;
        }

        .steps-item.is-nav-focus:not(.is-active) {
            border-color: var(--color-primary);
            box-shadow: 0 12px 26px rgba(168, 85, 247, 0.16);
        }

        .steps-item.is-nav-focus:not(.is-active) .step-index {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-accent));
            color: #fff;
        }

        .steps-item.is-complete {
            opacity: 0.85;
        }

        .steps-item.is-complete .step-index {
            background: rgba(16, 185, 129, 0.18);
            color: #059669;
        }

        .header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-accent));
            color: #ffffff;
            padding: 40px;
            text-align: center;
        }

        .app-brand {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
        }

        .brand-logo {
            height: 52px;
            width: auto;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            border: 0;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .main-content {
            padding: 40px;
        }

        .profile-card {
            background: linear-gradient(145deg, rgba(252, 251, 255, 0.95), rgba(255, 255, 255, 0.98));
            border-radius: 28px;
            padding: 28px;
            border: 1px solid rgba(124, 58, 237, 0.12);
            box-shadow: var(--shadow-soft);
            margin-bottom: 30px;
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .profile-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(124, 58, 237, 0.12);
            color: var(--color-primary);
            font-weight: 600;
        }

        .profile-hero {
            font-size: 1.9rem;
            font-weight: 700;
            color: var(--color-dark);
            margin: 8px 0;
        }

        .profile-highlights {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 16px 0 8px;
        }

        .profile-highlight {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.92rem;
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.08);
            background: rgba(15, 23, 42, 0.08);
            color: var(--color-dark);
        }

        .profile-highlight--skin,
        .profile-highlight--hair,
        .profile-highlight--concern,
        .profile-highlight--goal {
            background: rgba(15, 23, 42, 0.08);
            color: var(--color-dark);
        }

        .profile-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .profile-actions .btn-primary {
            background: linear-gradient(120deg, #7C3AED, #EC4899);
            color: #fff;
        }

        .profile-actions .btn-secondary {
            background: rgba(124, 58, 237, 0.08);
            color: var(--color-primary);
        }

        .profile-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #22c55e;
            color: white;
            padding: 12px 18px;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(34, 197, 94, 0.4);
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 80;
        }

        .profile-toast.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .profile-form {
            display: none;
        }

        .profile-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-pill {
            position: relative;
            display: inline-flex;
            align-items: center;
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid rgba(168, 85, 247, 0.25);
            background: white;
            color: #5b21b6;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .checkbox-pill input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .checkbox-pill.active,
        .checkbox-pill:hover {
            background: rgba(168, 85, 247, 0.15);
            border-color: rgba(168, 85, 247, 0.35);
        }

        .builder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
            margin-top: 18px;
        }

        .builder-card {
            border: 1px solid rgba(168, 85, 247, 0.18);
            border-radius: 14px;
            padding: 18px;
            background: white;
            box-shadow: 0 12px 24px rgba(168, 85, 247, 0.08);
        }

        .builder-card h4 {
            margin-bottom: 8px;
            font-size: 1.1rem;
            color: #5b21b6;
        }

        .builder-card p {
            margin-bottom: 12px;
            color: #4b5563;
            font-size: 0.95rem;
        }

        .builder-card select {
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            padding: 10px;
            font-size: 0.95rem;
        }

        .builder-summary {
            margin-top: 24px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(236, 233, 254, 0.9));
            padding: 18px;
            border-radius: 14px;
            border: 1px solid rgba(168, 85, 247, 0.18);
        }

        .builder-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 18px;
        }

        .builder-actions button {
            border-radius: 999px;
            padding: 10px 20px;
            font-weight: 600;
            border: 1px solid rgba(168, 85, 247, 0.35);
            background: white;
            color: #5b21b6;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .builder-actions button.primary {
            background: linear-gradient(135deg, #A855F7, #8B5CF6);
            color: white;
            border: none;
        }

        .builder-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(168, 85, 247, 0.18);
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed rgba(168, 85, 247, 0.25);
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--color-primary);
            background: rgba(168, 85, 247, 0.08);
        }

        .upload-area {
            text-align: center;
            padding: 40px;
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--color-primary);
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-accent));
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: var(--shadow-soft);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(168, 85, 247, 0.2);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            color: var(--color-dark);
            background: rgba(255,255,255,0.9);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15);
        }

        .analyze-btn {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-accent));
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            box-shadow: var(--shadow-soft);
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            display: none;
        }

        .results-section.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-card {
            background: var(--color-card);
            border-radius: 18px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
        }

        .card-collapse {
            border: none;
            padding: 0;
            margin: 0;
        }

        .card-collapse > summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            padding: 0;
        }

        .card-collapse > summary::-webkit-details-marker {
            display: none;
        }

        .summary-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 15px;
            font-family: 'Playfair Display', Georgia, serif;
        }

        .summary-info .result-title {
            margin-bottom: 0;
        }

        .summary-subtitle {
            font-size: 0.92rem;
            color: var(--color-muted);
        }

        .summary-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .collapse-icon {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: 1px solid rgba(168, 85, 247, 0.25);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-primary);
            background: rgba(168, 85, 247, 0.08);
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .card-collapse:hover .collapse-icon {
            background: rgba(168, 85, 247, 0.15);
        }

        .card-collapse[open] .collapse-icon::after {
            content: 'âˆ’';
        }

        .card-collapse:not([open]) .collapse-icon::after {
            content: '+';
        }

        .card-body {
            margin-top: 18px;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(168, 85, 247, 0.08);
            border-radius: 12px;
            border-left: 4px solid rgba(168, 85, 247, 0.5);
        }

        .ingredient-item.warning {
            border-left-color: #f59e0b;
        }

        .ingredient-item.danger {
            border-left-color: #ef4444;
        }

        .ingredient-name {
            font-weight: 600;
            color: var(--color-dark);
        }

        .ingredient-score {
            background: rgba(16, 185, 129, 0.2);
            color: #047857;
            padding: 6px 16px;
            border-radius: 999px;
            font-weight: 600;
        }

        .ingredient-score.warning {
            background: rgba(245, 158, 11, 0.25);
            color: #b45309;
        }

        .ingredient-score.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #b91c1c;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.6);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.12);
            color: #b91c1c;
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid rgba(239, 68, 68, 0.25);
        }

        .success {
            background: rgba(16, 185, 129, 0.12);
            color: #047857;
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid rgba(16, 185, 129, 0.25);
        }

        .preview-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tabs {
            display: flex;
            margin-bottom: 24px;
            background: rgba(168, 85, 247, 0.08);
            border-radius: 12px;
            padding: 6px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--color-muted);
        }

        .tab.active {
            background: #ffffff;
            color: var(--color-primary);
            box-shadow: var(--shadow-soft);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .results-wrapper {
            display: grid;
            gap: 20px;
        }

        .muted {
            color: var(--color-muted);
        }

        .score-badge {
            min-width: 88px;
            border-radius: 16px;
            background: rgba(236, 72, 153, 0.15);
            color: var(--color-primary);
            font-weight: 700;
            text-align: center;
            padding: 10px;
            font-size: 1.1rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px;
        }

        .summary-chip {
            background: rgba(168, 85, 247, 0.08);
            border-radius: 14px;
            padding: 12px 14px;
        }

        .summary-chip strong {
            display: block;
            margin-bottom: 4px;
            color: var(--color-primary);
        }

        .ingredient-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ingredient-filter-btn {
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 999px;
            padding: 6px 14px;
            background: #fff;
            font-weight: 600;
            color: var(--color-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ingredient-filter-btn.is-active {
            background: rgba(124, 58, 237, 0.12);
            color: var(--color-primary);
            border-color: transparent;
        }

        .ingredients-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }

        .ingredient-card {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 18px;
            padding: 18px;
            border: 1px solid rgba(124, 58, 237, 0.08);
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .ingredient-card[data-status="warning"] {
            border-color: rgba(248, 113, 113, 0.4);
        }

        .ingredient-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 35px rgba(15, 23, 42, 0.12);
        }

        .ingredient-card[data-level="high"] { border-left: 4px solid #34d399; }
        .ingredient-card[data-level="medium"] { border-left: 4px solid #fbbf24; }
        .ingredient-card[data-level="low"] { border-left: 4px solid #fb7185; }
        .ingredient-card[data-level="neutral"] { border-left: 4px solid rgba(15, 23, 42, 0.15); }

        .ingredient-card h4 {
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .ingredient-meta {
            font-size: 0.85rem;
            color: var(--color-muted);
            margin-bottom: 10px;
        }

        .ingredient-description {
            font-size: 0.92rem;
            color: var(--color-dark);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .ingredient-benefits {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .benefit-badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .benefit-badge--clean { background: #ddf5eb; color: #1f9254; }
        .benefit-badge--hydrate { background: #e4f0fa; color: #16658a; }
        .benefit-badge--calm { background: #fbd2d7; color: #9d174d; }
        .benefit-badge--balance { background: #fff8b5; color: #92400e; }
        .benefit-badge--antiox { background: #fff6cc; color: #854d0e; }
        .benefit-badge--default { background: rgba(15, 23, 42, 0.08); color: var(--color-dark); }

        .recommendations-card {
            background: #fff;
            border-radius: 24px;
            padding: 24px;
            border: 1px solid rgba(124, 58, 237, 0.12);
            box-shadow: var(--shadow-soft);
        }

        .recommendations-summary {
            background: linear-gradient(180deg, #e8fff1 0%, #f8fffc 100%);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 16px;
            font-size: 0.95rem;
            color: #115e38;
        }

        .goal-progress {
            margin-bottom: 12px;
        }

        .goal-progress-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .goal-progress-bar {
            margin-top: 6px;
            height: 8px;
            background: rgba(15, 23, 42, 0.08);
            border-radius: 999px;
            overflow: hidden;
        }

        .goal-progress-bar span {
            display: block;
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(120deg, #34d399, #3b82f6);
        }

        .recommendations-cta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 18px;
        }

        .recommendations-cta .btn {
            flex: 1;
            min-width: 180px;
        }

        .compat-summary {
            margin-bottom: 16px;
            font-size: 0.95rem;
            color: var(--color-muted);
        }

        .compat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
        }

        .compat-card {
            background: #fff;
            border-radius: 18px;
            border: 1px solid rgba(124, 58, 237, 0.1);
            padding: 16px;
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.05);
        }

        .compat-card strong {
            display: block;
            margin-bottom: 6px;
        }

        .compat-level {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 999px;
            padding: 4px 10px;
        }

        .compat-level[data-level="high"] { background: #d9fbe3; color: #1f9254; }
        .compat-level[data-level="medium"] { background: #fff3c4; color: #92400e; }
        .compat-level[data-level="low"] { background: #ffe4e6; color: #b91c1c; }

        .compat-progress {
            height: 6px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.08);
            margin: 10px 0;
            overflow: hidden;
        }

        .compat-progress span {
            display: block;
            height: 100%;
            border-radius: inherit;
        }

        .ingredients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 14px;
            font-size: 0.95rem;
        }

        .ingredients-table thead {
            background: rgba(168, 85, 247, 0.1);
        }

        .ingredients-table th,
        .ingredients-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(168, 85, 247, 0.12);
        }

        .ingredients-table tbody tr:last-child td {
            border-bottom: none;
        }

        .ingredients-table .utility-cell {
            max-width: 260px;
            white-space: normal;
            line-height: 1.45;
            vertical-align: top;
        }

        .alignment-summary {
            border-radius: 14px;
            padding: 14px 16px;
            margin-bottom: 14px;
            font-weight: 500;
            line-height: 1.45;
        }

        .alignment-summary--success {
            background: rgba(16, 185, 129, 0.12);
            color: #047857;
        }

        .alignment-summary--warning {
            background: rgba(239, 68, 68, 0.12);
            color: #b91c1c;
        }

        .alignment-summary--neutral {
            background: rgba(168, 85, 247, 0.1);
            color: var(--color-primary);
        }

        .goal-breakdown {
            margin: 18px 0 4px;
        }

        .goal-breakdown h4 {
            margin: 0 0 10px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--color-muted);
        }

        .goal-breakdown ul {
            margin: 0;
            padding: 0;
            list-style: none;
            display: grid;
            gap: 10px;
        }

        .goal-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.92rem;
            font-weight: 600;
        }

        .goal-pill--success {
            background: rgba(16, 185, 129, 0.14);
            color: #047857;
        }

        .goal-pill--warning {
            background: rgba(239, 68, 68, 0.14);
            color: #b91c1c;
        }

        .goal-pill--neutral {
            background: rgba(168, 85, 247, 0.12);
            color: var(--color-primary);
        }

        .utility-summary {
            font-weight: 600;
            margin-bottom: 6px;
            color: #0f172a;
        }

        .utility-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 6px;
        }

        .utility-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .utility-chip--support {
            background: rgba(16, 185, 129, 0.18);
            color: #047857;
        }

        .utility-chip--conflict {
            background: rgba(239, 68, 68, 0.18);
            color: #b91c1c;
        }

        .utility-note {
            font-size: 0.82rem;
            color: var(--color-muted);
            line-height: 1.4;
        }

        .compat-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.95rem;
        }

        .compat-table thead {
            background: rgba(15, 23, 42, 0.08);
        }

        .compat-table th,
        .compat-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
            text-align: left;
        }

        .compat-table tbody tr:last-child td {
            border-bottom: none;
        }

        .compat-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .compat-badge--high {
            background: rgba(16, 185, 129, 0.16);
            color: #047857;
        }

        .compat-badge--medium {
            background: rgba(234, 179, 8, 0.18);
            color: #b45309;
        }

        .compat-badge--low {
            background: rgba(249, 115, 22, 0.16);
            color: #c2410c;
        }

        .compat-badge--none {
            background: rgba(148, 163, 184, 0.18);
            color: #475569;
        }

        .compat-badge--warning {
            background: rgba(239, 68, 68, 0.18);
            color: #b91c1c;
        }

        .ingredient-columns {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            margin: 18px 0;
        }

        .ingredient-columns h5 {
            margin: 0 0 8px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--color-muted);
        }

        .ingredient-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 8px;
        }

        .ingredient-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(15, 23, 42, 0.08);
            color: #111827;
        }

        .ingredient-chip--base {
            background: rgba(15, 23, 42, 0.08);
            color: #111827;
        }

        .ingredient-chip--new {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        .ingredient-chip--warning {
            background: rgba(239, 68, 68, 0.14);
            color: #b91c1c;
        }

        .labs-card {
            border-radius: 24px;
            padding: 28px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(168, 85, 247, 0.18);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        .labs-card h4 {
            margin: 12px 0 6px;
            font-size: 1.35rem;
            color: var(--color-dark);
        }

        .labs-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin: 16px 0 4px;
        }

        .labs-score strong {
            font-size: 2.4rem;
            color: var(--color-primary);
            line-height: 1;
        }

        .labs-score span {
            display: block;
            font-size: 0.85rem;
            color: var(--color-muted);
        }

        .labs-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-radius: 16px;
            background: rgba(124, 58, 237, 0.08);
            margin-top: 16px;
        }

        .labs-formula-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .labs-formula-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 18px;
            background: rgba(16, 185, 129, 0.12);
        }

        .labs-formula-list li span {
            display: block;
        }

        .labs-result-card {
            border-radius: 28px;
            background: #fff;
            border: 1px solid rgba(124, 58, 237, 0.12);
            padding: 28px;
            box-shadow: var(--shadow-soft);
        }

        .labs-result-header {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .labs-result-body {
            margin-top: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .labs-result-footer {
            margin-top: 20px;
        }

        .labs-result-stats {
            font-size: 0.9rem;
        }

        .labs-gauge {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: conic-gradient(var(--color-primary) calc(var(--gauge-value, 0) * 1%), rgba(15,23,42,0.08) 0);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--color-dark);
            font-weight: 700;
        }

        .labs-gauge span {
            font-size: 1.8rem;
        }

        .labs-gauge small {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .labs-base-chips {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .labs-base-chip {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .labs-base-chip--safe { background: #d9fbe3; color: #166534; }
        .labs-base-chip--warning { background: #fee2e2; color: #b91c1c; }
        .labs-base-chip--boost { background: #e0e7ff; color: #312e81; }

        .labs-substitutes {
            display: grid;
            gap: 12px;
        }

        .labs-substitute-card {
            background: #fff;
            border-radius: 18px;
            border: 1px solid rgba(124, 58, 237, 0.12);
            padding: 16px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        .labs-substitute-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .labs-substitute-percent {
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .labs-substitute-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .labs-substitute-tags span {
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(124, 58, 237, 0.12);
            color: var(--color-primary);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .labs-result-footer .cta-buy {
            margin-top: 12px;
        }

        .labs-impact-table {
            width: 100%;
            margin-top: 12px;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .labs-impact-table th,
        .labs-impact-table td {
            padding: 6px 4px;
            text-align: left;
        }

        .labs-replacements {
            margin-top: 20px;
            display: grid;
            gap: 12px;
        }

        .labs-replacement-card {
            border-radius: 18px;
            padding: 16px;
            border: 1px solid rgba(248, 113, 113, 0.4);
            background: #fff5f5;
        }

        .labs-replacement-card strong {
            display: block;
            margin-bottom: 4px;
        }

        .labs-replacement-card p {
            margin: 4px 0;
            font-size: 0.9rem;
        }

        .labs-pill {
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.85rem;
            background: rgba(16, 185, 129, 0.18);
            color: #047857;
        }

        .labs-highlights {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .labs-highlights span {
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(236, 72, 153, 0.12);
            font-size: 0.8rem;
            color: #9d174d;
            font-weight: 600;
        }

        .alternatives-shell {
            position: relative;
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            border-radius: 24px;
            padding: 28px;
            background: linear-gradient(135deg, rgba(29, 78, 216, 0.12), rgba(236, 72, 153, 0.08));
            overflow: hidden;
        }

        .alternatives-shell::before {
            content: '';
            position: absolute;
            top: -45%;
            right: -30%;
            width: 60%;
            height: 160%;
            background: radial-gradient(circle at center, rgba(124, 58, 237, 0.25), transparent 60%);
            transform: rotate(12deg);
        }

        .alternatives-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .lab-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(124, 58, 237, 0.18);
            color: var(--color-primary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-size: 0.78rem;
        }

        .alternatives-content h4 {
            margin: 0;
            font-size: 1.35rem;
            color: #0f172a;
        }

        .alternatives-visual {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mommy-bottle {
            position: relative;
            width: 160px;
            height: 250px;
            border-radius: 80px 80px 55px 55px;
            background: linear-gradient(160deg, #4c1d95 0%, #6366f1 55%, #22d3ee 100%);
            box-shadow: 0 24px 55px rgba(79, 70, 229, 0.38);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            text-align: center;
            padding: 0 20px;
        }

        .mommy-bottle::before {
            content: '';
            position: absolute;
            inset: 8px;
            border-radius: 72px 72px 48px 48px;
            border: 2px solid rgba(255, 255, 255, 0.22);
        }

        .mommy-bottle::after {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 32px;
            border-radius: 18px 18px 8px 8px;
            background: rgba(15, 23, 42, 0.9);
        }

        .mommy-emblem {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            font-size: 1.7rem;
            letter-spacing: 0.08em;
        }

        .mommy-emblem span {
            font-size: 0.82rem;
            font-weight: 500;
            letter-spacing: 0.1em;
        }

        .cta-zone {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .cta-buy {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 999px;
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--color-primary), #c084fc);
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-size: 0.95rem;
        }

        .cta-buy::after {
            content: 'â†’';
            margin-left: 10px;
            font-size: 1rem;
        }

        .cta-buy:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge.safe {
            background: rgba(16, 185, 129, 0.14);
            color: #047857;
        }

        .badge.warning {
            background: rgba(245, 158, 11, 0.16);
            color: #b45309;
        }

        .badge.danger {
            background: rgba(239, 68, 68, 0.16);
            color: #b91c1c;
        }

        .actions-card {
            display: grid;
            gap: 12px;
        }

        .actions-card button {
            width: 100%;
        }

        details.fold {
            border-radius: 16px;
            border: 1px solid rgba(168, 85, 247, 0.18);
            background: rgba(255,255,255,0.92);
            padding: 14px 18px;
        }

        details.fold summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--color-primary);
        }

        .insights-list {
            list-style: disc;
            padding-left: 22px;
            color: var(--color-muted);
        }

        .builder-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .builder-table th,
        .builder-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(168, 85, 247, 0.12);
        }

        .builder-table select {
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            padding: 8px;
        }

        .builder-summary {
            margin-top: 16px;
            background: rgba(168, 85, 247, 0.08);
            border-radius: 14px;
            padding: 14px 16px;
            color: var(--color-dark);
        }

        .builder-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
        }

        @media (max-width: 1024px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            .steps-pane {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            .app-shell {
                padding: 24px;
            }

            .builder-actions {
                flex-direction: column;
            }

            .steps-item {
                grid-template-columns: 32px 1fr;
                padding: 10px;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <nav class="site-nav">
        <div class="nav-inner">
            <div class="nav-logo">
                <span>Mommyshops Labs</span>
            </div>
            <div class="nav-links" aria-label="NavegaciÃ³n principal">
                <a href="#inicio">Inicio</a>
                <a href="#solucion">SoluciÃ³n</a>
                <a href="#laboratorio">Laboratorio</a>
                <a href="#planes">Planes</a>
                <a href="#recursos">Recursos</a>
            </div>
            <div class="nav-cta">
                <button class="btn btn-secondary" onclick="startMainFlow()">comienza ahora</button>
                <button class="btn btn-primary" onclick="openSignupModal()">inscribete ahora</button>
            </div>
        </div>
    </nav>

    <header class="site-hero" id="inicio">
        <div class="hero-inner">
            <div class="hero-copy">
                <p class="lab-badge">Clean beauty + IA</p>
                <h1>Crea tus propios productos de cuidado personal con el laboratorio MommyShops IA.</h1>
                <p>Analizamos etiquetas, reemplazamos riesgos y diseÃ±amos fÃ³rmulas Mommyshops Labs que evolucionan con tu familia.</p>
                <div class="nav-cta" style="margin-bottom:12px;">
                    <button class="btn btn-primary" onclick="openSignupModal()">inscribete ahora</button>
                    <button class="btn btn-secondary" onclick="startMainFlow()">comienza ahora</button>
                </div>
                <div class="hero-metrics">
                    <div class="metric-card">
                        <strong>+12K</strong>
                        <span>Ingredientes auditados</span>
                    </div>
                    <div class="metric-card">
                        <strong>99%</strong>
                        <span>Compatibilidad promedio</span>
                    </div>
                    <div class="metric-card">
                        <strong>5-7</strong>
                        <span>DÃ­as de entrega</span>
                    </div>
                </div>
            </div>
            <div class="hero-visual" aria-label="Laboratorio inteligente">
                <div id="heroLottie" aria-hidden="true" style="height:120px;margin-bottom:10px;"></div>
                <h3>Mommyshops Labs ðŸ§ª</h3>
                <ul>
                    <li>âœ”ï¸ AnÃ¡lisis inteligente de ingredientes (IA)</li>
                    <li>ðŸŒ¿ AnÃ¡lisis con estÃ¡ndares globales OMS/FDA/CIR, ICCR, SCCS</li>
                    <li>ðŸ¼ Personalizado para tus necesidades reales</li>
                    <li>ðŸ“¦ Producto hiper personalizados con inteligencia artificial</li>
                </ul>
            </div>
        </div>
    </header>

    <div class="trust-bar" id="solucion">
        <span>ConfÃ­an en Mommyshops Labs</span>
        <div class="trust-logos">
            <span>OMS Ready</span>
            <span>EcoCert</span>
            <span>FDA Safe</span>
            <span>Clean Beauty Alliance</span>
        </div>
    </div>

    <section class="site-section" id="laboratorio">
        <div class="journey-section">
            <div>
                <p class="lab-badge">Flujo guiado</p>
                <h2 style="font-size:2rem;margin-bottom:12px;">Del producto comercial, a un producto diseÃ±ado para ti</h2>
                <p style="color:var(--color-muted);">Cada bloque se ajusta a tu perfil (mamÃ¡, marca o laboratorio) con seguimiento en tiempo real.</p>
            </div>
            <div class="journey-grid">
                <div class="journey-card">
                    <span>01 â€¢ Perfil</span>
                    <strong>Contexto inteligente</strong>
                    <p>Tipo de piel, metas y restricciones mÃ©dicas.</p>
                </div>
                <div class="journey-card">
                    <span>02 â€¢ Escaneo</span>
                    <strong>OCR + IA</strong>
                    <p>Detecta riesgos, crea ingredientes y valida normativas.</p>
                </div>
                <div class="journey-card">
                    <span>03 â€¢ DiagnÃ³stico</span>
                    <strong>Compatibilidad personalizada</strong>
                    <p>Metrics, alertas y recomendaciones claras para cada necesidad.</p>
                </div>
                <div class="journey-card">
                    <span>04 â€¢ FÃ³rmula Mommyshops</span>
                    <strong>Blend listo para fabricar</strong>
                    <p>Ingredientes sustitutos, porcentajes y producto hiper personalizados con inteligencia artificial.</p>
                </div>
            </div>
        </div>
    </section>

    <div class="container" id="analizador">
        <div class="header">
            <div class="app-brand">
                <img src="/frontend/assets/mommyshops-logo.svg" alt="Mommyshops logo" class="brand-logo">
            </div>
            <h1 class="sr-only">MommyShops Cosmetic Ingredient Analyzer</h1>
            <p>Cosmetic Ingredient Analyzer & Safety Checker</p>
        </div>

        <div class="app-shell">
            <aside class="steps-pane" aria-label="Progreso de la experiencia">
                <h2>Tu recorrido</h2>
                <ol class="steps-list" id="journeySteps">
                    <li class="steps-item" data-step="1" data-target="profileCard">
                        <span class="step-index">1</span>
                        <div>
                            <div class="step-label">Perfil personalizado</div>
                            <div class="step-hint">Completa el cuestionario inicial</div>
                        </div>
                    </li>
                    <li class="steps-item" data-step="2" data-target="analysisEntry">
                        <span class="step-index">2</span>
                        <div>
                            <div class="step-label">Elige cÃ³mo analizar</div>
                            <div class="step-hint">Sube imagen o pega ingredientes</div>
                        </div>
                    </li>
                    <li class="steps-item" data-step="3" data-target="results">
                        <span class="step-index">3</span>
                        <div>
                            <div class="step-label">Escaneo inteligente</div>
                            <div class="step-hint">Mommyshops trabaja por ti</div>
                        </div>
                    </li>
                    <li class="steps-item" data-step="4" data-target="resultsContent">
                        <span class="step-index">4</span>
                        <div>
                            <div class="step-label">Resultados al instante</div>
                            <div class="step-hint">Revisa riesgos y fortalezas</div>
                        </div>
                    </li>
                    <li class="steps-item" data-step="5" data-target="labsFormulationMount">
                        <span class="step-index">5</span>
                        <div>
                            <div class="step-label">Formula personalizada</div>
                            <div class="step-hint">Elige sustitutos recomendados</div>
                        </div>
                    </li>
                    <li class="steps-item" data-step="6" data-target="builderMount">
                        <span class="step-index">6</span>
                        <div>
                            <div class="step-label">Compra segura</div>
                            <div class="step-hint">Solicita tu producto ideal</div>
                        </div>
                    </li>
                </ol>
            </aside>

        <div class="main-content">
            <div class="profile-card" id="profileCard">
                <div class="profile-header">
                    <div>
                        <span class="profile-pill" id="profilePill">Perfil incompleto</span>
                        <div class="profile-hero" id="profileHeroTitle">DiseÃ±emos tu perfil con IA</div>
                        <p id="profileSubtitle" class="profile-subtitle">CuÃ©ntanos sobre tu piel, rostro y cabello para recibir anÃ¡lisis y sustitutos hechos a tu medida.</p>
                    </div>
                    <div class="profile-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetProfile()">Restablecer</button>
                        <button type="button" class="btn btn-primary" onclick="openProfileWizard()">ðŸ’œ Actualizar mi cuidado</button>
                    </div>
                </div>
                <div class="profile-highlights" id="profileHighlights"></div>
                <p id="profileHint" class="muted" style="margin-top:12px;">Tu perfil nos ayuda a evaluar compatibilidad, riesgos y sustitutos especÃ­ficos.</p>
                <form id="profileForm" class="profile-form" onsubmit="saveProfile(event)">
                    <div class="profile-columns">
                        <div class="form-group">
                            <label for="skinType">Tipo de piel</label>
                            <select id="skinType" required>
                                <option value="">Selecciona una opciÃ³n</option>
                                <option value="seca">Seca</option>
                                <option value="grasa">Grasa</option>
                                <option value="mixta">Mixta</option>
                                <option value="sensitiva">Sensible</option>
                                <option value="normal">Normal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="hairType">Tipo de cabello</label>
                            <select id="hairType" required>
                                <option value="">Selecciona una opciÃ³n</option>
                                <option value="liso">Liso</option>
                                <option value="ondulado">Ondulado</option>
                                <option value="rizado">Rizado</option>
                                <option value="afro">Afro</option>
                                <option value="mixto">Mixto</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="faceShape">Zonas prioritarias del rostro</label>
                            <select id="faceShape" required>
                                <option value="">Selecciona una opciÃ³n</option>
                                <option value="Equilibrado en todo el rostro">Equilibrado en todo el rostro</option>
                                <option value="Zona T grasa y mejillas secas">Zona T grasa y mejillas secas</option>
                                <option value="Mejillas sensibles o rojizas">Mejillas sensibles o rojizas</option>
                                <option value="Tendencia a manchas en pÃ³mulos">Tendencia a manchas en pÃ³mulos</option>
                                <option value="Contorno de ojos delicado">Contorno de ojos delicado</option>
                                <option value="No estoy segura">No estoy segura</option>
                            </select>
                        </div>
                    </div>

                    <div class="profile-columns">
                        <div class="form-group">
                            <label>Preocupaciones de piel</label>
                            <div class="checkbox-group" id="skinConcernsGroup">
                                <label class="checkbox-pill"><input type="checkbox" value="sensibilidad" onchange="togglePill(this)">Sensibilidad</label>
                                <label class="checkbox-pill"><input type="checkbox" value="acnÃ©" onchange="togglePill(this)">AcnÃ©</label>
                                <label class="checkbox-pill"><input type="checkbox" value="manchas" onchange="togglePill(this)">Manchas</label>
                                <label class="checkbox-pill"><input type="checkbox" value="arrugas" onchange="togglePill(this)">Arrugas</label>
                                <label class="checkbox-pill"><input type="checkbox" value="deshidrataciÃ³n" onchange="togglePill(this)">DeshidrataciÃ³n</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Preocupaciones de cabello</label>
                            <div class="checkbox-group" id="hairConcernsGroup">
                                <label class="checkbox-pill"><input type="checkbox" value="frizz" onchange="togglePill(this)">Frizz</label>
                                <label class="checkbox-pill"><input type="checkbox" value="caÃ­da" onchange="togglePill(this)">CaÃ­da</label>
                                <label class="checkbox-pill"><input type="checkbox" value="resequedad" onchange="togglePill(this)">Resequedad</label>
                                <label class="checkbox-pill"><input type="checkbox" value="falta de brillo" onchange="togglePill(this)">Falta de brillo</label>
                                <label class="checkbox-pill"><input type="checkbox" value="caspa" onchange="togglePill(this)">Caspa</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Objetivos principales</label>
                            <div class="checkbox-group" id="overallGoalsGroup">
                                <label class="checkbox-pill"><input type="checkbox" value="una rutina limpia" onchange="togglePill(this)">Una rutina limpia</label>
                                <label class="checkbox-pill"><input type="checkbox" value="hidratar intensamente con vitaminas" onchange="togglePill(this)">HidrataciÃ³n intensiva</label>
                                <label class="checkbox-pill"><input type="checkbox" value="calmar inflamaciones activas" onchange="togglePill(this)">Calmar inflamaciones</label>
                                <label class="checkbox-pill"><input type="checkbox" value="regular el exceso de grasa" onchange="togglePill(this)">Control de grasa</label>
                                <label class="checkbox-pill"><input type="checkbox" value="sumar antioxidantes anti-edad" onchange="togglePill(this)">Antioxidantes anti-edad</label>
                            </div>
                        </div>
                    </div>

                    <div style="display:none;">
                        <button type="button">Cancelar</button>
                        <button type="submit">Guardar perfil</button>
                    </div>
                </form>
            </div>

            <div class="tabs" id="analysisEntry">
                <div class="tab active" onclick="switchTab('image', event)">ðŸ“¸ Image Analysis</div>
                <div class="tab" onclick="switchTab('text', event)">ðŸ“ Text Analysis</div>
            </div>

            <!-- Image Analysis Tab -->
            <div id="image-tab" class="tab-content active">
                <div class="upload-section">
                    <div class="upload-area">
                        <div class="upload-icon">ðŸ“·</div>
                        <h3>Upload Product Image</h3>
                        <p>Take a photo or upload an image of your cosmetic product's ingredient list</p>
                        <input type="file" id="imageInput" class="file-input" accept="image/jpeg,image/png,image/webp,image/jpg">
                        <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                            Choose Image
                        </button>
                        <div id="imagePreview"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="productName">Nombre del producto</label>
                    <input type="text" id="productName" placeholder="Ingresa el nombre del producto (opcional)">
                </div>

                <div class="form-group">
                    <label for="userNeed">Tipo de producto</label>
                    <select id="userNeed">
                        <option value="">Selecciona el tipo de producto</option>
                        <option value="hair">Pelo</option>
                        <option value="face">Cara</option>
                        <option value="body">Cuerpo</option>
                    </select>
                </div>

                <button class="analyze-btn" onclick="analyzeImage()">
                    ðŸ” Analyze Product
                </button>
            </div>

            <!-- Text Analysis Tab -->
            <div id="text-tab" class="tab-content">
                <div class="form-group">
                    <label for="ingredientText">Ingredient List</label>
                    <textarea id="ingredientText" rows="6" placeholder="Paste your ingredient list here...&#10;Example:&#10;AQUA, GLYCERIN, DIMETHICONE, CYCLOPENTASILOXANE, BUTYLENE GLYCOL, SODIUM HYALURONATE, PHENOXYETHANOL, METHYLPARABEN, PROPYLPARABEN, FRAGRANCE"></textarea>
                </div>

                <div class="form-group">
                    <label for="textProductName">Nombre del producto</label>
                    <input type="text" id="textProductName" placeholder="Ingresa el nombre del producto (opcional)">
                </div>

                <div class="form-group">
                    <label for="textUserNeed">Tipo de producto</label>
                    <select id="textUserNeed">
                        <option value="">Selecciona el tipo de producto</option>
                        <option value="hair">Pelo</option>
                        <option value="face">Cara</option>
                        <option value="body">Cuerpo</option>
                    </select>
                </div>

                <button class="analyze-btn" onclick="analyzeText()">
                    ðŸ” Analyze Ingredients
                </button>
            </div>

            <!-- Results Section -->
            <div id="results" class="results-section">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Analyzing your product... This may take a few seconds.</p>
                </div>

                <div id="resultsContent" style="display: none;">
                    <!-- Results will be populated here -->
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API base URL - detect environment and use appropriate endpoint
        const API_BASE = (() => {
            if (typeof window === 'undefined') return 'http://localhost:8000';
            const hostname = window.location.hostname;
            // Development - use localhost directly
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:8000';
            }
            // Production - use relative /api path which Vercel rewrites to ngrok
            // This works for both vercel.app domains and custom domains
            return '/api';
        })();
        const PROFILE_STORAGE_KEY = 'mommyshopsProfile';
        let journeyStepItems = [];
        const PRODUCT_TYPE_CONTEXT = {
            hair: { label: 'Pelo', context: 'tu cuidado capilar' },
            face: { label: 'Cara', context: 'tu cuidado facial' },
            body: { label: 'Cuerpo', context: 'tu cuidado corporal' }
        };
        let currentProductTypeKey = null;
        let journeySections = [];
        let journeyScrollScheduled = false;
        let journeyScrollBound = false;
        let labsFormulationState = {
            controller: null,
            lastPayloadKey: null,
            lastResult: null
        };
        const defaultProfileData = () => ({
            skin_type: null,
            hair_type: null,
            face_shape: null,
            skin_concerns: [],
            hair_concerns: [],
            overall_goals: []
        });
        let profileWizardState = {
            step: 1,
            data: defaultProfileData()
        };

        function startMainFlow() {
            const analyzerSection = document.getElementById('analizador');
            if (analyzerSection) {
                analyzerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            const imageInput = document.getElementById('imageInput');
            if (imageInput) {
                setTimeout(() => imageInput.focus(), 200);
            }
        }

        function scrollToLabsResult() {
            const labs = document.getElementById('labsFormulationMount');
            if (labs) {
                labs.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function setCurrentProductType(key) {
            currentProductTypeKey = key || null;
        }

        function updateProductTypeFromSelect(selectEl) {
            if (!selectEl) return;
            const value = selectEl.value || '';
            setCurrentProductType(value || null);
        }

        function getCurrentProductTypeInfo() {
            if (!currentProductTypeKey) return null;
            return PRODUCT_TYPE_CONTEXT[currentProductTypeKey] || null;
        }

        function getCurrentProductTypeLabel() {
            const info = getCurrentProductTypeInfo();
            return info ? info.label : null;
        }

        function getCurrentProductTypeContext() {
            const info = getCurrentProductTypeInfo();
            return info ? info.context : null;
        }

        function applyProductTypeContext(description) {
            const info = getCurrentProductTypeInfo();
            if (!info) {
                return description;
            }
            const baseText = (description || '').trim();
            const labelLower = info.label.toLowerCase();
            if (baseText.toLowerCase().includes(labelLower)) {
                return baseText;
            }
            const contextText = info.context || `tu cuidado de ${labelLower}`;
            if (!baseText) {
                return `Enfocado en ${contextText}.`;
            }
            const hasEndingPeriod = /[.!?]$/.test(baseText);
            return hasEndingPeriod
                ? `${baseText} Enfocado en ${contextText}.`
                : `${baseText}. Enfocado en ${contextText}.`;
        }

        function openSignupModal() {
            const modal = document.getElementById('signupModal');
            if (!modal) return;
            modal.classList.add('is-visible');
            modal.setAttribute('aria-hidden', 'false');
            const firstInput = modal.querySelector('input, select');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 0);
            }
        }

        function closeSignupModal() {
            const modal = document.getElementById('signupModal');
            if (!modal) return;
            modal.classList.remove('is-visible');
            modal.setAttribute('aria-hidden', 'true');
        }

        function setupProductTypeListeners() {
            ['userNeed', 'textUserNeed'].forEach(id => {
                const selectEl = document.getElementById(id);
                if (!selectEl) return;
                selectEl.addEventListener('change', () => updateProductTypeFromSelect(selectEl));
                if (selectEl.value) {
                    setCurrentProductType(selectEl.value);
                }
            });
        }

        function collapseAssistPanel() {
            const assist = document.getElementById('assistPanel');
            if (!assist) return;
            assist.removeAttribute('open');
            localStorage.setItem('assist_open_state', 'false');
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeSignupModal();
                closeProfileWizard();
            }
        });

        document.addEventListener('click', (event) => {
            const modal = document.getElementById('signupModal');
            if (modal && event.target === modal) {
                closeSignupModal();
            }
            const wizard = document.getElementById('profileWizard');
            if (wizard && event.target === wizard) {
                closeProfileWizard();
            }
        });

        function setupSignupForm() {
            const form = document.getElementById('signupForm');
            if (!form || form.dataset.bound === 'true') {
                return;
            }
            form.dataset.bound = 'true';
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                const formData = new FormData(form);
                const firstName = formData.get('firstName') || 'creador/a';
                closeSignupModal();
                alert(`Gracias ${firstName}! Nuestro equipo Mommyshops se pondrÃ¡ en contacto muy pronto.`);
                form.reset();
            });
        }

        const GOAL_KEYWORDS = {
            'hidratar intensamente con vitaminas': ['hidrat', 'humect', 'moist', 'hialuron', 'glicer', 'panthenol'],
            'calmar inflamaciones activas': ['antiinflam', 'calm', 'soothe', 'aloe', 'bisabolol', 'centella', 'oat'],
            'sumar antioxidantes anti-edad': ['antiage', 'antiedad', 'retino', 'peptid', 'colagen', 'resveratrol', 'firm'],
            'una rutina limpia': ['suave', 'gentle', 'botan', 'natural', 'veg', 'clean', 'sin fragancia'],
            'regular el exceso de grasa': ['sebo', 'oil control', 'seboreg', 'matific', 'purific', 'salic', 'bha', 'niacinamide']
        };

        const GOAL_MESSAGES = {
            'hidratar intensamente con vitaminas': 'hidratar intensamente con vitaminas',
            'calmar inflamaciones activas': 'calmar inflamaciones activas',
            'sumar antioxidantes anti-edad': 'sumar antioxidantes anti-edad',
            'una rutina limpia': 'una rutina limpia',
            'regular el exceso de grasa': 'regular el exceso de grasa'
        };

        const SKIN_TYPE_SUPPORT_KEYWORDS = {
            'seca': ['hidrat', 'humect', 'nutre', 'manteca', 'aceite', 'ceramida', 'hialuron'],
            'grasa': ['sebo', 'oil control', 'matific', 'seboreg', 'purificante', 'salic', 'bha', 'niacinamide'],
            'mixta': ['balance', 'equilibr', 'zona t', 'matific', 'hidrat'],
            'sensible': ['calm', 'suav', 'sin fragancia', 'hipoalergen', 'manzanilla', 'bisabolol', 'centella', 'aloe'],
            'normal': ['balance', 'mantener', 'protege barrera']
        };

        const SKIN_TYPE_RISK_KEYWORDS = {
            'seca': ['alcohol denat', 'sulfato', 'detergente', 'astring', 'reseca'],
            'grasa': ['comedog', 'aceite mineral', 'isopropyl', 'oclusiv'],
            'mixta': ['pesado', 'graso', 'oclusiv', 'reseca mejillas'],
            'sensible': ['fragancia', 'parfum', 'irrit', 'sensibiliz', 'Ã¡cido fuerte'],
            'normal': ['desbalance', 'irrit']
        };

        const SKIN_TYPE_SUPPORT_LABELS = {
            'seca': 'hidratar tu piel seca',
            'grasa': 'regular la grasa',
            'mixta': 'equilibrar tu piel mixta',
            'sensible': 'proteger tu piel sensible',
            'normal': 'mantener tu piel equilibrada'
        };

        const SKIN_TYPE_RISK_LABELS = {
            'seca': 'podrÃ­a resecar tu piel seca',
            'grasa': 'podrÃ­a obstruir poros en piel grasa',
            'mixta': 'podrÃ­a desbalancear la zona T y mejillas',
            'sensible': 'podrÃ­a irritar tu piel sensible',
            'normal': 'podrÃ­a desbalancear tu piel'
        };

        const HAIR_TYPE_SUPPORT_KEYWORDS = {
            'liso': ['ligero', 'volumen', 'anti-frizz ligero', 'brillo'],
            'ondulado': ['definiciÃ³n', 'hidrat', 'leave-in', 'anti-frizz'],
            'rizado': ['definiciÃ³n', 'curl', 'manteca', 'humect', 'aceite nutritivo'],
            'afro': ['nutre', 'sellar humedad', 'deep conditioning', 'butter', 'aceite'],
            'mixto': ['equilibr', 'ligero', 'hidrat']
        };

        const HAIR_TYPE_RISK_KEYWORDS = {
            'liso': ['pesado', 'residuo', 'graso', 'pegajoso'],
            'ondulado': ['reseca', 'rigido', 'rompe onda'],
            'rizado': ['reseca', 'encrespamiento', 'build up'],
            'afro': ['reseca', 'romper hebra', 'sulfato fuerte'],
            'mixto': ['desequilibrio', 'reseca puntas', 'grasa en raÃ­z']
        };

        const HAIR_TYPE_SUPPORT_LABELS = {
            'liso': 'mantener tu cabello liso ligero',
            'ondulado': 'definir ondas suaves',
            'rizado': 'nutrir y definir rizos',
            'afro': 'proteger y sellar rizos afro',
            'mixto': 'equilibrar raÃ­ces y puntas'
        };

        const HAIR_TYPE_RISK_LABELS = {
            'liso': 'puede sobrecargar tu cabello liso',
            'ondulado': 'puede resecar tus ondas',
            'rizado': 'puede resecar tus rizos',
            'afro': 'puede quebrar tus rizos afro',
            'mixto': 'puede desequilibrar raÃ­ces y puntas'
        };

        const FACE_ZONE_SUPPORT_KEYWORDS = {
            'equilibrado en todo el rostro': ['balance', 'proteger', 'barrera'],
            'zona t grasa y mejillas secas': ['zona t', 'balance', 'matific', 'hidrat mejillas', 'multimasking'],
            'mejillas sensibles o rojizas': ['calm mejilla', 'antirrojeces', 'antiinflam', 'niacinamide', 'bisabolol'],
            'tendencia a manchas en pÃ³mulos': ['antimanch', 'vitamina c', 'despigment', 'niacinamide'],
            'contorno de ojos delicado': ['contorno', 'ojos', 'oftalmolÃ³gicamente', 'suave'],
            'no estoy segura': []
        };

        const FACE_ZONE_RISK_KEYWORDS = {
            'equilibrado en todo el rostro': ['desbalance', 'irrit'],
            'zona t grasa y mejillas secas': ['oclusivo', 'reseca', 'pesado'],
            'mejillas sensibles o rojizas': ['irrita mejilla', 'perfume', 'alcohol'],
            'tendencia a manchas en pÃ³mulos': ['fotosens', 'mancha', 'oscurecer'],
            'contorno de ojos delicado': ['no apto ojos', 'irrita ojos', 'fragancia'],
            'no estoy segura': []
        };

        const FACE_ZONE_SUPPORT_LABELS = {
            'equilibrado en todo el rostro': 'mantener tu rostro equilibrado',
            'zona t grasa y mejillas secas': 'balancear zona T y mejillas',
            'mejillas sensibles o rojizas': 'calmar tus mejillas sensibles',
            'tendencia a manchas en pÃ³mulos': 'tratar manchas en pÃ³mulos',
            'contorno de ojos delicado': 'cuidar el contorno de ojos delicado',
            'no estoy segura': 'cuidar tu rostro'
        };

        const FACE_ZONE_RISK_LABELS = {
            'equilibrado en todo el rostro': 'puede desbalancear tu rostro',
            'zona t grasa y mejillas secas': 'puede desbalancear zona T y mejillas',
            'mejillas sensibles o rojizas': 'puede irritar tus mejillas sensibles',
            'tendencia a manchas en pÃ³mulos': 'puede acentuar las manchas en pÃ³mulos',
            'contorno de ojos delicado': 'puede irritar el contorno de ojos',
            'no estoy segura': 'puede no adaptarse a tu rostro'
        };

        const INGREDIENT_RULES_BASE = {
            'avena sativa': {
                aliases: ['oat', 'beta-glucan', 'avenasativa'],
                supports: [
                    { type: 'skin_concern', key: 'sensibilidad', label: 'calmar tu sensibilidad' },
                    { type: 'goal', key: 'calmar inflamaciones activas', label: 'calmar inflamaciones activas' },
                    { type: 'skin_type', key: 'sensible', label: 'proteger tu piel sensible' },
                    { type: 'goal', key: 'una rutina limpia', label: 'mantener tu rutina limpia con activos suaves' }
                ],
                summary: 'Calma e hidrata la piel sensible con avenantramidas.'
            },
            'camellia sinensis': {
                aliases: ['green tea', 'matcha', 'tea leaf'],
                supports: [
                    { type: 'goal', key: 'calmar inflamaciones activas', label: 'aportar antioxidantes antiinflamatorios' },
                    { type: 'goal', key: 'regular el exceso de grasa', label: 'regular el exceso de grasa' },
                    { type: 'skin_type', key: 'grasa', label: 'equilibrar la producciÃ³n de sebo' },
                    { type: 'skin_concern', key: 'acnÃ©', label: 'apoyar piel con brotes' }
                ],
                summary: 'Controla el sebo y aporta antioxidantes potentes.'
            },
            'rosmarinus officinalis': {
                aliases: ['rosemary'],
                supports: [
                    { type: 'hair_concern', key: 'frizz', label: 'controlar el frizz y sellar cutÃ­cula' },
                    { type: 'hair_concern', key: 'falta de brillo', label: 'estimular el brillo natural' },
                    { type: 'goal', key: 'una rutina limpia', label: 'mantener una sensaciÃ³n herbal fresca' }
                ],
                summary: 'Estimula el cuero cabelludo y reduce el frizz.'
            },
            'serenoa repens': {
                aliases: ['saw palmetto'],
                supports: [
                    { type: 'goal', key: 'regular el exceso de grasa', label: 'equilibrar el sebo de piel y cuero cabelludo' },
                    { type: 'hair_concern', key: 'caÃ­da', label: 'fortalecer la fibra para reducir la caÃ­da' }
                ],
                summary: 'Regula la producciÃ³n de sebo y cuida la raÃ­z capilar.'
            },
            'linum usitatissimum': {
                aliases: ['linseed', 'flax', 'flaxseed'],
                supports: [
                    { type: 'hair_concern', key: 'resequedad', label: 'nutrir la resequedad extrema' },
                    { type: 'goal', key: 'hidratar intensamente con vitaminas', label: 'sellar hidrataciÃ³n duradera' },
                    { type: 'hair_type', key: 'rizado', label: 'definir tus rizos con humectaciÃ³n' },
                    { type: 'hair_concern', key: 'frizz', label: 'disminuir el frizz' }
                ],
                summary: 'Aporta mucÃ­lagos que definen rizos y sellan hidrataciÃ³n.'
            },
            'ginkgo biloba': {
                aliases: ['ginkgo'],
                supports: [
                    { type: 'goal', key: 'sumar antioxidantes anti-edad', label: 'sumar antioxidantes anti-edad' },
                    { type: 'skin_concern', key: 'arrugas', label: 'suavizar la apariciÃ³n de arrugas' },
                    { type: 'hair_concern', key: 'caÃ­da', label: 'estimular la microcirculaciÃ³n' }
                ],
                summary: 'Estimula la microcirculaciÃ³n y protege frente a radicales libres.'
            },
            'tropaeolum majus': {
                aliases: ['nasturtium'],
                supports: [
                    { type: 'hair_concern', key: 'caÃ­da', label: 'estimular el crecimiento del cabello' },
                    { type: 'hair_concern', key: 'falta de brillo', label: 'potenciar el brillo natural' }
                ],
                summary: 'Oxigena la fibra capilar y devuelve luminosidad.'
            },
            'guazuma ulmifolia': {
                aliases: ['guazuma'],
                supports: [
                    { type: 'hair_concern', key: 'frizz', label: 'suavizar el encrespamiento' },
                    { type: 'hair_concern', key: 'resequedad', label: 'aportar elasticidad a cabellos resecos' }
                ],
                summary: 'Reestructura la fibra y controla el frizz rebelde.'
            },
            'bactris gasipaes': {
                aliases: ['peach palm', 'pejibaye'],
                supports: [
                    { type: 'goal', key: 'hidratar intensamente con vitaminas', label: 'hidratar intensamente con vitaminas' },
                    { type: 'hair_concern', key: 'resequedad', label: 'nutrir tu cabello reseco' },
                    { type: 'skin_concern', key: 'deshidrataciÃ³n', label: 'apoyar la hidrataciÃ³n de la piel' }
                ],
                summary: 'Rico en lÃ­pidos y antioxidantes para hidrataciÃ³n profunda.'
            },
            'sucuribuba': {
                aliases: ['sucuribuba bark'],
                supports: [
                    { type: 'skin_concern', key: 'sensibilidad', label: 'calmar piel reactiva' },
                    { type: 'goal', key: 'calmar inflamaciones activas', label: 'aportar efecto reparador' }
                ],
                summary: 'Extracto calmante con perfil antioxidante.'
            }
        };

        const INGREDIENT_SYNONYMS = {
            'green tea': 'camellia sinensis',
            'matcha': 'camellia sinensis',
            'tea leaf': 'camellia sinensis',
            'beta glucan': 'avena sativa',
            'oat': 'avena sativa',
            'oatmeal': 'avena sativa',
            'flaxseed': 'linum usitatissimum',
            'linseed': 'linum usitatissimum',
            'flax': 'linum usitatissimum',
            'peach palm': 'bactris gasipaes',
            'saw palmetto': 'serenoa repens',
            'rosemary': 'rosmarinus officinalis',
            'nasturtium': 'tropaeolum majus',
            'sucuribuba bark': 'sucuribuba'
        };

        const FUNCTION_KEYWORDS_BASE = {
            hydration: ['hydr', 'moist', 'humect', 'hyaluron', 'glicer', 'panthenol', 'linseed', 'flax', 'bactris'],
            soothing: ['calm', 'sooth', 'oat', 'aloe', 'centella', 'bisabolol', 'chamomile', 'sucuribuba'],
            sebum: ['seboreg', 'sebum', 'purific', 'salic', 'tea tree', 'camellia', 'niacinamide'],
            antiage: ['retin', 'peptid', 'collagen', 'resveratrol', 'ginkgo', 'bakuchiol', 'vitamin c'],
            frizz: ['frizz', 'smooth', 'guazuma', 'linseed'],
            strengthening: ['fortalec', 'keratin', 'protein', 'tropaeolum', 'biotin', 'serenoa'],
            detox: ['detox', 'charcoal', 'clay', 'willow', 'purific'],
            shine: ['shine', 'gloss', 'lustre', 'tropaeolum'],
            barrier: ['ceramide', 'beta-glucan', 'panthenol', 'oat'],
            botanical: ['extract', 'leaf', 'flower', 'root', 'seed', 'fruit', 'bark']
        };

        const FUNCTION_CATEGORY_MAP_BASE = {
            hydration: [
                { type: 'goal', key: 'hidrataciÃ³n profunda', label: 'proveer hidrataciÃ³n profunda' },
                { type: 'skin_concern', key: 'deshidrataciÃ³n', label: 'combatir la deshidrataciÃ³n' },
                { type: 'hair_concern', key: 'resequedad', label: 'nutrir el cabello reseco' }
            ],
            soothing: [
                { type: 'goal', key: 'calmar inflamaciones activas', label: 'calmar inflamaciones' },
                { type: 'skin_concern', key: 'sensibilidad', label: 'reducir la sensibilidad' }
            ],
            sebum: [
                { type: 'goal', key: 'regular el exceso de grasa', label: 'controlar el exceso de grasa' },
                { type: 'skin_type', key: 'grasa', label: 'equilibrar piel grasa' },
                { type: 'skin_concern', key: 'acnÃ©', label: 'apoyar piel con acnÃ©' }
            ],
            antiage: [
                { type: 'goal', key: 'sumar antioxidantes anti-edad', label: 'reforzar efectos anti-edad' },
                { type: 'skin_concern', key: 'arrugas', label: 'suavizar arrugas' }
            ],
            frizz: [
                { type: 'hair_concern', key: 'frizz', label: 'controlar el frizz' },
                { type: 'hair_type', key: 'rizado', label: 'definir rizos' }
            ],
            strengthening: [
                { type: 'hair_concern', key: 'caÃ­da', label: 'fortalecer la fibra capilar' }
            ],
            detox: [
                { type: 'goal', key: 'una rutina limpia', label: 'refrescar tu rutina limpia' },
                { type: 'skin_concern', key: 'acnÃ©', label: 'purificar la piel propensa a brotes' }
            ],
            shine: [
                { type: 'hair_concern', key: 'falta de brillo', label: 'aumentar el brillo natural' }
            ],
            barrier: [
                { type: 'skin_concern', key: 'sensibilidad', label: 'reforzar la barrera cutÃ¡nea' }
            ],
            botanical: [
                { type: 'goal', key: 'una rutina limpia', label: 'aportar activos botÃ¡nicos suaves' }
            ]
        };

        const FUNCTION_SUMMARY_BASE = {
            hydration: 'Aporta hidrataciÃ³n sostenida y confort duradero.',
            soothing: 'Calma irritaciones y ayuda a reparar la barrera.',
            sebum: 'Ayuda a controlar el sebo y prevenir brotes.',
            antiage: 'Refuerza la protecciÃ³n antioxidante y anti-edad.',
            frizz: 'Controla el frizz y mantiene los rizos definidos.',
            strengthening: 'Fortalece el folÃ­culo y disminuye la caÃ­da.',
            detox: 'Purifica e impulsa tu rutina limpia.',
            shine: 'Devuelve luminosidad sin dejar residuos.',
            barrier: 'Protege y repara la barrera cutÃ¡nea.',
            botanical: 'Extracto botÃ¡nico con perfil amable para rutinas limpias.'
        };

        const LEARNED_RULES_KEY = 'mommy_learned_rules_v1';

        const SKIN_CONCERN_SUPPORT_KEYWORDS = {
            'sensibilidad': ['calm', 'suav', 'hipoalergen', 'manzanilla', 'aloe', 'oat', 'centella'],
            'acnÃ©': ['acne', 'antibacter', 'purific', 'salic', 'bha', 'azelaic', 'niacinamide'],
            'manchas': ['mancha', 'ilumin', 'brighten', 'vitamina c', 'niacinamide'],
            'arrugas': ['antiage', 'colagen', 'peptid', 'firm', 'retino'],
            'deshidrataciÃ³n': ['hidrat', 'humect', 'moist', 'glicer', 'hialuron']
        };

        const SKIN_CONCERN_RISK_KEYWORDS = {
            'sensibilidad': ['irrit', 'fragancia', 'parfum', 'sulfat', 'alcohol denat'],
            'acnÃ©': ['comedog', 'oclusiv', 'aceite mineral', 'isopropyl', 'myristate'],
            'manchas': ['photosens', 'foto sensibil', 'hidroquin', 'acido retinoico'],
            'arrugas': [],
            'deshidrataciÃ³n': ['deshidrat', 'astringent', 'alcohol']
        };

        const HAIR_CONCERN_SUPPORT_KEYWORDS = {
            'frizz': ['frizz', 'alis', 'control de frizz', 'anti frizz'],
            'caÃ­da': ['fortalec', 'densidad', 'biotin', 'crecimiento', 'hair loss'],
            'resequedad': ['nutre', 'hidrat', 'aceite', 'manteca', 'humect'],
            'falta de brillo': ['brillo', 'shine', 'lustre', 'gloss'],
            'caspa': ['anticaspa', 'dandruff', 'piroctona', 'zinc', 'scalp balance']
        };

        const HAIR_CONCERN_RISK_KEYWORDS = {
            'frizz': ['seca', 'deshidrata'],
            'caÃ­da': ['debilita', 'rompe'],
            'resequedad': ['reseca', 'deshidrata'],
            'falta de brillo': ['opaca'],
            'caspa': ['irrita cuero cabelludo', 'detergente']
        };

        const FACE_ZONE_LABELS = {
            'Equilibrado en todo el rostro': 'Equilibrado en todo el rostro',
            'Zona T grasa y mejillas secas': 'Zona T grasa y mejillas secas',
            'Mejillas sensibles o rojizas': 'Mejillas sensibles o rojizas',
            'Tendencia a manchas en pÃ³mulos': 'Tendencia a manchas en pÃ³mulos',
            'Contorno de ojos delicado': 'Contorno de ojos delicado',
            'No estoy segura': 'No estoy segura'
        };

        function normalizeText(value) {
            return (value || '')
                .toString()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');
        }

        function matchesKeywords(text, keywords) {
            if (!text || !keywords || !keywords.length) return false;
            const normalized = normalizeText(text);
            return keywords.some(keyword => normalized.includes(normalizeText(keyword)));
        }

        function formatList(items) {
            if (!items || !items.length) return '';
            if (items.length === 1) return items[0];
            if (items.length === 2) return `${items[0]} y ${items[1]}`;
            const head = items.slice(0, -1).join(', ');
            return `${head} y ${items[items.length - 1]}`;
        }

        function getFaceZoneLabel(value) {
            return FACE_ZONE_LABELS[value] || value;
        }

        function hasValue(list, value) {
            if (!list) return false;
            const target = normalizeText(value);
            return list.some(item => normalizeText(item) === target);
        }

        function matchesProfileValue(value, target) {
            return normalizeText(value) === normalizeText(target);
        }

        function titleCase(text) {
            return (text || '')
                .toLowerCase()
                .split(' ')
                .map(word => word ? word.charAt(0).toUpperCase() + word.slice(1) : '')
                .join(' ');
        }

        function addEntry(map, type, key, label) {
            if (!label) return;
            const normalizedKey = `${type}:${(key || label).toString().toLowerCase()}`;
            if (!map.has(normalizedKey)) {
                map.set(normalizedKey, { type, key, label });
            }
        }

        function entriesToArray(map) {
            return Array.from(map.values());
        }

        function uniqueLabels(entries) {
            const seen = new Set();
            const result = [];
            entries.forEach(entry => {
                const label = entry.label;
                if (!label) return;
                const key = label.toLowerCase();
                if (!seen.has(key)) {
                    seen.add(key);
                    result.push(label);
                }
            });
            return result;
        }

        function uniqueStrings(list) {
            const seen = new Set();
            const ordered = [];
            (list || []).forEach(item => {
                if (item == null) return;
                const label = item.toString().trim();
                if (!label) return;
                const key = label.toLowerCase();
                if (!seen.has(key)) {
                    seen.add(key);
                    ordered.push(label);
                }
            });
            return ordered;
        }

        function scoreToPercent(value) {
            if (value == null) return null;
            const num = Number(value);
            if (!Number.isFinite(num)) return null;
            if (Math.abs(num) <= 1) {
                return Math.round(num * 100);
            }
            return Math.round(num);
        }

        function normalizeEvaluatedIngredients(list) {
            if (!Array.isArray(list)) {
                return [];
            }
            return list.map(item => {
                const name = item.inci || item.name || item.ingredient || '';
                const description = item.comment || item.description || item.analysis || '';
                return {
                    ...item,
                    ingredient: name || item.ingredient,
                    name: name || item.name || item.ingredient,
                    analysis: description,
                    description,
                    ewg_score: item.ewg_score ?? item.ewg ?? item.ewg_index,
                    eco_score: item.eco_score ?? item.eco ?? item.eco_index,
                    risk: item.state === 'conflict' || (Array.isArray(item.risk_flags) && item.risk_flags.length) ? 'high' : (item.state === 'neutral' ? 'moderate' : 'low'),
                    safety_level: item.state === 'conflict' ? 'caution' : 'safe'
                };
            });
        }

        function extractBaseIngredientNamesFromFormula(formula) {
            if (!formula || !Array.isArray(formula.base_ingredients)) {
                return [];
            }
            return formula.base_ingredients
                .map(item => item.inci || item.name || item.ingredient || '')
                .filter(Boolean);
        }

        function buildReplacementReason(to) {
            if (!to) return 'Alternativa recomendada';
            const parts = [];
            if (Array.isArray(to.benefits) && to.benefits.length) {
                parts.push(to.benefits.slice(0, 3).join(', '));
            }
            if (Array.isArray(to.safe_for) && to.safe_for.length) {
                parts.push(`Seguro para ${to.safe_for.join(', ')}`);
            }
            const deltaSource = to.delta_global ?? to.delta_compatibility;
            const delta = scoreToPercent(deltaSource);
            if (delta != null && delta !== 0) {
                parts.push(`${delta > 0 ? '+' : ''}${delta}% compatibilidad`);
            }
            return parts.length ? parts.join(' Â· ') : (to.reason || 'Alternativa recomendada');
        }

        function buildRecommendedReason(substitute) {
            if (!substitute) {
                return 'Sugerencia Mommyshops';
            }
            const tags = Array.isArray(substitute.tags) ? substitute.tags.slice(0, 3).join(', ') : '';
            if (tags) return tags;
            const delta = scoreToPercent(substitute.compatibility_delta);
            if (delta != null) {
                return `Î” compatibilidad ${delta}%`;
            }
            return 'Sugerencia Mommyshops';
        }

        function renderIngredientFilterButton(status, label, count, isActive) {
            return `<button type="button" class="ingredient-filter-btn ${isActive ? 'is-active' : ''}" data-ingredient-filter="${status}" onclick="filterIngredientCards('${status}')">${escapeHtml(label)} (${count})</button>`;
        }

        function getBenefitBadgeClass(label) {
            if (!label) return 'benefit-badge benefit-badge--default';
            const text = label.toLowerCase();
            if (text.includes('rutina') || text.includes('limpia')) return 'benefit-badge benefit-badge--clean';
            if (text.includes('hidrat')) return 'benefit-badge benefit-badge--hydrate';
            if (text.includes('calm') || text.includes('sensible')) return 'benefit-badge benefit-badge--calm';
            if (text.includes('sebo') || text.includes('balance') || text.includes('grasa')) return 'benefit-badge benefit-badge--balance';
            if (text.includes('antiox') || text.includes('vitamin')) return 'benefit-badge benefit-badge--antiox';
            return 'benefit-badge benefit-badge--default';
        }

        function buildBenefitBadges(evaluation) {
            if (!evaluation) return '';
            const supports = evaluation.supports || [];
            const labels = supports.map(entry => entry.label || entry).filter(Boolean);
            const unique = uniqueLabels(labels.map(label => ({ label }))).slice(0, 4);
            const badges = unique.length ? unique : (evaluation.summary ? [evaluation.summary] : []);
            if (!badges.length) {
                return '<span class="benefit-badge benefit-badge--default">Sin datos especÃ­ficos</span>';
            }
            const extra = Math.max(0, labels.length - unique.length);
            const chips = badges.map(label => `<span class="${getBenefitBadgeClass(label)}">${escapeHtml(label)}</span>`);
            if (extra > 0) {
                chips.push(`<span class="benefit-badge benefit-badge--default">+${extra} beneficios</span>`);
            }
            return chips.join('');
        }

        function renderIngredientCard(item, profile) {
            const evaluation = computeIngredientUtility(item, profile);
            const badges = buildBenefitBadges(evaluation);
            const compat = determineIngredientCompatibility(item, evaluation);
            let statusIcon = 'ðŸŒ¿';
            if (compat.level === 'medium') statusIcon = 'ðŸŸ¡';
            if (compat.level === 'neutral') statusIcon = 'âšª';
            if (compat.level === 'low') statusIcon = 'âš ï¸';
            const ewgValue = item.ewg_score ?? item.ewg ?? item.ewg_index;
            const ecoValue = item.eco_score ?? item.eco ?? item.eco_index;
            const metaParts = [];
            if (ewgValue != null && ewgValue !== '') {
                metaParts.push(`EWG ${ewgValue}/10`);
            }
            if (ecoValue != null && ecoValue !== '') {
                metaParts.push(`Eco ${ecoValue}/100`);
            }
            const meta = metaParts.length ? metaParts.join(' Â· ') : 'Sin Ã­ndices de referencia';
            const baseDescription = item.comment || item.analysis || evaluation.summary || 'Sin descripciÃ³n personalizada.';
            const description = applyProductTypeContext(baseDescription);
            const datasetStatus = item.status || item.state || 'safe';
            const title = item.inci || item.ingredient || item.name || '-';
            return `
                <article class="ingredient-card" data-status="${datasetStatus}" data-level="${compat.level}">
                    <h4>${statusIcon} ${escapeHtml(title)}</h4>
                    <div class="ingredient-meta">${escapeHtml(meta)}</div>
                    <p class="muted" style="font-weight:600;">${escapeHtml(compat.label)}</p>
                    <p class="ingredient-description">${escapeHtml(description)}</p>
                    <div class="ingredient-benefits">
                        ${badges}
                    </div>
                </article>
            `;
        }

        function determineIngredientCompatibility(item, evaluation) {
            const state = (item.state || item.status || '').toLowerCase();
            if (['replace', 'conflict', 'warning', 'risk', 'critical'].includes(state)) {
                return { level: 'low', label: 'Baja compatibilidad â€” revisa sustitutos' };
            }
            if (state === 'neutral') {
                return { level: 'neutral', label: 'Compatibilidad neutra' };
            }
            if (['keep', 'compatible', 'safe', 'high'].includes(state)) {
                return { level: 'high', label: 'Alta compatibilidad â€” ideal para tu perfil' };
            }
            const percent = scoreToPercent(item.compatibility_percent ?? item.compatibility_score);
            if (percent != null) {
                if (percent >= 80) return { level: 'high', label: 'Alta compatibilidad â€” ideal para tu perfil' };
                if (percent >= 50) return { level: 'medium', label: 'Compatibilidad media â€” aporte complementario' };
                return { level: 'low', label: 'Baja compatibilidad â€” revisa sustitutos' };
            }
            const supports = evaluation?.supports?.length || 0;
            const conflicts = evaluation?.conflicts?.length || 0;
            if (conflicts > 0) {
                return { level: 'low', label: 'Baja compatibilidad â€” puede generar alertas' };
            }
            if (supports >= 2) {
                return { level: 'high', label: 'Alta compatibilidad â€” ideal para tu perfil' };
            }
            if (supports === 1) {
                return { level: 'medium', label: 'Compatibilidad media â€” aporte complementario' };
            }
            return { level: 'neutral', label: 'Sin datos especÃ­ficos para tu perfil' };
        }

        window.filterIngredientCards = function(status) {
            const container = document.getElementById('ingredientsCardGrid');
            if (!container) return;
            const cards = container.querySelectorAll('.ingredient-card');
            cards.forEach(card => {
                const shouldShow = status === 'all'
                    || (status === 'safe' && card.dataset.status !== 'warning')
                    || (status === 'warning' && card.dataset.status === 'warning');
                card.style.display = shouldShow ? '' : 'none';
            });
            document.querySelectorAll('[data-ingredient-filter]').forEach(btn => {
                btn.classList.toggle('is-active', btn.getAttribute('data-ingredient-filter') === status);
            });
        }

        function buildSummaryFromEntries(supports, conflicts) {
            const supportSpecific = supports.filter(entry => entry.type !== 'general');
            const conflictSpecific = conflicts.filter(entry => entry.type !== 'general');
            const supportLabels = uniqueLabels(supportSpecific);
            const conflictLabels = uniqueLabels(conflictSpecific);

            if (!supportLabels.length && !conflictLabels.length) {
                return 'Neutral';
            }
            if (supportLabels.length && !conflictLabels.length) {
                return `Apoya ${formatList(supportLabels)}`;
            }
            if (!supportLabels.length && conflictLabels.length) {
                return `No recomendado: ${formatList(conflictLabels)}`;
            }
            return `Apoya ${formatList(supportLabels)}, pero ${formatList(conflictLabels)}`;
        }

        function evaluateIngredientUtility(ingredient, profile) {
            if (!profile || Object.keys(profile).length === 0) {
                return {
                    summary: 'Completa tu perfil para personalizar',
                    supports: [],
                    conflicts: []
                };
            }

            const { normalizedName, normalizedDescription: description, baseName, ruleEntry, summaryOverride, isLearned } = normalizeIngredientProfile(ingredient);
            const risk = (ingredient.risk || '').toLowerCase();
            const safetyLevel = (ingredient.safety_level || '').toLowerCase();

            const supportMap = new Map();
            const conflictMap = new Map();

            const goals = Array.isArray(profile.overall_goals) ? profile.overall_goals : [];
            goals.forEach(goal => {
                const key = goal.toLowerCase();
                const keywords = GOAL_KEYWORDS[key];
                if (keywords && matchesKeywords(description, keywords)) {
                    addEntry(supportMap, 'goal', key, GOAL_MESSAGES[key] || goal);
                }
            });

            const skinConcerns = Array.isArray(profile.skin_concerns) ? profile.skin_concerns : [];
            skinConcerns.forEach(concern => {
                const key = concern.toLowerCase();
                const supportKeywords = SKIN_CONCERN_SUPPORT_KEYWORDS[key];
                if (supportKeywords && matchesKeywords(description, supportKeywords)) {
                    addEntry(supportMap, 'skin_concern', key, `atender ${concern}`);
                }
                const riskKeywords = SKIN_CONCERN_RISK_KEYWORDS[key];
                if (riskKeywords && matchesKeywords(description, riskKeywords)) {
                    addEntry(conflictMap, 'skin_concern', key, `podrÃ­a agravar ${concern}`);
                }
                if ((risk === 'high' || risk === 'critical' || safetyLevel === 'caution') && key === 'sensibilidad') {
                    addEntry(conflictMap, 'skin_concern', key, 'podrÃ­a irritar piel sensible');
                }
                if ((risk === 'high' || risk === 'critical') && key === 'acnÃ©') {
                    addEntry(conflictMap, 'skin_concern', key, 'puede obstruir poros');
                }
            });

            const hairConcerns = Array.isArray(profile.hair_concerns) ? profile.hair_concerns : [];
            hairConcerns.forEach(concern => {
                const key = concern.toLowerCase();
                const supportKeywords = HAIR_CONCERN_SUPPORT_KEYWORDS[key];
                if (supportKeywords && matchesKeywords(description, supportKeywords)) {
                    addEntry(supportMap, 'hair_concern', key, `mejorar ${concern}`);
                }
                const riskKeywords = HAIR_CONCERN_RISK_KEYWORDS[key];
                if (riskKeywords && matchesKeywords(description, riskKeywords)) {
                    addEntry(conflictMap, 'hair_concern', key, `podrÃ­a empeorar ${concern}`);
                }
            });

            const skinType = (profile.skin_type || '').toLowerCase();
            if (skinType) {
                const supportKeywords = SKIN_TYPE_SUPPORT_KEYWORDS[skinType];
                if (supportKeywords && matchesKeywords(description, supportKeywords)) {
                    addEntry(supportMap, 'skin_type', skinType, SKIN_TYPE_SUPPORT_LABELS[skinType] || `cuidar tu piel ${skinType}`);
                }
                const riskKeywords = SKIN_TYPE_RISK_KEYWORDS[skinType];
                if (riskKeywords && matchesKeywords(description, riskKeywords)) {
                    addEntry(conflictMap, 'skin_type', skinType, SKIN_TYPE_RISK_LABELS[skinType] || `puede no favorecer tu piel ${skinType}`);
                }
            }

            const hairType = (profile.hair_type || '').toLowerCase();
            if (hairType) {
                const supportKeywords = HAIR_TYPE_SUPPORT_KEYWORDS[hairType];
                if (supportKeywords && matchesKeywords(description, supportKeywords)) {
                    addEntry(supportMap, 'hair_type', hairType, HAIR_TYPE_SUPPORT_LABELS[hairType] || `favorece tu cabello ${hairType}`);
                }
                const riskKeywords = HAIR_TYPE_RISK_KEYWORDS[hairType];
                if (riskKeywords && matchesKeywords(description, riskKeywords)) {
                    addEntry(conflictMap, 'hair_type', hairType, HAIR_TYPE_RISK_LABELS[hairType] || `puede afectar tu cabello ${hairType}`);
                }
            }

            const faceZoneRaw = profile.face_shape || '';
            const faceZone = faceZoneRaw.toLowerCase();
            if (faceZone) {
                const supportKeywords = FACE_ZONE_SUPPORT_KEYWORDS[faceZone];
                if (supportKeywords && matchesKeywords(description, supportKeywords)) {
                    addEntry(supportMap, 'face_zone', faceZone, FACE_ZONE_SUPPORT_LABELS[faceZone] || `cuidar tus zonas faciales`);
                }
                const riskKeywords = FACE_ZONE_RISK_KEYWORDS[faceZone];
                if (riskKeywords && matchesKeywords(description, riskKeywords)) {
                    addEntry(conflictMap, 'face_zone', faceZone, FACE_ZONE_RISK_LABELS[faceZone] || `puede no adaptarse a tus zonas faciales`);
                }
            }

            if (risk === 'high' || risk === 'critical' || safetyLevel === 'caution') {
                addEntry(conflictMap, 'safety', 'high-risk', 'presenta riesgo alto, considera sustituirlo');
            }

            const combinedText = `${normalizedName} ${description}`;

            // Use ruleEntry from normalization if available
            if (ruleEntry) {
                (ruleEntry.supports || []).forEach(entry => {
                    if (!entry.requiresProfile || entry.requiresProfile(profile)) {
                        addEntry(supportMap, entry.type, entry.key, entry.label);
                    }
                });
                (ruleEntry.conflicts || []).forEach(entry => {
                    if (!entry.requiresProfile || entry.requiresProfile(profile)) {
                        addEntry(conflictMap, entry.type, entry.key, entry.label);
                    }
                });
            }

            if (description.includes('extracto natural') || description.includes('jugo natural')) {
                addEntry(supportMap, 'general', `botanico-${normalizedName}`, 'es un extracto botÃ¡nico suave');
                if (hasValue(profile?.overall_goals, 'una rutina limpia')) {
                    addEntry(supportMap, 'goal', 'una rutina limpia', GOAL_MESSAGES['una rutina limpia']);
                }
            }

            const supports = entriesToArray(supportMap);
            const conflicts = entriesToArray(conflictMap);
            const summary = buildSummaryFromEntries(supports, conflicts);

            return {
                summary,
                supports,
                conflicts
            };
        }

        function normalizeIngredientProfile(ingredient) {
            const descriptionRaw = `${ingredient.description || ''} ${ingredient.analysis || ''} ${ingredient.comment || ''}`;
            const normalizedDescription = normalizeText(descriptionRaw);
            const rawName = (ingredient.name || ingredient.ingredient || ingredient.inci || '').trim();
            const normalizedName = normalizeText(rawName);
            const baseName = INGREDIENT_SYNONYMS[normalizedName] || normalizedName;
            const learnedRules = JSON.parse(localStorage.getItem(LEARNED_RULES_KEY) || "{}");
            const learnedEntry = learnedRules[baseName];
            const cumulativeRules = {
                ...INGREDIENT_RULES_BASE,
                ...(learnedRules || {}),
            };
            let ruleEntry = cumulativeRules[baseName] || null;
            let summaryOverride = ruleEntry?.summary || learnedEntry?.summary || null;

            if (!ruleEntry) {
                const directMatch = Object.entries(INGREDIENT_RULES_BASE).find(([key, value]) => {
                    const cleanKey = normalizeText(key);
                    if (normalizedName.includes(cleanKey)) return true;
                    return value.aliases && value.aliases.some(alias => normalizedName.includes(normalizeText(alias)));
                });
                if (directMatch) {
                    ruleEntry = directMatch[1];
                    summaryOverride = ruleEntry.summary || summaryOverride;
                }
            }
            const isLearned = Boolean(ruleEntry && learnedEntry);

            if (!ruleEntry) {
                const guessedFunction = guessFunctionFromName(normalizedName) || guessFunctionFromDescription(normalizedDescription);
                if (guessedFunction) {
                    const mappedCategories = FUNCTION_CATEGORY_MAP_BASE[guessedFunction] || [];
                    if (mappedCategories.length) {
                        ruleEntry = {
                            supports: mappedCategories.map(item => ({
                                type: item.type,
                                key: item.key,
                                label: item.label,
                                requiresProfile: null,
                            })),
                            summary: FUNCTION_SUMMARY_BASE[guessedFunction] || null,
                        };
                        summaryOverride = ruleEntry.summary;
                    }
                }
            }

            return { descriptionRaw, normalizedDescription, rawName, normalizedName, baseName, ruleEntry, summaryOverride, isLearned };
        }

        function guessFunctionFromName(normalizedName) {
            if (!normalizedName) return null;
            for (const [functionKey, keywords] of Object.entries(FUNCTION_KEYWORDS_BASE)) {
                if (keywords.some(keyword => normalizedName.includes(normalizeText(keyword)))) {
                    return functionKey;
                }
            }
            return null;
        }

        function guessFunctionFromDescription(normalizedDescription) {
            if (!normalizedDescription) return null;
            for (const [functionKey, keywords] of Object.entries(FUNCTION_KEYWORDS_BASE)) {
                if (keywords.some(keyword => normalizedDescription.includes(normalizeText(keyword)))) {
                    return functionKey;
                }
            }
            return null;
        }

        function computeIngredientUtility(ingredient, profile) {
            return evaluateIngredientUtility(ingredient, profile);
        }

        function renderUtilityCell(evaluation) {
            if (!evaluation) {
                return '<div class="utility-summary">Sin datos especÃ­ficos</div>';
            }

            const supportEntries = evaluation.supports || [];
            const conflictEntries = evaluation.conflicts || [];

            const supportSpecific = supportEntries.filter(entry => entry.type && entry.type !== 'general');
            const conflictSpecific = conflictEntries.filter(entry => entry.type && entry.type !== 'general');
            const generalSupports = supportEntries.filter(entry => entry.type === 'general');

            const supportLabels = uniqueLabels(supportSpecific.length ? supportSpecific : supportEntries);
            const conflictLabels = uniqueLabels(conflictSpecific.length ? conflictSpecific : conflictEntries);
            const generalLabels = uniqueLabels(generalSupports);

            const chips = [];
            supportLabels.forEach(label => {
                chips.push(`<span class="utility-chip utility-chip--support">âœ” ${escapeHtml(label)}</span>`);
            });
            conflictLabels.forEach(label => {
                chips.push(`<span class="utility-chip utility-chip--conflict">âš  ${escapeHtml(label)}</span>`);
            });

            const generalNote = generalLabels.length
                ? `<div class="utility-note">${escapeHtml(generalLabels.join('. '))}</div>`
                : '';

            return `
                <div class="utility-summary">${escapeHtml(evaluation.summary || 'Neutral')}</div>
                ${chips.length ? `<div class="utility-chips">${chips.join('')}</div>` : ''}
                ${generalNote}
            `;
        }
        function computeProfileIngredientAlignment(structuredReport, profile) {
            if (!profile || Object.keys(profile).length === 0) {
                return null;
            }
            const evaluated = normalizeEvaluatedIngredients(structuredReport?.ingredients_evaluated);
            const safe = normalizeEvaluatedIngredients(structuredReport?.safety?.safe);
            const problematic = normalizeEvaluatedIngredients(structuredReport?.safety?.problematic);
            const combined = evaluated.length ? evaluated : [...safe, ...problematic];
            if (!combined.length) {
                return null;
            }

            const totalIngredients = combined.length;
            const supportMap = new Map();
            const conflictMap = new Map();
            const categoryMap = new Map();
            const ingredientSummary = new Map();
            const compatibilityLabelMap = {
                high: 'Alta compatibilidad',
                medium: 'Compatibilidad media',
                low: 'Baja compatibilidad',
                neutral: 'Compatibilidad neutra'
            };

            const ensureCategory = (type, key, label) => {
                if (!key && !label) return null;
                const categoryKey = `${type}:${key || label}`.toLowerCase();
                if (!categoryMap.has(categoryKey)) {
                    categoryMap.set(categoryKey, {
                        type,
                        key,
                        label,
                        supported: 0,
                        conflicting: 0
                    });
                }
                return categoryMap.get(categoryKey);
            };

            const goals = profile.overall_goals || [];
            goals.forEach(goal => {
                const key = goal.toLowerCase();
                ensureCategory('goal', key, GOAL_MESSAGES[key] || titleCase(goal));
            });

            const skinConcerns = profile.skin_concerns || [];
            skinConcerns.forEach(concern => {
                const key = concern.toLowerCase();
                ensureCategory('skin_concern', key, `PreocupaciÃ³n piel: ${titleCase(concern)}`);
            });

            const hairConcerns = profile.hair_concerns || [];
            hairConcerns.forEach(concern => {
                const key = concern.toLowerCase();
                ensureCategory('hair_concern', key, `Cabello: ${titleCase(concern)}`);
            });

            if (profile.skin_type) {
                ensureCategory('skin_type', profile.skin_type.toLowerCase(), `Piel ${titleCase(profile.skin_type)}`);
            }
            if (profile.hair_type) {
                ensureCategory('hair_type', profile.hair_type.toLowerCase(), `Cabello ${titleCase(profile.hair_type)}`);
            }
            if (profile.face_shape) {
                ensureCategory('face_zone', normalizeText(profile.face_shape), `Zonas: ${getFaceZoneLabel(profile.face_shape)}`);
            }

            let supportiveCount = 0;
            let conflictCount = 0;

            combined.forEach(item => {
                const evaluation = evaluateIngredientUtility(item, profile);
                if (evaluation.supports.length) {
                    supportiveCount += 1;
                    evaluation.supports.forEach(entry => {
                        addEntry(supportMap, entry.type || 'general', entry.key || entry.label, entry.label);
                        if (entry.type && entry.type !== 'general') {
                            const category = ensureCategory(entry.type, (entry.key || '').toLowerCase(), entry.label);
                            if (category) {
                                category.supported += 1;
                            }
                        }
                    });
                }
                if (evaluation.conflicts.length) {
                    conflictCount += 1;
                    evaluation.conflicts.forEach(entry => {
                        addEntry(conflictMap, entry.type || 'general', entry.key || entry.label, entry.label);
                        if (entry.type && entry.type !== 'general') {
                            const category = ensureCategory(entry.type, (entry.key || '').toLowerCase(), entry.label);
                            if (category) {
                                category.conflicting += 1;
                            }
                        }
                    });
                }

                const ingredientName = item.inci || item.ingredient || item.name || 'Ingrediente';
                const compat = determineIngredientCompatibility(item, evaluation);
                const objectiveSource = evaluation.supports.find(entry => entry.type === 'goal')
                    || evaluation.supports.find(entry => entry.type && entry.type !== 'general')
                    || evaluation.conflicts.find(entry => entry.type === 'goal')
                    || evaluation.conflicts.find(entry => entry.type && entry.type !== 'general')
                    || null;
                const fallbackGoal = (profile.overall_goals || [])[0] || 'Objetivo general';
                const objectiveLabel = objectiveSource
                    ? titleCase(objectiveSource.label || objectiveSource)
                    : titleCase(fallbackGoal);
                const key = ingredientName.toLowerCase();
                const current = ingredientSummary.get(key);
                const level = compat.level || 'neutral';
                const labelText = compatibilityLabelMap[level] || compatibilityLabelMap.neutral;
                if (!current) {
                    ingredientSummary.set(key, {
                        ingredient: ingredientName,
                        objective: objectiveLabel,
                        level,
                        label: labelText
                    });
                }
            });

            const categories = Array.from(categoryMap.values()).filter(category => {
                return category.supported > 0 || category.conflicting > 0;
            }).map(category => ({
                ...category,
                total: totalIngredients,
                evidence: category.supported + category.conflicting
            }));

            const supportHighlightsAll = entriesToArray(supportMap);
            const conflictHighlightsAll = entriesToArray(conflictMap);
            const supportHighlightsSpecific = supportHighlightsAll.filter(entry => entry.type && entry.type !== 'general');
            const conflictHighlightsSpecific = conflictHighlightsAll.filter(entry => entry.type && entry.type !== 'general');

            return {
                supportiveCount,
                conflictCount,
                supports: uniqueLabels(supportHighlightsSpecific.length ? supportHighlightsSpecific : supportHighlightsAll),
                conflicts: uniqueLabels(conflictHighlightsSpecific.length ? conflictHighlightsSpecific : conflictHighlightsAll),
                categories,
                totalIngredients,
                ingredientRows: Array.from(ingredientSummary.values())
            };
        }

        function initializeJourneySteps() {
            journeyStepItems = Array.from(document.querySelectorAll('#journeySteps .steps-item'));
            journeyStepItems.forEach(item => item.classList.remove('is-active', 'is-complete'));
            setStepStatus(1, 'active');
            setupJourneyNavigation();
        }

        function setStepStatus(step, status) {
            const item = journeyStepItems.find(el => Number(el.dataset.step) === Number(step));
            if (!item) return;
            item.classList.remove('is-active', 'is-complete');
            if (status === 'active') {
                item.classList.add('is-active');
            } else if (status === 'completed') {
                item.classList.add('is-complete');
            }
        }

        function activateStep(step) {
            journeyStepItems.forEach(el => {
                const stepNumber = Number(el.dataset.step);
                if (stepNumber < step) {
                    setStepStatus(stepNumber, 'completed');
                } else if (stepNumber === step) {
                    setStepStatus(stepNumber, 'active');
                } else {
                    setStepStatus(stepNumber, 'pending');
                }
            });
        }

        function highlightJourneyStep(step) {
            if (!journeyStepItems.length) {
                journeyStepItems = Array.from(document.querySelectorAll('#journeySteps .steps-item'));
            }
            journeyStepItems.forEach(item => {
                const matches = Number(item.dataset.step) === Number(step);
                item.classList.toggle('is-nav-focus', matches && step != null);
                if (!matches && step == null) {
                    item.classList.remove('is-nav-focus');
                }
            });
        }

        function handleJourneyScroll() {
            if (journeyScrollScheduled) return;
            journeyScrollScheduled = true;
            requestAnimationFrame(() => {
                const offset = window.scrollY + 160;
                let current = null;
                journeySections.forEach(section => {
                    const top = section.element ? section.element.offsetTop : 0;
                    if (top <= offset) {
                        current = section.step;
                    }
                });
                highlightJourneyStep(current);
                journeyScrollScheduled = false;
            });
        }

        function setupJourneyNavigation() {
            journeyStepItems = Array.from(document.querySelectorAll('#journeySteps .steps-item'));
            journeyStepItems.forEach(item => {
                if (!item.dataset.navBound) {
                    item.addEventListener('click', (event) => {
                        const targetId = item.dataset.target;
                        if (!targetId) return;
                        const target = document.getElementById(targetId);
                        if (!target) return;
                        event.preventDefault();
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    });
                    item.dataset.navBound = 'true';
                }
            });
            journeySections = journeyStepItems
                .map(item => {
                    const targetId = item.dataset.target;
                    const target = targetId ? document.getElementById(targetId) : null;
                    if (!target) return null;
                    return { step: Number(item.dataset.step), element: target };
                })
                .filter(Boolean)
                .sort((a, b) => (a.element.offsetTop || 0) - (b.element.offsetTop || 0));
            if (!journeyScrollBound) {
                window.addEventListener('scroll', handleJourneyScroll, { passive: true });
                journeyScrollBound = true;
            }
            handleJourneyScroll();
        }

        function getStoredProfile() {
            try {
                const raw = localStorage.getItem(PROFILE_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                return parsed && Object.keys(parsed).length ? parsed : null;
            } catch (error) {
                console.warn('Unable to read profile from storage', error);
                return null;
            }
        }

        function serializeProfileFromForm() {
            const getCheckedValues = (containerId) => {
                return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`))
                    .map(input => input.value);
            };

            const profile = {
                skin_type: document.getElementById('skinType').value || null,
                hair_type: document.getElementById('hairType').value || null,
                face_shape: document.getElementById('faceShape').value || null,
                skin_concerns: getCheckedValues('skinConcernsGroup'),
                hair_concerns: getCheckedValues('hairConcernsGroup'),
                overall_goals: getCheckedValues('overallGoalsGroup'),
            };

            // Remove empty arrays/strings
            Object.keys(profile).forEach(key => {
                const value = profile[key];
                if (Array.isArray(value) && value.length === 0) {
                    profile[key] = [];
                } else if (value === '') {
                    profile[key] = null;
                }
            });
            return profile;
        }

        function applyProfileToForm(profile) {
            const skinSelect = document.getElementById('skinType');
            const hairSelect = document.getElementById('hairType');
            const faceSelect = document.getElementById('faceShape');

            skinSelect.value = profile?.skin_type || '';
            hairSelect.value = profile?.hair_type || '';
            faceSelect.value = profile?.face_shape || '';

            const syncCheckboxes = (containerId, values = []) => {
                const inputs = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
                inputs.forEach(input => {
                    const checked = values.includes(input.value);
                    input.checked = checked;
                    input.parentElement.classList.toggle('active', checked);
                });
            };

            syncCheckboxes('skinConcernsGroup', profile?.skin_concerns || []);
            syncCheckboxes('hairConcernsGroup', profile?.hair_concerns || []);
            syncCheckboxes('overallGoalsGroup', profile?.overall_goals || []);
        }

        function renderProfile(profile) {
            const pill = document.getElementById('profilePill');
            const hero = document.getElementById('profileHeroTitle');
            const subtitle = document.getElementById('profileSubtitle');
            const highlights = document.getElementById('profileHighlights');
            const hint = document.getElementById('profileHint');

            if (!pill || !hero || !highlights) return;

            highlights.innerHTML = '';

            if (!profile || !Object.keys(profile).length) {
                pill.textContent = 'Perfil incompleto';
                hero.textContent = 'DiseÃ±emos tu perfil con IA';
                subtitle.textContent = 'CuÃ©ntanos sobre tu piel, rostro y cabello para recibir anÃ¡lisis y sustitutos hechos a tu medida.';
                hint.textContent = 'Tu perfil nos ayuda a evaluar compatibilidad, riesgos y sustitutos especÃ­ficos.';
                highlights.innerHTML = '<span class="muted">Completa tu perfil para desbloquear recomendaciones personalizadas.</span>';
                return;
            }

            pill.textContent = 'Perfil activo';
            hero.textContent = 'Cuestionario Cuidado Personal';
            subtitle.textContent = 'Aplicamos las respuestas de tu cuestionario en cada anÃ¡lisis y recomendaciÃ³n.';
            const summaryParts = [];
            if (profile.skin_type) summaryParts.push(`piel ${profile.skin_type}`);
            if (profile.hair_type) summaryParts.push(`cabello ${profile.hair_type}`);
            hint.textContent = summaryParts.length
                ? `Basado en ${summaryParts.join(' y ')}, sensibilidades y objetivos declarados.`
                : 'Tus datos nos permiten personalizar cada resultado.';

            const chipTexts = [];
            if (profile.skin_type) chipTexts.push(`Piel: ${titleCase(profile.skin_type)}`);
            if (profile.face_shape) chipTexts.push(`Zonas: ${getFaceZoneLabel(profile.face_shape)}`);
            if (profile.hair_type) chipTexts.push(`Cabello: ${titleCase(profile.hair_type)}`);
            (profile.skin_concerns || []).slice(0, 3).forEach(item => chipTexts.push(`Piel: ${titleCase(item)}`));
            (profile.hair_concerns || []).slice(0, 3).forEach(item => chipTexts.push(`Cabello: ${titleCase(item)}`));
            (profile.overall_goals || []).slice(0, 4).forEach(item => chipTexts.push(titleCase(item)));

            if (!chipTexts.length) {
                highlights.innerHTML = '<span class="muted">AÃ±ade tus objetivos para personalizar mÃ¡s los resultados.</span>';
                return;
            }

            highlights.innerHTML = chipTexts.map(text => `<span class="profile-highlight">${escapeHtml(text)}</span>`).join('');
        }

        window.toggleProfileForm = function toggleProfileForm() {};

        function showProfileToast(message) {
            const toast = document.getElementById('profileToast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add('is-visible');
            clearTimeout(showProfileToast.timer);
            showProfileToast.timer = setTimeout(() => toast.classList.remove('is-visible'), 2600);
        }

        function togglePill(input) {
            input.parentElement.classList.toggle('active', input.checked);
        }

        function persistProfile(profile, options = {}) {
            localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile));
            applyProfileToForm(profile);
            renderProfile(profile);
            attemptSyncProfile(profile);
            setStepStatus(1, 'completed');
            setStepStatus(2, 'active');
            if (options.toast !== false) {
                showProfileToast(options.toastMessage || 'Perfil actualizado ðŸ’œ');
            }
        }

        window.resetProfile = function resetProfile() {
            localStorage.removeItem(PROFILE_STORAGE_KEY);
            profileWizardState.data = defaultProfileData();
            applyProfileToForm(null);
            renderProfile(null);
            setStepStatus(1, 'active');
            setStepStatus(2, 'pending');
            showProfileToast('Perfil restablecido');
        }

        async function attemptSyncProfile(profile) {
            try {
                const response = await fetch(`${API_BASE}/profile/me`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profile)
                });
                if (!response.ok) {
                    console.info('Profile sync skipped:', response.status);
                }
            } catch (error) {
                console.info('Profile sync unavailable:', error.message);
            }
        }

        async function saveProfile(event) {
            event.preventDefault();
            const profile = serializeProfileFromForm();

            if (!profile.skin_type || !profile.hair_type || !profile.face_shape) {
                alert('Por favor elige tu tipo de piel, cabello y rostro.');
                return;
            }

            persistProfile(profile, { toastMessage: 'Perfil actualizado ðŸ¤' });
        }

        function getProfileForRequest() {
            return getStoredProfile();
        }

        function ensureProfileReady() {
            const profile = getStoredProfile();
            if (profile) {
                applyProfileToForm(profile);
                renderProfile(profile);
                setStepStatus(1, 'completed');
                setStepStatus(2, 'active');
            } else {
                applyProfileToForm(null);
                renderProfile(null);
                setStepStatus(1, 'active');
            }
        }

        function syncWizardChips() {
            const chips = document.querySelectorAll('.wizard-chip');
            chips.forEach(chip => {
                const field = chip.dataset.field;
                const value = chip.dataset.value;
                const mode = chip.dataset.mode || 'single';
                let isActive = false;
                if (mode === 'single') {
                    isActive = profileWizardState.data[field] === value;
                } else {
                    const arr = profileWizardState.data[field] || [];
                    isActive = arr.includes(value);
                }
                chip.classList.toggle('is-active', isActive);
            });
        }

        function goToProfileWizardStep(step) {
            profileWizardState.step = Math.max(1, Math.min(3, step));
            const steps = document.querySelectorAll('.wizard-step');
            steps.forEach(stepEl => {
                const isActive = Number(stepEl.dataset.step) === profileWizardState.step;
                stepEl.classList.toggle('is-active', isActive);
            });
            const progress = document.getElementById('profileWizardProgress');
            if (progress) {
                progress.textContent = `Paso ${profileWizardState.step} de 3`;
            }
            const primaryButton = document.getElementById('wizardPrimaryButton');
            if (primaryButton) {
                primaryButton.textContent = profileWizardState.step === 3 ? 'Guardar y continuar' : 'Siguiente';
            }
            const prevButton = document.getElementById('wizardPrevButton');
            if (prevButton) {
                prevButton.disabled = profileWizardState.step === 1;
            }
        }

        window.openProfileWizard = function openProfileWizard() {
            const stored = getStoredProfile();
            profileWizardState.data = stored
                ? {
                    skin_type: stored.skin_type || null,
                    hair_type: stored.hair_type || null,
                    face_shape: stored.face_shape || null,
                    skin_concerns: [...(stored.skin_concerns || [])],
                    hair_concerns: [...(stored.hair_concerns || [])],
                    overall_goals: [...(stored.overall_goals || [])]
                }
                : defaultProfileData();
            const wizard = document.getElementById('profileWizard');
            if (!wizard) return;
            wizard.classList.add('is-visible');
            wizard.setAttribute('aria-hidden', 'false');
            goToProfileWizardStep(1);
            syncWizardChips();
        }

        window.closeProfileWizard = function closeProfileWizard() {
            const wizard = document.getElementById('profileWizard');
            if (!wizard) return;
            wizard.classList.remove('is-visible');
            wizard.setAttribute('aria-hidden', 'true');
            profileWizardState.step = 1;
        }

        window.handleWizardChip = function handleWizardChip(button) {
            const field = button.dataset.field;
            const value = button.dataset.value;
            const mode = button.dataset.mode || 'single';
            if (mode === 'single') {
                profileWizardState.data[field] = value;
            } else {
                const arr = new Set(profileWizardState.data[field] || []);
                if (arr.has(value)) {
                    arr.delete(value);
                } else {
                    arr.add(value);
                }
                profileWizardState.data[field] = Array.from(arr);
            }
            syncWizardChips();
        }

        window.nextProfileWizardStep = function nextProfileWizardStep() {
            if (profileWizardState.step === 3) {
                saveProfileFromWizard();
            } else {
                goToProfileWizardStep(profileWizardState.step + 1);
            }
        }

        window.prevProfileWizardStep = function prevProfileWizardStep() {
            if (profileWizardState.step === 1) return;
            goToProfileWizardStep(profileWizardState.step - 1);
        }

        function buildProfileFromWizard() {
            return {
                skin_type: profileWizardState.data.skin_type,
                hair_type: profileWizardState.data.hair_type,
                face_shape: profileWizardState.data.face_shape,
                skin_concerns: profileWizardState.data.skin_concerns || [],
                hair_concerns: profileWizardState.data.hair_concerns || [],
                overall_goals: profileWizardState.data.overall_goals || [],
            };
        }

        function saveProfileFromWizard() {
            const profile = buildProfileFromWizard();
            if (!profile.skin_type || !profile.hair_type || !profile.face_shape) {
                alert('Selecciona al menos tu tipo de piel, cabello y zonas prioritarias.');
                return;
            }
            persistProfile(profile, { toastMessage: 'Perfil listo para personalizar tus anÃ¡lisis âœ¨' });
            closeProfileWizard();
        }

        function buildCollapsibleCard({ title, subtitle = '', badgeHtml = '', bodyHtml = '', classes = '', defaultOpen = true }) {
            const openAttr = defaultOpen ? ' open' : '';
            const subtitleHtml = subtitle ? `<span class="summary-subtitle">${subtitle}</span>` : '';
            const metaContent = badgeHtml ? `${badgeHtml}<span class="collapse-icon" aria-hidden="true"></span>` : `<span class="collapse-icon" aria-hidden="true"></span>`;

            return `
                <section class="result-card ${classes}">
                    <details class="card-collapse"${openAttr}>
                        <summary>
                            <span class="summary-info">
                                <span class="result-title">${title}</span>
                                ${subtitleHtml}
                            </span>
                            <span class="summary-meta">
                                ${metaContent}
                            </span>
                        </summary>
                        <div class="card-body">
                            ${bodyHtml}
                        </div>
                    </details>
                </section>
            `;
        }

        function renderProfileResult(profile) {
            if (!profile || Object.keys(profile).length === 0) {
                return '';
            }
            const lines = [];
            if (profile.skin_type) lines.push(`<li><strong>Piel:</strong> ${escapeHtml(profile.skin_type)}</li>`);
            if (profile.hair_type) lines.push(`<li><strong>Cabello:</strong> ${escapeHtml(profile.hair_type)}</li>`);
            if (profile.face_shape) lines.push(`<li><strong>Zonas faciales:</strong> ${escapeHtml(getFaceZoneLabel(profile.face_shape))}</li>`);
            if (Array.isArray(profile.skin_concerns) && profile.skin_concerns.length) {
                const concerns = profile.skin_concerns.map(escapeHtml).join(', ');
                lines.push(`<li><strong>Preocupaciones de piel:</strong> ${concerns}</li>`);
            }
            if (Array.isArray(profile.hair_concerns) && profile.hair_concerns.length) {
                const concerns = profile.hair_concerns.map(escapeHtml).join(', ');
                lines.push(`<li><strong>Preocupaciones de cabello:</strong> ${concerns}</li>`);
            }
            if (Array.isArray(profile.overall_goals) && profile.overall_goals.length) {
                const goals = profile.overall_goals.map(escapeHtml).join(', ');
                lines.push(`<li><strong>Objetivos:</strong> ${goals}</li>`);
            }
            if (!lines.length) return '';
            const body = `
                <ul style="list-style: disc; padding-left: 20px;">
                    ${lines.join('')}
                </ul>
            `;
            return buildCollapsibleCard({
                title: 'ðŸ‘¤ Perfil personalizado aplicado',
                subtitle: 'Tus preferencias se aplicaron a este anÃ¡lisis.',
                bodyHtml: body
            });
        }

        function buildSummaryCard(structuredReport, result) {
            const analysisSummary = structuredReport?.analysis_summary || {};
            const productName = structuredReport?.product_name || result.product_name || 'Producto analizado';
            const compatibilityPercent = scoreToPercent(analysisSummary.score_global ?? analysisSummary.compatibility_score ?? result.compatibility_score);
            const ecoPercent = scoreToPercent(analysisSummary.eco_score_avg ?? result.avg_eco_score);
            const ingredientsAnalyzed = analysisSummary.ingredients_analyzed ?? structuredReport?.stats?.total ?? result.ingredients_analyzed;
            const riskLevelRaw = analysisSummary.risk_level || result.risk_level || result.suitability;
            const subtitleText = analysisSummary.description || result.description || 'Estas son las conclusiones clave del producto que escaneaste.';
            const summaryChips = [
                { label: 'Producto', value: productName },
                { label: 'Compatibilidad global', value: compatibilityPercent != null ? `${compatibilityPercent}%` : null },
                { label: 'Ãndice eco', value: ecoPercent != null ? `${ecoPercent}/100` : null },
                { label: 'Ingredientes', value: ingredientsAnalyzed != null ? `${ingredientsAnalyzed} analizados` : null },
            ];
            if (riskLevelRaw) {
                summaryChips.push({ label: 'Riesgo', value: titleCase(riskLevelRaw), badge: getRiskBadge(riskLevelRaw) });
            }
            const chipsHtml = summaryChips
                .filter(chip => chip.value)
                .map(chip => `
                    <div class="summary-chip">
                        <strong>${escapeHtml(chip.label)}</strong>
                        ${escapeHtml(chip.value)} ${chip.badge || ''}
                    </div>
                `).join('');
            const badgeValue = compatibilityPercent != null
                ? `${compatibilityPercent}%`
                : (ecoPercent != null ? `${ecoPercent}/100` : '');
            const badgeHtml = badgeValue ? `<span class="score-badge">${badgeValue}</span>` : '';
            const body = `
                <div class="summary-grid">
                    ${chipsHtml}
                </div>
            `;
            return buildCollapsibleCard({
                title: 'ðŸ“Š Resumen del anÃ¡lisis',
                subtitle: escapeHtml(subtitleText),
                badgeHtml,
                bodyHtml: body,
                classes: 'result-card--summary'
            });
        }

        function buildExtractedTextCard(text) {
            const body = `
                <p class="muted" style="margin-bottom:12px;">Texto extraÃ­do del empaque para tu referencia.</p>
                <div style="background: rgba(168,85,247,0.08); padding: 16px; border-radius: 14px; font-family: monospace; white-space: pre-wrap;">
                    ${escapeHtml(text)}
                </div>
            `;
            return buildCollapsibleCard({
                title: 'ðŸ“„ Ingredientes detectados',
                bodyHtml: body
            });
        }

        function getRiskBadge(risk) {
            const value = (risk || '').toLowerCase();
            if (value === 'high' || value === 'critical' || value === 'alto') return '<span class="badge danger">Alto</span>';
            if (value === 'moderate' || value === 'moderado') return '<span class="badge warning">Moderado</span>';
            if (!value) return '';
            return '<span class="badge safe">Bajo</span>';
        }

        function buildIngredientsCard(structuredReport, profileContext) {
            const profile = profileContext && Object.keys(profileContext || {}).length
                ? profileContext
                : getProfileForRequest();
            const ingredientsEvaluated = normalizeEvaluatedIngredients(structuredReport?.ingredients_evaluated);
            const safety = structuredReport?.safety || {};
            const safeIngredients = Array.isArray(safety.safe) ? safety.safe : [];
            const problematicIngredients = Array.isArray(safety.problematic) ? safety.problematic : [];
            const combined = ingredientsEvaluated.length
                ? ingredientsEvaluated.map(item => ({
                    ...item,
                    status: (item.state === 'conflict' || item.state === 'replace') ? 'warning' : (item.state || 'safe')
                }))
                : [
                    ...safeIngredients.map(item => ({ ...item, status: 'safe' })),
                    ...problematicIngredients.map(item => ({ ...item, status: 'warning' }))
                ];

            if (!combined.length) {
                return '';
            }

            const productContextText = getCurrentProductTypeContext();
            const cardsHtml = combined.map(item => renderIngredientCard(item, profile)).join('');
            const body = `
                <p class="muted" style="margin-bottom:8px;">Colores segÃºn compatibilidad con tu perfil: ðŸŸ¢ Alta Â· ðŸŸ¡ Media Â· ðŸ”´ Baja Â· âšª Neutra</p>
                <div class="ingredient-filters">
                    ${renderIngredientFilterButton('all', 'Todos', combined.length, true)}
                    ${renderIngredientFilterButton('safe', 'Seguros', combined.filter(item => item.status !== 'warning').length, false)}
                    ${renderIngredientFilterButton('warning', 'A revisar', combined.filter(item => item.status === 'warning').length, false)}
                </div>
                <div class="ingredients-cards" id="ingredientsCardGrid">
                    ${cardsHtml}
                </div>
            `;

            return buildCollapsibleCard({
                title: 'ðŸ§ª Ingredientes evaluados',
                subtitle: productContextText
                    ? `${combined.length} ingredientes analizados para ${productContextText}.`
                    : `${combined.length} ingredientes analizados por nuestro laboratorio inteligente.`,
                bodyHtml: body
            });
        }

        function buildInsightsCard(structuredReport, result, profileContext, alignment) {
            const recommendationsBlock = structuredReport?.recommendations || null;
            const srRecommendations = Array.isArray(recommendationsBlock?.summary) ? recommendationsBlock.summary : [];
            const fallback = Array.isArray(result.recommendations) ? result.recommendations : [];
            const recommendations = srRecommendations.length ? srRecommendations : fallback;

            const profile = profileContext && Object.keys(profileContext || {}).length
                ? profileContext
                : getProfileForRequest();
            const effectiveAlignment = alignment || computeProfileIngredientAlignment(structuredReport, profile);

            const summaryPoints = [];
            if (recommendationsBlock?.summary) {
                const summary = recommendationsBlock.summary;
                if (summary.ingredients_supporting !== undefined) {
                    summaryPoints.push(`${summary.ingredients_supporting} ingredientes respaldan tus objetivos.`);
                }
                if (summary.conflicts !== undefined) {
                    summaryPoints.push(summary.conflicts
                        ? `${summary.conflicts} ingredientes requieren ajustes.`
                        : 'Sin conflictos con tus necesidades declaradas.');
                }
            } else if (effectiveAlignment) {
                summaryPoints.push(`${effectiveAlignment.supportiveCount} ingredientes respaldan tus objetivos clave.`);
                summaryPoints.push(effectiveAlignment.conflictCount
                    ? `${effectiveAlignment.conflictCount} generan alertas que podemos ajustar.`
                    : 'Sin conflictos con tus necesidades declaradas.');
            } else {
                summaryPoints.push('Completa tu perfil para personalizar recomendaciones.');
            }
            if (recommendations.length) {
                summaryPoints.push(recommendations[0]);
            }

            const goalSource = recommendationsBlock?.objectives?.length
                ? recommendationsBlock.objectives.map(obj => ({ label: obj.name, value: scoreToPercent(obj.percent ?? obj.value ?? 0) ?? 0 }))
                : (effectiveAlignment?.categories || []).filter(entry => entry.type === 'goal').map(entry => {
                    const total = entry.supported + entry.conflicting;
                    const ratio = total ? Math.round((entry.supported / total) * 100) : 0;
                    return { label: entry.label, value: ratio };
                });
            const goalBars = goalSource.length
                ? goalSource.slice(0, 5).map(entry => {
                    const color = entry.value >= 80 ? '#34d399' : entry.value >= 50 ? '#fbbf24' : '#fb7185';
                    return `
                        <div class="goal-progress">
                            <div class="goal-progress-header">
                                <span>${escapeHtml(entry.label)}</span>
                                <span>${Math.round(entry.value)}%</span>
                            </div>
                            <div class="goal-progress-bar"><span style="width:${Math.round(entry.value)}%; background:${color};"></span></div>
                        </div>
                    `;
                }).join('')
                : '<p class="muted">AÃºn no detectamos objetivos priorizados, agrega mÃ¡s informaciÃ³n a tu perfil.</p>';

            const summaryHtml = summaryPoints.map(point => `<p>âœ… ${escapeHtml(point)}</p>`).join('');
            const profileLine = profile && Object.keys(profile).length
                ? `Basado en tu perfil: piel ${escapeHtml(profile.skin_type || 'â€”')}, cabello ${escapeHtml(profile.hair_type || 'â€”')}${profile.skin_concerns?.length ? `, sensibilidad ${escapeHtml(profile.skin_concerns[0])}` : ''}.`
                : '';
            const body = `
                <div class="recommendations-card">
                    ${profileLine ? `<p class="muted" style="margin-bottom:10px;">${profileLine}</p>` : ''}
                    <div class="recommendations-summary">
                        ${summaryHtml}
                    </div>
                    <h4 style="margin-bottom:10px;">ðŸŽ¯ Objetivos priorizados</h4>
                    ${goalBars}
                    <div class="recommendations-cta">
                        <button type="button" class="btn btn-secondary" onclick="openProfileWizard()">Ajustar objetivos</button>
                        <button type="button" class="btn btn-primary" onclick="scrollToLabsResult()">Ver fÃ³rmula personalizada</button>
                    </div>
                </div>
            `;

            return buildCollapsibleCard({
                title: 'ðŸ’¡ Recomendaciones para ti',
                subtitle: 'Alineamos las recomendaciones con tus objetivos.',
                bodyHtml: body
            });
        }

        function classifyCompatibility(entry) {
            const evidence = entry.evidence || (entry.supported + entry.conflicting);
            if (!evidence) {
                return { label: 'Sin evidencia', level: 'low', percent: 0 };
            }
            const ratio = entry.supported / evidence;
            if (entry.conflicting > entry.supported) {
                return { label: 'Requiere ajustes', level: 'low', percent: Math.round(ratio * 100) };
            }
            if (ratio >= 0.66) {
                return { label: 'Alta compatibilidad', level: 'high', percent: Math.round(ratio * 100) };
            }
            if (ratio >= 0.33) {
                return { label: 'Compatibilidad media', level: 'medium', percent: Math.round(ratio * 100) };
            }
            return { label: 'Compatibilidad baja', level: 'low', percent: Math.round(ratio * 100) };
        }

        function buildCompatibilityCard(structuredReport, alignment, profile) {
            const rows = alignment?.ingredientRows || [];
            if (!alignment || !rows.length) {
                return '';
            }

            const summaryText = structuredReport?.compatibility?.goals_summary
                || (alignment.conflictCount
                    ? `${alignment.supportiveCount} ingredientes estÃ¡n alineados y ${alignment.conflictCount} necesitan ajustes.`
                    : 'Todos los ingredientes detectados respaldan tus objetivos principales.');

            const subtitle = profile && Object.keys(profile || {}).length
                ? 'RelaciÃ³n entre ingredientes, tus objetivos y su compatibilidad.'
                : 'Completa tu perfil para obtener compatibilidad personalizada.';

            const badgeClassMap = {
                high: 'compat-badge compat-badge--high',
                medium: 'compat-badge compat-badge--medium',
                low: 'compat-badge compat-badge--low',
                neutral: 'compat-badge compat-badge--none'
            };

            const limitedRows = rows.slice(0, 12);
            const tableBody = limitedRows.map(row => {
                const badgeClass = badgeClassMap[row.level] || badgeClassMap.neutral;
                return `
                    <tr>
                        <td>${escapeHtml(row.ingredient)}</td>
                        <td>${escapeHtml(row.objective)}</td>
                        <td><span class="${badgeClass}">${escapeHtml(row.label)}</span></td>
                    </tr>
                `;
            }).join('');

            const productContext = getCurrentProductTypeContext();
            const contextNote = productContext
                ? `<p class="muted" style="margin-top:12px;">Contexto actual: ${escapeHtml(productContext)}.</p>`
                : '';

            const bodyHtml = `
                <div class="compat-summary">${escapeHtml(summaryText)}</div>
                <table class="compat-table">
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Objetivo del cuestionario</th>
                            <th>Compatibilidad</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableBody}
                    </tbody>
                </table>
                ${contextNote}
            `;

            return buildCollapsibleCard({
                title: 'ðŸ” Compatibilidad personalizada',
                subtitle,
                bodyHtml
            });
        }

        function buildFallbackResults(result, profileHtml) {
            const summaryBody = `
                <p class="muted">${escapeHtml(result.product_name || 'Producto analizado')}</p>
                <div class="summary-grid" style="margin-top:12px;">
                    <div class="summary-chip"><strong>Seguridad</strong>${result.avg_eco_score || '-'} / 100</div>
                    <div class="summary-chip"><strong>Recomendaciones</strong>${(result.recommendations || []).map(escapeHtml).join(', ') || 'Consulta el detalle'}</div>
                                </div>
                                `;

            const ingredients = Array.isArray(result.ingredients) ? result.ingredients.map(ingredient => `
                <p class="ingredient-item ${getIngredientClass(ingredient.score || 0)}">
                    <span class="ingredient-name">${escapeHtml(ingredient.name || '')}</span>
                    <span class="ingredient-score ${getScoreClass(ingredient.score || 0)}">${ingredient.score || '-'} / 100</span>
                </p>
            `).join('') : '<p class="muted">No se pudo generar el detalle de ingredientes.</p>';

            const summaryCard = buildCollapsibleCard({
                title: 'ðŸ“Š Resumen del anÃ¡lisis',
                subtitle: 'Resultados generales de seguridad y desempeÃ±o del producto.',
                bodyHtml: summaryBody
            });

            const ingredientsCard = buildCollapsibleCard({
                title: 'ðŸ§ª Ingredientes analizados',
                subtitle: 'Detalle general del puntaje individual de cada ingrediente.',
                bodyHtml: ingredients
            });

            return summaryCard + (profileHtml || '') + ingredientsCard;
        }

        let builderState = null;

        function renderProductBuilder(structuredReport, analysisResult, activeProfile) {
            const mount = document.getElementById('builderMount');
            if (!mount) return;

            const evaluated = normalizeEvaluatedIngredients(structuredReport?.ingredients_evaluated);
            let problematic = normalizeEvaluatedIngredients(structuredReport?.safety?.problematic);
            if (!problematic.length && evaluated.length) {
                problematic = evaluated
                    .filter(item => item.state === 'conflict' || item.state === 'replace' || (Array.isArray(item.risk_flags) && item.risk_flags.length))
                    .map(item => ({
                        ingredient: item.ingredient,
                        analysis: item.comment || item.analysis || 'Recomendamos sustituirlo para tu perfil.'
                    }));
            }

            const intelligentFormula = structuredReport?.intelligent_formula || null;
            const replacements = Array.isArray(intelligentFormula?.replacements) ? intelligentFormula.replacements : [];
            if (!problematic.length && replacements.length) {
                problematic = replacements.map(rep => ({
                    ingredient: rep.from || rep.original || '',
                    analysis: rep.reason || 'Mommyshops recomienda sustituir este ingrediente.'
                })).filter(entry => entry.ingredient);
            }

            const recommendedSubstitutes = Array.isArray(intelligentFormula?.recommended_substitutes)
                ? intelligentFormula.recommended_substitutes
                : [];

            const substitutesMap = new Map();
            replacements.forEach(rep => {
                const key = (rep.from || rep.original || '').trim();
                if (!key) return;
                const alternatives = [];
                if (rep.to) {
                    alternatives.push({
                        name: rep.to.inci || rep.to.name || 'Sustituto propuesto',
                        reason: buildReplacementReason(rep.to)
                    });
                }
                if (!alternatives.length && recommendedSubstitutes.length) {
                    recommendedSubstitutes.slice(0, 2).forEach(sub => {
                        alternatives.push({
                            name: sub.inci || sub.name,
                            reason: buildRecommendedReason(sub)
                        });
                    });
                }
                substitutesMap.set(key, alternatives);
            });

            if (!substitutesMap.size && Array.isArray(structuredReport?.substitutes)) {
                structuredReport.substitutes.forEach(entry => {
                    if (entry && entry.for) {
                        substitutesMap.set(entry.for, Array.isArray(entry.alternatives) ? entry.alternatives : []);
                    }
                });
            }

            const defaultAlternatives = recommendedSubstitutes.slice(0, 3).map(sub => ({
                name: sub.inci || sub.name,
                reason: buildRecommendedReason(sub)
            }));

            const safeFromFormula = extractBaseIngredientNamesFromFormula(intelligentFormula);
            const safeFromSafety = Array.isArray(structuredReport?.safety?.safe)
                ? structuredReport.safety.safe.map(item => item.ingredient || item.name || '').filter(Boolean)
                : [];
            const safeIngredients = uniqueStrings(safeFromFormula.length ? safeFromFormula : safeFromSafety);
            const baseProductName = structuredReport.product_name || analysisResult.product_name || 'Producto personalizado';
            const seenProblematic = new Set();
            problematic = problematic.filter(item => {
                const key = (item.ingredient || item.name || '').toLowerCase();
                if (!key || seenProblematic.has(key)) {
                    return false;
                }
                seenProblematic.add(key);
                return true;
            });

            const progressBadgesHtml = `
                <div class="progress-badges">
                    <span class="progress-badge">ðŸ§ª Clean-lab listo</span>
                    <span class="progress-badge">ðŸ’š Riesgo controlado</span>
                    <span class="progress-badge">ðŸ“¦ Entrega 5-7 dÃ­as</span>
                </div>
            `;

            if (!problematic.length) {
                builderState = null;
                mount.innerHTML = '';
                setStepStatus(4, 'completed');
                setStepStatus(5, 'completed');
                setStepStatus(6, 'active');
                return;
            }

            builderState = {
                baseProductName,
                safeIngredients,
                items: problematic.map(problematicItem => {
                    const ingredientName = problematicItem.ingredient || problematicItem.name || '';
                    if (!ingredientName) return null;
                    const mappedAlternatives = substitutesMap.get(ingredientName) || [];
                    const normalizedAlternatives = mappedAlternatives.length
                        ? mappedAlternatives
                        : defaultAlternatives;
                    const selectedIndex = normalizedAlternatives.length ? 0 : '__original__';
                    return {
                        original: ingredientName,
                        description: problematicItem.analysis || problematicItem.description || 'Sustituye este ingrediente para reducir riesgos.',
                        alternatives: normalizedAlternatives,
                        selectedIndex,
                    };
                }).filter(Boolean),
                profile: activeProfile || getProfileForRequest(),
            };

            if (intelligentFormula) {
                if (Array.isArray(intelligentFormula.new_formula) && intelligentFormula.new_formula.length) {
                    builderState.labsFormula = intelligentFormula.new_formula;
                }
                builderState.labsSummary = intelligentFormula.summary || {
                    compatibility_before: intelligentFormula.compatibility_before,
                    compatibility_after: intelligentFormula.compatibility_after,
                    optimization_focus: intelligentFormula.optimization_focus
                };
                builderState.labsMockup = intelligentFormula.mockup || null;
            }
            syncBuilderWithLabs();

            const ingredientCards = builderState.items.map((item, index) => {
                const alternatives = item.alternatives.length ? item.alternatives : [{ name: 'Mantener ingrediente original', reason: 'Sin alternativa disponible' }];
                const options = alternatives.map((alt, altIndex) => {
                    const optionValue = item.alternatives.length ? altIndex.toString() : '__original__';
                    const selectedAttr = (item.alternatives.length ? item.selectedIndex === altIndex : true) ? 'selected' : '';
                    const cleanName = (alt.name || alt || '').toString()
                        .replace(/\n/g, ' ')
                        .replace(/\s+/g, ' ')
                        .replace(/\(ej\.\s*/g, '')
                        .replace(/^\s*Alternativas naturales certificadas\s*:?\s*/i, '')
                        .trim();
                    const cleanReason = (alt.reason || '').toString()
                        .replace(/\n/g, ' ')
                        .replace(/\s+/g, ' ')
                        .trim();
                    const label = cleanName + (cleanReason ? ' â€” ' + escapeHtml(cleanReason) : '');
                    return `<option value="${optionValue}" ${selectedAttr}>${escapeHtml(label)}</option>`;
                }).join('');
                if (item.alternatives.length) {
                    const keepSelected = item.selectedIndex === '__original__' ? 'selected' : '';
                    const keepOption = `<option value="__original__" ${keepSelected}>Mantener ingrediente original</option>`;
                    return `
                        <div class="builder-card">
                            <h4>${escapeHtml(item.original)}</h4>
                            <p>${escapeHtml(item.description || 'Sustituye este ingrediente para reducir riesgos.')}</p>
                            <select onchange="handleBuilderSelection(${index}, this.value)">
                                ${keepOption}
                                ${options}
                            </select>
                        </div>
                    `;
                }
                return `
                    <div class="builder-card">
                        <h4>${escapeHtml(item.original)}</h4>
                        <p>${escapeHtml(item.description || 'Sustituye este ingrediente para reducir riesgos.')}</p>
                        <select onchange="handleBuilderSelection(${index}, this.value)">
                            ${options}
                        </select>
                    </div>
                `;
            }).join('');

            const body = `
                <p class="muted" style="margin-bottom:16px;">Estamos puliendo tu blend contigo. Elige sustitutos empÃ¡ticos con tu piel y nosotros nos encargamos del resto.</p>
                ${progressBadgesHtml}
                <div class="builder-grid">
                    ${ingredientCards}
                </div>
                <div class="builder-summary" id="builderSummary"></div>
                <div class="builder-actions">
                    <button type="button" onclick="updateBuilderSummary('Resumen actualizado')">Actualizar resumen</button>
                    <button type="button" class="primary" onclick="submitCustomProduct()">Guardar y solicitar</button>
                </div>
            `;

            mount.innerHTML = buildCollapsibleCard({
                title: 'ðŸ§ª DiseÃ±a tu fÃ³rmula alternativa',
                subtitle: 'Sustituye ingredientes crÃ­ticos con mejores opciones.',
                bodyHtml: body
            });

            setStepStatus(4, 'completed');
            setStepStatus(5, 'active');
        }

        function extractDetectedIngredientNames(structuredReport) {
            if (!structuredReport) return [];
            const pool = [];
            if (Array.isArray(structuredReport.detected_ingredients)) {
                pool.push(...structuredReport.detected_ingredients);
            }
            if (Array.isArray(structuredReport?.ingredients_evaluated)) {
                structuredReport.ingredients_evaluated.forEach(item => {
                    pool.push(item.inci || item.ingredient || item.name);
                });
            }
            const safe = Array.isArray(structuredReport?.safety?.safe) ? structuredReport.safety.safe : [];
            const problematic = Array.isArray(structuredReport?.safety?.problematic) ? structuredReport.safety.problematic : [];
            safe.forEach(item => pool.push(item.ingredient || item.name));
            problematic.forEach(item => pool.push(item.ingredient || item.name));
            const baseFromFormula = extractBaseIngredientNamesFromFormula(structuredReport?.intelligent_formula);
            pool.push(...baseFromFormula);
            return uniqueStrings(pool).slice(0, 40);
        }

        function buildLabsProfilePayload(profile) {
            if (!profile || !Object.keys(profile).length) {
                return null;
            }
            const concerns = [
                ...(profile.concerns || []),
                ...(profile.skin_concerns || []),
                ...(profile.hair_concerns || [])
            ];
            const goals = profile.overall_goals || profile.goals || [];
            return {
                skin_type: profile.skin_type || null,
                hair_type: profile.hair_type || null,
                concerns: uniqueStrings(concerns),
                goals: uniqueStrings(goals)
            };
        }

        function buildLabsFormulationPlaceholder(structuredReport) {
            const detected = extractDetectedIngredientNames(structuredReport);
            if (!detected.length) {
                return '';
            }
            return `
                <div class="labs-card" id="labsFormulationMount">
                    <span class="lab-badge">Mommyshops Labs</span>
                    <h4>ðŸ§ª Estamos formulando tu producto inteligenteâ€¦</h4>
                    <p class="muted">Procesando ${detected.length} ingredientes para elevar tu compatibilidad.</p>
                    <div class="labs-progress">
                        <div class="spinner"></div>
                        <span>Preparando blend personalizadoâ€¦</span>
                    </div>
                </div>
            `;
        }

        function renderLabsLoadingContent(baseIngredients) {
            const baseList = baseIngredients.slice(0, 6).map(name => (
                `<li class="ingredient-chip ingredient-chip--base">${escapeHtml(name)}</li>`
            )).join('');
            return `
                <span class="lab-badge">Mommyshops Labs</span>
                <h4>ðŸ§ª Tu fÃ³rmula estÃ¡ calculÃ¡ndose en tiempo realâ€¦</h4>
                <p class="muted">Identificando activos, compatibilidad y sustituciones seguras.</p>
                <div class="ingredient-columns">
                    <div>
                        <h5>Base analizada</h5>
                        <ul class="ingredient-list">
                            ${baseList || '<li class="ingredient-chip ingredient-chip--base">Identificando ingredientesâ€¦</li>'}
                        </ul>
                    </div>
                    <div>
                        <h5>Nuestros sustitutos</h5>
                        <p class="muted">Buscando activos optimizadosâ€¦</p>
                    </div>
                </div>
                <div class="labs-progress">
                    <div class="spinner"></div>
                    <span>Aplicando reglas OMS / FDA / CIRâ€¦</span>
                </div>
            `;
        }

        function renderLabsFormulationCard(mount, payload, baseIngredients = []) {
            if (!mount) return;
            if (!payload) {
                renderLabsFormulationError(mount, 'Respuesta incompleta del laboratorio.');
                return;
            }
            const source = payload.intelligent_formula || payload;
            const summary = source.summary || payload.summary || {};
            const eta = source.delivery?.estimated_time
                || summary.delivery_eta
                || (payload.mockup && payload.mockup.eta_days)
                || '5-7 dÃ­as hÃ¡biles';
            const baseFromPayload = extractBaseIngredientNamesFromFormula(source);
            const basePool = baseFromPayload.length ? baseFromPayload : baseIngredients;
            const originalIngredients = basePool.length
                ? basePool.map(name => ({ name, status: 'keep' }))
                : (Array.isArray(source.original_ingredients) ? source.original_ingredients : []);
            const goalImpact = source.compatibility_by_goal || summary.compatibility_by_goal || [];
            const focusLabel = source.optimization_focus || summary.profile_hint || 'tu rutina';
            const replacementsData = Array.isArray(source.replacements) && source.replacements.length
                ? source.replacements
                : (Array.isArray(source.substitutions) ? source.substitutions.map(sub => ({
                    from: { inci: sub.for || sub.original },
                    to: { inci: sub.alternatives?.[0]?.name, reason: sub.alternatives?.[0]?.reason }
                })) : []);

            const statusClass = status => {
                const value = (status || '').toString().toLowerCase();
                if (['sustituir', 'replace', 'warning', 'conflict'].includes(value)) return 'labs-base-chip labs-base-chip--warning';
                return 'labs-base-chip labs-base-chip--safe';
            };

            let baseListHtml = originalIngredients
                .map(item => {
                    const name = typeof item === 'string' ? item : (item.name || item.inci || item.ingredient || '');
                    const note = typeof item === 'string' ? '' : (item.note || '');
                    const status = typeof item === 'string' ? 'keep' : item.status;
                    return `<li class="${statusClass(status)}" title="${escapeHtml(note)}">${escapeHtml(name)}</li>`;
                })
                .join('');
            if (!baseListHtml) {
                baseListHtml = '<li class="labs-base-chip labs-base-chip--safe">Sin ingredientes detectados</li>';
            }

            const formulaList = Array.isArray(source.new_formula) ? source.new_formula : [];
            const ingredientCount = basePool.length;
            const substitutesCount = formulaList.length;
            const keptCount = Math.max(ingredientCount - substitutesCount, 0);
            // CÃ¡lculo: (detected ingredients - substitutes) / detected ingredients
            const compatibility = ingredientCount > 0 ? Math.round(((ingredientCount - substitutesCount) / ingredientCount) * 100) : 0;
            const gaugeValue = Math.max(0, Math.min(compatibility, 100));
            const substituteCards = formulaList.length
                ? formulaList.map(item => {
                    const tagHtml = item.function_tags && item.function_tags.length
                        ? `<div class="labs-substitute-tags">${item.function_tags.map(tag => `<span>${escapeHtml(tag)}</span>`).join('')}</div>`
                        : '';
                    return `
                        <div class="labs-substitute-card">
                            <div class="labs-substitute-head">
                                <strong>${escapeHtml(item.inci || item.name || 'Activo Mommyshops')}</strong>
                            </div>
                            <p class="muted">${escapeHtml(item.reason || 'Activo recomendado por Mommyshops Labs')}</p>
                            ${tagHtml}
                        </div>
                    `;
                }).join('')
                : '<p class="muted">AÃºn estamos preparando los sustitutos ideales.</p>';

            const impactTable = goalImpact.length
                ? `
                    <table class="labs-impact-table">
                        <thead>
                            <tr><th>Objetivo</th><th>Antes</th><th>DespuÃ©s</th></tr>
                        </thead>
                        <tbody>
                            ${goalImpact.map(goal => {
                                const before = scoreToPercent(goal.before ?? goal.percent_before ?? goal.compatibility_before ?? goal.percent) ?? 0;
                                const after = scoreToPercent(goal.after ?? goal.percent_after ?? goal.compatibility_after ?? goal.percent) ?? 0;
                                return `<tr><td>${escapeHtml(goal.name || goal.goal || 'Objetivo')}</td><td>${before}%</td><td>${after}%</td></tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `
                : '';

            const replacementsHtml = replacementsData.length
                ? `<div class="labs-replacements">
                        ${replacementsData.map(rep => {
                            const from = rep.from?.inci || rep.from || rep.for || 'Ingrediente a reemplazar';
                            const to = rep.to?.inci || rep.suggested || rep.to?.name || 'Sustituto recomendado';
                            const reason = buildReplacementReason(rep.to) || rep.reason || 'OptimizaciÃ³n recomendada por Mommyshops.';
                            const usage = rep.to?.usage_range ? `Uso sugerido: ${rep.to.usage_range}` : '';
                            const deltaRaw = rep.to?.delta_global ?? rep.delta_global ?? rep.to?.delta_compatibility ?? rep.delta_compatibility;
                            const deltaValue = scoreToPercent(deltaRaw);
                            const deltaText = (deltaValue == null || deltaValue === 0) ? '' : `${deltaValue > 0 ? '+' : ''}${deltaValue}% compatibilidad`;
                            const detail = [usage, deltaText].filter(Boolean).join(' Â· ');
                            return `
                                <div class="labs-replacement-card">
                                    <strong>âŒ ${escapeHtml(from)}</strong>
                                    <p>${escapeHtml(reason)}</p>
                                    <strong>âœ… ${escapeHtml(to)}</strong>
                                    <p>${escapeHtml(detail)}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>`
                : '';

            const variantLabel = summary.variant_label || titleCase(summary.variant || source.variant || source.mode || 'Mommyshops Labs');

            mount.innerHTML = `
                <div class="labs-result-card">
                    <div class="labs-result-header">
                        <div>
                            <span class="lab-badge">${escapeHtml(variantLabel)}</span>
                            <h4>ðŸ§ª Tu fÃ³rmula inteligente estÃ¡ lista.</h4>
                            <p class="muted">Optimizada para ${escapeHtml(focusLabel)}. Procesamos ${ingredientCount} ingredientes y recomendamos ${substitutesCount} sustitutos. Compatibilidad estimada: ${compatibility}%.</p>
                        </div>
                        <div class="labs-gauge" style="--gauge-value:${gaugeValue}">
                            <span>${compatibility}%</span>
                            <small>Compatibilidad</small>
                        </div>
                    </div>
                    ${impactTable}
                    ${replacementsHtml}
                    <div class="labs-result-body">
                        <div class="labs-base">
                            <h5>Ingredientes producto</h5>
                            <ul class="labs-base-chips">
                                ${baseListHtml}
                            </ul>
                        </div>
                        <div class="labs-substitutes">
                            <h5>Sustitutos recomendados</h5>
                            ${substituteCards}
                        </div>
                    </div>
                    <div class="labs-result-footer">
                        <p class="muted">Entrega estimada en ${escapeHtml(eta)} Â· producido bajo estÃ¡ndares OMS/FDA/CIR.</p>
                        <button class="cta-buy" type="button" onclick="submitCustomProduct()">
                            Solicitar blend Mommyshops
                        </button>
                    </div>
                </div>
            `;
        }

        function renderLabsFormulationError(mount, message) {
            mount.innerHTML = `
                <span class="lab-badge">Mommyshops Labs</span>
                <h4>No pudimos terminar la formulaciÃ³n.</h4>
                <p class="muted">${escapeHtml(message || 'Intenta nuevamente mÃ¡s tarde o ajusta tus ingredientes.')}</p>
            `;
        }

        function syncBuilderWithLabs() {
            if (!builderState) return;
            const labsResult = labsFormulationState.lastResult;
            if (!labsResult) return;
            const source = labsResult.intelligent_formula || labsResult;
            if (Array.isArray(source.new_formula) && source.new_formula.length) {
                builderState.labsFormula = source.new_formula;
            }
            builderState.labsSummary = source.summary || builderState.labsSummary || {
                compatibility_before: source.compatibility_before,
                compatibility_after: source.compatibility_after,
                optimization_focus: source.optimization_focus
            };
            builderState.labsMockup = source.mockup || labsResult.mockup || builderState.labsMockup || null;
        }

        async function triggerLabsFormulation(structuredReport, profile, fallbackProductName) {
            const mount = document.getElementById('labsFormulationMount');
            if (!mount || !structuredReport) {
                return;
            }
            const baseIngredients = extractDetectedIngredientNames(structuredReport);
            if (!baseIngredients.length) {
                mount.innerHTML = `
                    <span class="lab-badge">Mommyshops Labs</span>
                    <h4>Necesitamos la lista de ingredientes para formular.</h4>
                    <p class="muted">Carga una foto o pega el INCI para continuar.</p>
                `;
                return;
            }

            const payload = {
                ingredients_detected: baseIngredients,
                product_name: structuredReport.product_name || fallbackProductName || 'Producto analizado',
            };
            const profilePayload = buildLabsProfilePayload(profile);
            if (profilePayload) {
                payload.profile = profilePayload;
            }
            if (profile && profile.hair_type && profile.hair_type.toLowerCase() === 'rizado') {
                payload.variant = 'botanical';
            }
            if (!payload.profile) {
                delete payload.profile;
            }
            if (!payload.variant) {
                delete payload.variant;
            }

            const payloadKey = JSON.stringify(payload);
            if (labsFormulationState.lastPayloadKey === payloadKey) {
                return;
            }
            labsFormulationState.lastPayloadKey = payloadKey;

            if (labsFormulationState.controller) {
                labsFormulationState.controller.abort();
            }
            const controller = new AbortController();
            labsFormulationState.controller = controller;
            mount.innerHTML = renderLabsLoadingContent(baseIngredients);

            try {
                const response = await fetch(`${API_BASE}/formulate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }
                const data = await response.json();
                labsFormulationState.lastResult = data;
                syncBuilderWithLabs();
                renderLabsFormulationCard(mount, data, baseIngredients);
            } catch (error) {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Mommyshops Labs error:', error);
                renderLabsFormulationError(mount, error.message || 'No pudimos generar la fÃ³rmula.');
                labsFormulationState.lastResult = null;
            } finally {
                if (labsFormulationState.controller === controller) {
                    labsFormulationState.controller = null;
                }
            }
        }
        function updateBuilderSummary(message) {
            if (!builderState) return;
            const summaryElement = document.getElementById('builderSummary');
            if (!summaryElement) return;

            const selections = builderState.items.map(item => {
                if (item.selectedIndex === '__original__' || item.alternatives.length === 0) {
                    return {
                        original: item.original,
                        selected: item.original,
                        reason: 'Se mantiene el ingrediente original',
                    };
                }
                const alt = item.alternatives[item.selectedIndex] || {};
                // Clean substitute name and reason: remove newlines, extra spaces, and generic prefixes
                const cleanName = (alt.name || item.original || '').toString()
                    .replace(/\n/g, ' ')
                    .replace(/\s+/g, ' ')
                    .replace(/\(ej\.\s*/g, '') // Remove "ej." prefix
                    .replace(/^\s*Alternativas naturales certificadas\s*:?\s*/i, '') // Remove generic prefix
                    .trim()
                    .substring(0, 100); // Limit length
                
                const cleanReason = (alt.reason || 'Alternativa recomendada').toString()
                    .replace(/\n/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .substring(0, 150); // Limit length
                
                return {
                    original: item.original,
                    selected: cleanName || item.original,
                    reason: cleanReason || 'Alternativa recomendada',
                };
            });

            const substitutionCount = selections.filter(sel => sel.original !== sel.selected).length;
            const estimatedPrice = (28 + substitutionCount * 5 + builderState.safeIngredients.length * 1.5).toFixed(2);

            const safeListHtml = builderState.safeIngredients.length
                ? `<p style="margin-top:8px;"><strong>Base saludable:</strong> ${builderState.safeIngredients.join(', ')}</p>`
                : '';

            const substitutionListHtml = selections.map(sel => `<li><strong>${escapeHtml(sel.original)} â†’ ${escapeHtml(sel.selected)}</strong><br/><span style="color:#4b5563;">${escapeHtml(sel.reason)}</span></li>`).join('');

            summaryElement.innerHTML = `
                <h4 style="margin-bottom:8px; color:#4c1d95;">Tu blend consciente</h4>
                <p style="margin-bottom:12px;">InversiÃ³n estimada: <strong>$${estimatedPrice} USD</strong> Â· incluye acompaÃ±amiento Mommyshops.</p>
                <div class="progress-badges">
                    <span class="progress-badge">âœ¨ Personalizado</span>
                    <span class="progress-badge">ðŸ§ª Validado por Labs</span>
                    <span class="progress-badge">ðŸ’¬ Seguimiento humano</span>
                </div>
                ${safeListHtml}
                <ul style="margin-top:12px; list-style: disc; padding-left:20px;">
                    ${substitutionListHtml}
                </ul>
                ${message ? `<p style="margin-top:12px; color:#059669; font-weight:600;">${escapeHtml(message)}</p>` : ''}
            `;
        }

        async function submitCustomProduct() {
            if (!builderState) {
                alert('Necesitamos un anÃ¡lisis activo para preparar tu blend. Escanea o carga tu INCI primero ðŸ’œ.');
                return;
            }

            const profile = builderState.profile || getProfileForRequest();
            const substitutions = builderState.items.map(item => {
                if (item.selectedIndex === '__original__' || item.alternatives.length === 0) {
                    return {
                        original: item.original,
                        selected: item.original,
                        reason: 'Se mantiene el ingrediente original',
                    };
                }
                const alt = item.alternatives[item.selectedIndex] || {};
                return {
                    original: item.original,
                    selected: alt.name || item.original,
                    reason: alt.reason || 'Alternativa recomendada',
                };
            });

            const payload = {
                base_product_name: builderState.baseProductName,
                safe_ingredients: builderState.safeIngredients || [],
                substitutions,
                profile,
            };

            const labsPayloadSource = builderState.labsFormula && builderState.labsFormula.length
                ? builderState
                : (labsFormulationState.lastResult ? labsFormulationState.lastResult : null);

            if (labsPayloadSource && labsPayloadSource.labsFormula ? labsPayloadSource.labsFormula.length : (labsPayloadSource.new_formula || []).length) {
                const formulaList = labsPayloadSource.labsFormula || labsPayloadSource.new_formula || [];
                payload.labs_formula = formulaList;
                const labsSummary = labsPayloadSource.labsSummary || labsPayloadSource.summary || null;
                const labsMockup = labsPayloadSource.labsMockup || labsPayloadSource.mockup || null;
                if (labsSummary) {
                    payload.labs_summary = labsSummary;
                }
                if (labsMockup) {
                    payload.labs_mockup = labsMockup;
                }
            }

            try {
                const response = await fetch(`${API_BASE}/builder/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        updateBuilderSummary('Inicia sesiÃ³n para que podamos resguardar tu blend y enviarte actualizaciones.');
                        setStepStatus(5, 'active');
                        setStepStatus(6, 'pending');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const priceValue = Number(data.price);
                const priceText = Number.isFinite(priceValue) ? priceValue.toFixed(2) : data.price;
                const message = `ðŸŽ‰ Guardamos tu blend ($${priceText} USD). ID #${data.id} â€” te acompaÃ±amos en cada ajuste.`;
                updateBuilderSummary(message);
                setStepStatus(5, 'completed');
                setStepStatus(6, 'completed');
            } catch (error) {
                console.error('Error creating custom product', error);
                alert('Nuestro laboratorio tuvo un inconveniente. Intenta otra vez en unos segundos o escrÃ­benos para ayudarte.');
                setStepStatus(6, 'pending');
            }
        }
        
        window.switchTab = function switchTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        function previewImage(input) {
            if (input && input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="Preview" style="max-width: 100%; max-height: 300px; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
                    }
                };
                reader.onerror = function() {
                    console.error('Error reading file');
                    const preview = document.getElementById('imagePreview');
                    if (preview) {
                        preview.innerHTML = '<p style="color: red; margin-top: 10px;">Error al cargar la imagen</p>';
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Initialize image preview on file selection
        function initializeImageInput() {
            const imageInputEl = document.getElementById('imageInput');
            if (imageInputEl) {
                imageInputEl.addEventListener('change', function(e) {
                    previewImage(this);
                });
                console.log('Image input initialized');
                } else {
                console.warn('imageInput element not found');
            }
        }

        // Make functions globally available for onclick handlers
        window.analyzeImage = async function analyzeImage() {
            const fileInput = document.getElementById('imageInput');
            const productNameEl = document.getElementById('productName');
            const productName = (productNameEl && productNameEl.value) ? productNameEl.value : 'Unknown Product';
            const userNeedEl = document.getElementById('userNeed');
            const userNeed = (userNeedEl && userNeedEl.value) ? userNeedEl.value : null;
            const profile = getProfileForRequest();

            setCurrentProductType(userNeed);

            if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                alert('Por favor selecciona una imagen primero.');
                return;
            }
            const file = fileInput.files[0];
            const allowedMime = ['image/jpeg', 'image/png', 'image/webp'];
            const nameLower = (file.name || '').toLowerCase();
            const isHeic = nameLower.endsWith('.heic') || file.type === 'image/heic' || file.type === 'image/heif';
            const isPdf = nameLower.endsWith('.pdf') || file.type === 'application/pdf';
            if (!allowedMime.includes(file.type) || isHeic || isPdf) {
                alert('Formato no permitido. Usa .jpg, .jpeg, .png o .webp.\nSugerencia: si tu foto es HEIC (iPhone), conviÃ©rtela a JPG/PNG antes de subirla.');
                return;
            }
            
            // Profile is optional - allow analysis without it but show a gentle reminder
            if (!profile) {
                const proceed = confirm('ðŸ’¡ Tip: Completa tu perfil para obtener recomendaciones personalizadas.\n\nÂ¿Deseas continuar sin perfil?');
                if (!proceed) {
                    openProfileWizard();
                    return;
                }
            }

            showLoading();
            setStepStatus(2, 'completed');
            setStepStatus(3, 'active');
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('product_name', productName);
            if (userNeed) {
            formData.append('user_need', userNeed);
            }
            if (profile && Object.keys(profile).length > 0) {
                formData.append('profile', JSON.stringify(profile));
            }

            try {
                console.log('Sending image analysis request to:', `${API_BASE}/analysis/image`);
                const response = await fetch(`${API_BASE}/analysis/image`, {
                    method: 'POST',
                    body: formData,
                    // Don't set Content-Type header - let browser set it with boundary for multipart/form-data
                });

                console.log('Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    // Provide friendlier guidance on common OCR failure
                    if (response.status === 400 && /Could not extract text from image/i.test(errorText)) {
                        const tips = [
                            'Verifica que la foto estÃ© enfocada y con buena iluminaciÃ³n.',
                            'AsegÃºrate de que toda la lista de ingredientes sea legible (sin cortes/reflejos).',
                            'Evita Ã¡ngulos inclinados; toma la foto perpendicular a la etiqueta.',
                            'Si puedes, convierte a texto y usa la pestaÃ±a â€œText Analysisâ€.'
                        ];
                        showError('No pudimos leer el texto de la imagen. ' + tips.join(' '));
                        // Sugerir pasar a pestaÃ±a de texto
                        setTimeout(() => { if (typeof window.switchTab === 'function') window.switchTab('text'); }, 50);
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }

                    console.log('Analysis result received:', result);
                    showResults(result);
                } else {
                    // Si no es JSON, puede ser HTML (error de Vercel)
                    const text = await response.text();
                    if (text.includes('ROUTER_EXTERNAL_TARGET_ERROR') || text.includes('<!DOCTYPE html>')) {
                        throw new Error('El servidor backend no estÃ¡ disponible temporalmente. Por favor, intenta de nuevo en unos momentos.');
                    }
                    throw new Error(`Respuesta inesperada del servidor (${response.status})`);
                }
            } catch (error) {
                console.error('Image analysis error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                if (!/Could not extract text from image/i.test(error?.message || '')) {
                    showError('Error al analizar imagen: ' + error.message);
                }
            }
        }

        window.analyzeText = async function analyzeText() {
            const ingredientText = document.getElementById('ingredientText');
            if (!ingredientText) {
                console.error('ingredientText element not found');
                return;
            }
            
            const textValue = ingredientText.value || '';
            const productName = document.getElementById('textProductName');
            const productNameValue = (productName && productName.value) ? productName.value : 'Unknown Product';
            const userNeedEl = document.getElementById('textUserNeed');
            const userNeed = (userNeedEl && userNeedEl.value) ? userNeedEl.value : null;
            const profile = getProfileForRequest();

            setCurrentProductType(userNeed);

            if (!textValue.trim()) {
                alert('Por favor ingresa la lista de ingredientes primero.');
                return;
            }
            
            // Profile is optional - allow analysis without it but show a gentle reminder
            if (!profile) {
                const proceed = confirm('ðŸ’¡ Tip: Completa tu perfil para obtener recomendaciones personalizadas.\n\nÂ¿Deseas continuar sin perfil?');
                if (!proceed) {
                    openProfileWizard();
                    return;
                }
            }

            showLoading();
            setStepStatus(2, 'completed');
            setStepStatus(3, 'active');

            try {
                const requestBody = {
                    text: textValue,
                    product_name: productNameValue
                };
                if (userNeed) {
                    requestBody.user_need = userNeed;
                }
                if (profile && Object.keys(profile).length > 0) {
                    requestBody.profile = profile;
                }
                
                console.log('Sending text analysis request to:', `${API_BASE}/analysis/text`);
                console.log('Request body:', requestBody);
                
                const response = await fetch(`${API_BASE}/analysis/text`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    // Detectar si Vercel devolviÃ³ HTML (error de router)
                    if (errorText.includes('ROUTER_EXTERNAL_TARGET_ERROR') || errorText.includes('<!DOCTYPE html>')) {
                        throw new Error('El servidor backend no estÃ¡ disponible temporalmente. Por favor, intenta de nuevo en unos momentos o verifica tu conexiÃ³n.');
                    }
                    
                    // Intentar parsear como JSON si parece JSON
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorJson.message || errorMessage;
                    } catch {
                        // Si no es JSON, usar el texto truncado
                        errorMessage = errorText.substring(0, 200);
                    }
                    throw new Error(errorMessage);
                }

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const result = await response.json();
                console.log('Analysis result received:', result);
                showResults(result);
            } catch (error) {
                console.error('Text analysis error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                showError('Error al analizar texto: ' + error.message);
            }
        }

        function showLoading() {
            document.getElementById('results').classList.add('show');
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
        }


        function showResults(result) {
            const loadingEl = document.getElementById('loading');
            const resultsContent = document.getElementById('resultsContent');
            
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
            if (!resultsContent) {
                return;
            }

            resultsContent.style.display = 'block';

            if (!result || !result.success) {
                const message = result && result.error ? result.error : 'Unknown error';
                    resultsContent.innerHTML = `
                    <div class="error">
                        âŒ Analysis failed: ${escapeHtml(message)}
                        </div>
                `;
                builderState = null;
                setStepStatus(3, 'active');
                setStepStatus(4, 'pending');
                return;
            }

            setStepStatus(3, 'completed');
            setStepStatus(4, 'active');
            labsFormulationState.lastPayloadKey = null;
            labsFormulationState.lastResult = null;

            let activeProfile = (result.profile && Object.keys(result.profile).length)
                ? result.profile
                : getStoredProfile();
            let profileCardHtml = renderProfileResult(activeProfile);

            if (result.structured_report) {
                const structuredReport = result.structured_report || {};
                if ((!activeProfile || !Object.keys(activeProfile || {}).length) && structuredReport.profile && Object.keys(structuredReport.profile).length) {
                    activeProfile = structuredReport.profile;
                    profileCardHtml = renderProfileResult(activeProfile);
                }
                const alignment = computeProfileIngredientAlignment(structuredReport, activeProfile);
                const inlineFormula = structuredReport.intelligent_formula || null;
                let labsPlaceholder = buildLabsFormulationPlaceholder(structuredReport);
                if (inlineFormula && !labsPlaceholder) {
                    labsPlaceholder = '<div class="labs-card" id="labsFormulationMount"></div>';
                }
                const sections = [
                    buildSummaryCard(structuredReport, result),
                    profileCardHtml,
                    result.extracted_text ? buildExtractedTextCard(result.extracted_text) : '',
                    buildIngredientsCard(structuredReport, activeProfile),
                    buildInsightsCard(structuredReport, result, activeProfile, alignment),
                    buildCompatibilityCard(structuredReport, alignment, activeProfile),
                    labsPlaceholder,
                ].filter(Boolean);

                resultsContent.innerHTML = `
                    <div class="success">âœ… Â¡AnÃ¡lisis completado! Personalizamos tus resultados.</div>
                    <div class="results-wrapper">
                        ${sections.join('\n')}
                        <div id="builderMount"></div>
                        </div>
                                `;

                renderProductBuilder(structuredReport, result, activeProfile);
                requestAnimationFrame(() => {
                    if (document.querySelector('[data-ingredient-filter]')) {
                        filterIngredientCards('all');
                    }
                });
                if (inlineFormula) {
                    labsFormulationState.lastResult = inlineFormula;
                    syncBuilderWithLabs();
                    const mount = document.getElementById('labsFormulationMount');
                    if (mount) {
                        const inlineBase = extractBaseIngredientNamesFromFormula(inlineFormula);
                        const fallbackBase = inlineBase.length ? inlineBase : extractDetectedIngredientNames(structuredReport);
                        renderLabsFormulationCard(mount, inlineFormula, fallbackBase);
                    }
                }
                const needsAsyncFormula = !inlineFormula || !(Array.isArray(inlineFormula.new_formula) && inlineFormula.new_formula.length);
                if (needsAsyncFormula) {
                    triggerLabsFormulation(structuredReport, activeProfile, result.product_name);
                }
                setupJourneyNavigation();
                return;
            }

            if (result.detailed_report) {
                const cards = parseDetailedReportToCards(result.detailed_report);
                const sections = [
                    buildFallbackResults(result, profileCardHtml),
                    result.extracted_text ? buildExtractedTextCard(result.extracted_text) : '',
                    ...cards,
                ].filter(Boolean);

                resultsContent.innerHTML = `
                    <div class="success">âœ… Analysis completed successfully!</div>
                    <div class="results-wrapper">
                        ${sections.join('\n')}
                    </div>
                `;
                builderState = null;
                setupJourneyNavigation();
                return;
            }

            const fallbackSections = [
                buildFallbackResults(result, profileCardHtml),
                result.extracted_text ? buildExtractedTextCard(result.extracted_text) : '',
            ].filter(Boolean);

                resultsContent.innerHTML = `
                <div class="success">âœ… Analysis completed successfully!</div>
                <div class="results-wrapper">
                    ${fallbackSections.join('\n')}
                    </div>
                `;
            builderState = null;
            setupJourneyNavigation();
            }
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'block';
            document.getElementById('resultsContent').innerHTML = `
                <div class="error">
                    âŒ ${message}
                </div>
            `;
        }

        function getIngredientClass(score) {
            if (score >= 80) return '';
            if (score >= 60) return 'warning';
            return 'danger';
        }

        function getScoreClass(score) {
            if (score >= 80) return '';
            if (score >= 60) return 'warning';
            return 'danger';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text == null ? '' : text;
            return div.innerHTML;
        }

        function parseDetailedReportToCards(detailedReport) {
            if (!detailedReport) return [];
            
            const cards = [];
            const lines = detailedReport.split('\n');
            let currentSection = null;
            let currentContent = [];
            
            function finishCurrentSection() {
                if (currentSection) {
                    cards.push(renderSectionCard(currentSection, currentContent.join('\n')));
                    currentSection = null;
                    currentContent = [];
                }
            }
            
            function renderSectionCard(title, content) {
                // Extract emoji and title text
                const titleMatch = title.match(/^(\*\*)(.*?)(\*\*)$/);
                const titleText = titleMatch ? titleMatch[2].trim() : title.replace(/\*\*/g, '').trim();
                
                // Parse content based on type
                let renderedContent = parseContentToHtml(content.trim());

                return buildCollapsibleCard({
                    title: escapeHtml(titleText),
                    bodyHtml: `<div style="line-height: 1.6;">${renderedContent}</div>`,
                    defaultOpen: /resumen/i.test(titleText)
                });
            }
            
            function parseContentToHtml(content) {
                if (!content) return '';
                
                let html = content;
                
                // Parse markdown tables - more robust parsing
                const tableRegex = /^\|(.+)\|$/gm;
                const tableRows = [];
                let inTable = false;
                let tableContent = [];
                
                const lines = html.split('\n');
                const processedLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const isTableRow = /^\|.+?\|\s*$/.test(line);
                    const isSeparator = /^\|[\s\-:]+\|\s*$/.test(line);
                    
                    if (isSeparator) {
                        // Skip separator row
                        continue;
                    } else if (isTableRow) {
                        if (!inTable) {
                            inTable = true;
                            tableContent = [];
                        }
                        const cells = line.split('|').map(c => c.trim()).filter(c => c);
                        if (cells.length > 0) {
                            tableContent.push(cells);
                        }
                    } else {
                        if (inTable && tableContent.length > 0) {
                            // Render accumulated table
                            let tableHtml = '<table style="width:100%; border-collapse: collapse; margin: 15px 0; background: white; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">';
                            
                            // First row is header if it contains "Ingrediente" or "Producto"
                            const isHeaderRow = tableContent.length > 0 && 
                                (tableContent[0].some(cell => cell.includes('Ingrediente') || cell.includes('Producto') || cell.includes('EWG') || cell.includes('Eco-Friendly')));
                            
                            tableContent.forEach((row, idx) => {
                                const isHeader = isHeaderRow && idx === 0;
                                tableHtml += '<tr>';
                                row.forEach(cell => {
                                    if (isHeader) {
                                        tableHtml += `<th style="text-align:left; border-bottom:2px solid #A855F7; padding:12px; background:linear-gradient(135deg, #f8f9fa, #f1f3f5); font-weight:600; color:#333;">${escapeHtml(cell)}</th>`;
                                    } else {
                                        tableHtml += `<td style="padding:12px; border-bottom:1px solid #e9ecef; vertical-align:top;">${escapeHtml(cell)}</td>`;
                                    }
                                });
                                tableHtml += '</tr>';
                            });
                            
                            tableHtml += '</table>';
                            processedLines.push(tableHtml);
                            tableContent = [];
                        }
                        inTable = false;
                        processedLines.push(line);
                    }
                }
                
                // Handle table at end of content
                if (inTable && tableContent.length > 0) {
                    let tableHtml = '<table style="width:100%; border-collapse: collapse; margin: 15px 0; background: white; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">';
                    const isHeaderRow = tableContent.length > 0 && 
                        (tableContent[0].some(cell => cell.includes('Ingrediente') || cell.includes('Producto') || cell.includes('EWG') || cell.includes('Eco-Friendly')));
                    
                    tableContent.forEach((row, idx) => {
                        const isHeader = isHeaderRow && idx === 0;
                        tableHtml += '<tr>';
                        row.forEach(cell => {
                            if (isHeader) {
                                tableHtml += `<th style="text-align:left; border-bottom:2px solid #A855F7; padding:12px; background:linear-gradient(135deg, #f8f9fa, #f1f3f5); font-weight:600; color:#333;">${escapeHtml(cell)}</th>`;
                            } else {
                                tableHtml += `<td style="padding:12px; border-bottom:1px solid #e9ecef; vertical-align:top;">${escapeHtml(cell)}</td>`;
                            }
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</table>';
                    processedLines.push(tableHtml);
                }
                
                html = processedLines.join('\n');
                
                // Parse bold text (but preserve existing HTML tags)
                html = html.replace(/\*\*([^*]+)\*\*/g, '<strong style="color: #A855F7; font-weight: 700;">$1</strong>');
                
                // Style subsections like "**Para Sodium Lauryl Sulfate (SLS):**"
                html = html.replace(/<strong style="color: #A855F7; font-weight: 700;">Para (.+?):<\/strong>/g, 
                    '<div style="margin-top: 16px; margin-bottom: 8px;"><strong style="color: #8B5CF6; font-weight: 700; font-size: 1.05em;">Para $1:</strong></div>');
                
                // Parse bullet lists (â€¢ bullets)
                html = html.replace(/^â€¢ (.+)$/gm, 'â€¢BULLETâ€¢$1â€¢ENDBULLETâ€¢');
                // Group consecutive bullets
                html = html.replace(/(â€¢BULLETâ€¢.*?â€¢ENDBULLETâ€¢(?:\s*â€¢BULLETâ€¢.*?â€¢ENDBULLETâ€¢)*)/gs, (match) => {
                    const items = match.match(/â€¢BULLETâ€¢(.*?)â€¢ENDBULLETâ€¢/g).map(item => 
                        item.replace(/â€¢BULLETâ€¢(.*?)â€¢ENDBULLETâ€¢/, '<li style="margin: 8px 0; padding-left: 8px;">$1</li>')
                    );
                    return `<ul style="list-style: none; padding-left: 0; margin: 12px 0; line-height: 1.8;">${items.join('')}</ul>`;
                });
                
                // Parse numbered lists (like "1. ", "2. ")
                html = html.replace(/^(\d+)\.\s+(.+)$/gm, 'â€¢NUMBERâ€¢$1â€¢SEPâ€¢$2â€¢ENDNUMBERâ€¢');
                // Group consecutive numbered items
                html = html.replace(/(â€¢NUMBERâ€¢.*?â€¢ENDNUMBERâ€¢(?:\s*â€¢NUMBERâ€¢.*?â€¢ENDNUMBERâ€¢)*)/gs, (match) => {
                    const items = match.match(/â€¢NUMBERâ€¢(\d+)â€¢SEPâ€¢(.*?)â€¢ENDNUMBERâ€¢/g).map(item => 
                        item.replace(/â€¢NUMBERâ€¢\d+â€¢SEPâ€¢(.*?)â€¢ENDNUMBERâ€¢/, '<li style="margin: 8px 0; padding-left: 8px;">$1</li>')
                    );
                    return `<ol style="padding-left: 20px; margin: 12px 0; line-height: 1.8;">${items.join('')}</ol>`;
                });
                
                // Parse italics
                html = html.replace(/_(.+?)_/g, '<em>$1</em>');
                
                // Convert remaining line breaks to paragraphs (but preserve HTML blocks)
                const finalLines = html.split('\n');
                const finalProcessed = [];
                let currentParagraph = [];
                
                for (let i = 0; i < finalLines.length; i++) {
                    const line = finalLines[i].trim();
                    
                    if (!line) {
                        if (currentParagraph.length > 0) {
                            const paraText = currentParagraph.join(' ');
                            if (paraText && !paraText.startsWith('<')) {
                                finalProcessed.push(`<p style="margin: 12px 0; line-height: 1.6;">${paraText}</p>`);
                            } else if (paraText.startsWith('<')) {
                                finalProcessed.push(paraText);
                            }
                            currentParagraph = [];
                        }
                        continue;
                    }
                    
                    // If it's already HTML, add it directly
                    if (line.startsWith('<') || line.match(/^<[^>]+>/)) {
                        if (currentParagraph.length > 0) {
                            const paraText = currentParagraph.join(' ');
                            if (paraText) {
                                finalProcessed.push(`<p style="margin: 12px 0; line-height: 1.6;">${paraText}</p>`);
                            }
                            currentParagraph = [];
                        }
                        finalProcessed.push(line);
                    } else {
                        currentParagraph.push(line);
                    }
                }
                
                // Handle remaining paragraph
                if (currentParagraph.length > 0) {
                    const paraText = currentParagraph.join(' ');
                    if (paraText) {
                        finalProcessed.push(`<p style="margin: 12px 0; line-height: 1.6;">${paraText}</p>`);
                    }
                }
                
                html = finalProcessed.join('\n');
                
                // Clean up empty paragraphs
                html = html.replace(/<p style="margin: 12px 0; line-height: 1\.6;"><\/p>/g, '');
                
                // Add special styling for product substitute sections (numbered products like "1. BÃ¡lsamo Facial...")
                html = html.replace(/(<strong style="color: #A855F7; font-weight: 700;">(\d+)\. (.+?)<\/strong>)/g, 
                    (match, full, num, name) => {
                        return `<div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #f8f9fa, #f1f3f5); border-left: 4px solid #A855F7; border-radius: 8px; margin-bottom: 12px;"><strong style="color: #A855F7; font-weight: 700; font-size: 1.1em;">${num}. ${name}</strong></div>`;
                    });
                
                return html || content; // Fallback to original if parsing fails
            }
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Detect section headers (lines starting with **)
                if (line.startsWith('**') && line.endsWith('**')) {
                    finishCurrentSection();
                    currentSection = line;
                } else if (line === '---') {
                    // Separator, finish current section
                    finishCurrentSection();
                } else if (currentSection) {
                    currentContent.push(line);
                } else if (!currentSection && line) {
                    // Content before first section
                    currentContent.push(line);
                }
            }
            
            // Finish last section
            finishCurrentSection();
            
            return cards;
        }

        // Initialize everything when DOM is ready
        function initializeApp() {
            console.log('Initializing app...');
            setupSignupForm();
            
            // Initialize image input
            initializeImageInput();

            setupProductTypeListeners();
            
            // Initialize journey steps
            initializeJourneySteps();
            
            // Ensure profile is ready
            ensureProfileReady();
        }

        // Check API health on page load
        window.addEventListener('load', async () => {
            // Initialize app components
            initializeApp();
            
            try {
                // Try with trailing slash first, then without
                let response = await fetch(`${API_BASE}/health/`);
                if (!response.ok && response.status === 404) {
                    response = await fetch(`${API_BASE}/health`);
                }
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const health = await response.json();
                console.log('API Health:', health);
            } catch (error) {
                // Only log error, don't show alert - API might be available but CORS or network issue
                console.warn('API health check failed (this is normal if backend is starting):', error.message);
                // Don't show alert - let the user try to use the app anyway
            }
        });
        
        // Also initialize when DOM is ready (for faster initialization)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM already loaded
            initializeApp();
        }
    </script>

    <div class="profile-toast" id="profileToast">Perfil actualizado ðŸ’œ</div>

    <div class="profile-wizard-backdrop" id="profileWizard" aria-hidden="true">
        <div class="profile-wizard" role="dialog" aria-modal="true" aria-labelledby="profileWizardTitle">
            <button type="button" class="wizard-close" onclick="closeProfileWizard()">Ã—</button>
            <div class="wizard-progress" id="profileWizardProgress">Paso 1 de 3</div>
            <h3 id="profileWizardTitle">ðŸ‘‹ Vamos a crear tu perfil</h3>
            <p class="muted">Responde brevemente y personalizaremos cada anÃ¡lisis.</p>

            <div class="wizard-step is-active" data-step="1">
                <h4>ðŸ’†â€â™€ï¸ Â¿CÃ³mo describirÃ­as tu piel?</h4>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="skin_type" data-value="seca" data-mode="single" onclick="handleWizardChip(this)">ðŸŒ¾ Seca</button>
                    <button type="button" class="wizard-chip" data-field="skin_type" data-value="grasa" data-mode="single" onclick="handleWizardChip(this)">ðŸŒ¿ Grasa</button>
                    <button type="button" class="wizard-chip" data-field="skin_type" data-value="mixta" data-mode="single" onclick="handleWizardChip(this)">âš–ï¸ Mixta</button>
                    <button type="button" class="wizard-chip" data-field="skin_type" data-value="sensitiva" data-mode="single" onclick="handleWizardChip(this)">ðŸ’– Sensible</button>
                    <button type="button" class="wizard-chip" data-field="skin_type" data-value="normal" data-mode="single" onclick="handleWizardChip(this)">ðŸŒ¸ Normal</button>
                </div>
                <h4 style="margin-top:18px;">ðŸ“ Zonas prioritarias</h4>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="face_shape" data-value="Equilibrado en todo el rostro" data-mode="single" onclick="handleWizardChip(this)">âœ¨ Equilibrado</button>
                    <button type="button" class="wizard-chip" data-field="face_shape" data-value="Zona T grasa y mejillas secas" data-mode="single" onclick="handleWizardChip(this)">ðŸ”¶ Zona T grasa</button>
                    <button type="button" class="wizard-chip" data-field="face_shape" data-value="Mejillas sensibles o rojizas" data-mode="single" onclick="handleWizardChip(this)">ðŸŒº Mejillas sensibles</button>
                    <button type="button" class="wizard-chip" data-field="face_shape" data-value="Tendencia a manchas en pÃ³mulos" data-mode="single" onclick="handleWizardChip(this)">ðŸŒ¤ Manchas</button>
                    <button type="button" class="wizard-chip" data-field="face_shape" data-value="Contorno de ojos delicado" data-mode="single" onclick="handleWizardChip(this)">ðŸ‘ Contorno delicado</button>
                </div>
                <h4 style="margin-top:18px;">ðŸŒ¿ Â¿QuÃ© preocupa a tu piel?</h4>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="skin_concerns" data-value="sensibilidad" data-mode="multi" onclick="handleWizardChip(this)">ðŸ’– Sensibilidad</button>
                    <button type="button" class="wizard-chip" data-field="skin_concerns" data-value="acnÃ©" data-mode="multi" onclick="handleWizardChip(this)">ðŸŒ‹ AcnÃ© activo</button>
                    <button type="button" class="wizard-chip" data-field="skin_concerns" data-value="manchas" data-mode="multi" onclick="handleWizardChip(this)">ðŸŒ¤ Manchas</button>
                    <button type="button" class="wizard-chip" data-field="skin_concerns" data-value="poros" data-mode="multi" onclick="handleWizardChip(this)">âšª Poros</button>
                    <button type="button" class="wizard-chip" data-field="skin_concerns" data-value="arrugas" data-mode="multi" onclick="handleWizardChip(this)">â³ Arrugas</button>
                </div>
            </div>

            <div class="wizard-step" data-step="2">
                <h4>ðŸ’‡â€â™€ï¸ CuÃ©ntanos de tu cabello</h4>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="hair_type" data-value="liso" data-mode="single" onclick="handleWizardChip(this)">âœ¨ Liso</button>
                    <button type="button" class="wizard-chip" data-field="hair_type" data-value="ondulado" data-mode="single" onclick="handleWizardChip(this)">ðŸŒŠ Ondulado</button>
                    <button type="button" class="wizard-chip" data-field="hair_type" data-value="rizado" data-mode="single" onclick="handleWizardChip(this)">ðŸ’§ Rizado</button>
                    <button type="button" class="wizard-chip" data-field="hair_type" data-value="afro" data-mode="single" onclick="handleWizardChip(this)">ðŸŒ¿ Afro</button>
                    <button type="button" class="wizard-chip" data-field="hair_type" data-value="mixto" data-mode="single" onclick="handleWizardChip(this)">ðŸŽ€ Mixto</button>
                </div>
                <h4 style="margin-top:18px;">ðŸ’¥ Â¿QuÃ© te gustarÃ­a mejorar?</h4>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="hair_concerns" data-value="frizz" data-mode="multi" onclick="handleWizardChip(this)">âš¡ Frizz</button>
                    <button type="button" class="wizard-chip" data-field="hair_concerns" data-value="resequedad" data-mode="multi" onclick="handleWizardChip(this)">ðŸ’§ Resequedad</button>
                    <button type="button" class="wizard-chip" data-field="hair_concerns" data-value="caÃ­da" data-mode="multi" onclick="handleWizardChip(this)">ðŸƒ CaÃ­da</button>
                    <button type="button" class="wizard-chip" data-field="hair_concerns" data-value="caspa" data-mode="multi" onclick="handleWizardChip(this)">â„ï¸ Caspa</button>
                    <button type="button" class="wizard-chip" data-field="hair_concerns" data-value="falta de brillo" data-mode="multi" onclick="handleWizardChip(this)">âœ¨ Falta de brillo</button>
                </div>
            </div>

            <div class="wizard-step" data-step="3">
                <h4>ðŸŽ¯ Â¿QuÃ© objetivos quieres lograr?</h4>
                <p class="muted">Selecciona todos los que apliquen a tu rutina.</p>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="overall_goals" data-value="una rutina limpia" data-mode="multi" onclick="handleWizardChip(this)">ðŸ§¼ Rutina limpia</button>
                    <button type="button" class="wizard-chip" data-field="overall_goals" data-value="hidratar intensamente con vitaminas" data-mode="multi" onclick="handleWizardChip(this)">ðŸ’§ HidrataciÃ³n profunda</button>
                    <button type="button" class="wizard-chip" data-field="overall_goals" data-value="calmar inflamaciones activas" data-mode="multi" onclick="handleWizardChip(this)">ðŸŒ¿ Calmar inflamaciones</button>
                    <button type="button" class="wizard-chip" data-field="overall_goals" data-value="regular el exceso de grasa" data-mode="multi" onclick="handleWizardChip(this)">âš–ï¸ Control de grasa</button>
                    <button type="button" class="wizard-chip" data-field="overall_goals" data-value="sumar antioxidantes anti-edad" data-mode="multi" onclick="handleWizardChip(this)">âœ¨ Antioxidantes anti-edad</button>
                </div>
                <p class="muted" style="margin-top:16px;">Al guardar, tus anÃ¡lisis se ajustarÃ¡n a estas necesidades.</p>
            </div>

            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" id="wizardPrevButton" onclick="prevProfileWizardStep()">AtrÃ¡s</button>
                <button type="button" class="btn btn-primary" id="wizardPrimaryButton" onclick="nextProfileWizardStep()">Siguiente</button>
            </div>
        </div>
    </div>

    <details class="sticky-assistant" id="assistPanel" role="complementary" aria-label="Asistente Mommyshops" open>
        <summary>
            <strong>Â¿Necesitas ayuda?</strong>
            <span>Â¿Necesitas ayuda en conocer mÃ¡s sobre tu rutina y productos de belleza?</span>
        </summary>
        <div class="assistant-actions">
            <button type="button" onclick="openSignupModal()">habla con mommyshops</button>
            <button type="button" onclick="collapseAssistPanel()">contraer panel</button>
        </div>
    </details>

    <div class="modal-backdrop" id="signupModal" aria-hidden="true">
        <div class="signup-modal" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
            <h3 id="signupTitle">InscrÃ­bete al laboratorio Mommyshops</h3>
            <p>DÃ©janos tus datos y te contactaremos con opciones personalizadas.</p>
            <form class="modal-form" id="signupForm">
                <div>
                    <label for="firstName">Nombre</label>
                    <input type="text" id="firstName" name="firstName" required>
                </div>
                <div>
                    <label for="lastName">Apellido</label>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
                <div>
                    <label for="email">Correo</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div>
                    <label for="phone">TelÃ©fono</label>
                    <input type="tel" id="phone" name="phone">
                </div>
                <div>
                    <label for="country">PaÃ­s</label>
                    <select id="country" name="country" required>
                        <option value="">Selecciona tu paÃ­s</option>
                        <option value="mx">MÃ©xico</option>
                        <option value="co">Colombia</option>
                        <option value="pe">PerÃº</option>
                        <option value="es">EspaÃ±a</option>
                        <option value="us">Estados Unidos</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSignupModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">inscribete ahora</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lottie && document.getElementById('heroLottie')) {
                window.lottie.loadAnimation({
                    container: document.getElementById('heroLottie'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'https://assets9.lottiefiles.com/private_files/lf30_dgfumnvn.json'
                });
            }
            // Persist open/closed state of assistant
            const assist = document.getElementById('assistPanel');
            if (assist) {
                const k = 'assist_open_state';
                const saved = localStorage.getItem(k);
                if (saved === 'false') assist.removeAttribute('open');
                if (saved === 'true') assist.setAttribute('open', '');
                assist.addEventListener('toggle', () => {
                    localStorage.setItem(k, assist.open ? 'true' : 'false');
                });
            }
        });
    </script>
</body>
</html>
