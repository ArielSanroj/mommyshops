<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MommyShops Labs - Análisis de Ingredientes para Bebés</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f6f6fb;
            --bg-hero: linear-gradient(120deg, #fdf8ff 0%, #f6f9ff 45%, #f9fffb 100%);
            --color-primary: #7C3AED;
            --color-primary-accent: #F472B6;
            --color-secondary: #FDB8C6;
            --color-dark: #0F172A;
            --color-muted: #6b7280;
            --color-card: #ffffff;
            --color-border: rgba(15, 23, 42, 0.08);
            --shadow-soft: 0 20px 45px rgba(15, 23, 42, 0.08);
            --shadow-strong: 0 35px 65px rgba(124, 58, 237, 0.16);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 0;
            color: var(--color-dark);
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        .site-nav {
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
            background: rgba(246, 246, 251, 0.96);
            border-bottom: 1px solid rgba(124, 58, 237, 0.08);
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 32px;
        }

        .nav-logo {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            font-weight: 600;
            color: var(--color-muted);
        }

        .nav-links a {
            padding: 8px 4px;
            position: relative;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            height: 2px;
            width: 100%;
            background: var(--color-primary);
            transform: scaleX(0);
            transform-origin: center;
            transition: transform 0.2s ease;
        }

        .nav-links a:hover::after {
            transform: scaleX(1);
        }

        .nav-cta {
            display: flex;
            gap: 12px;
        }

        .btn {
            border-radius: 999px;
            padding: 10px 20px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(120deg, #7C3AED, #EC4899);
            color: white;
            box-shadow: 0 15px 30px rgba(124, 58, 237, 0.25);
        }

        .btn-secondary {
            background: rgba(124, 58, 237, 0.08);
            color: var(--color-primary);
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .site-hero {
            background: var(--bg-hero);
            padding: 80px 24px 60px;
        }

        .hero-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 40px;
            align-items: center;
        }

        .hero-copy h1 {
            font-size: clamp(2rem, 4vw, 3.2rem);
            line-height: 1.1;
            margin-bottom: 18px;
        }

        .hero-copy p {
            font-size: 1.1rem;
            color: var(--color-muted);
            margin-bottom: 28px;
        }

        .hero-metrics {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .metric-card {
            background: #fff;
            border-radius: 18px;
            padding: 16px;
            flex: 1;
            min-width: 120px;
            box-shadow: var(--shadow-soft);
        }

        .metric-card strong {
            font-size: 1.8rem;
            display: block;
        }

        .hero-visual {
            background: linear-gradient(140deg, rgba(124, 58, 237, 0.08), rgba(14, 165, 233, 0.15));
            border-radius: 28px;
            padding: 28px;
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        .hero-visual::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 20%, rgba(252, 231, 243, 0.8), transparent 60%);
            pointer-events: none;
        }

        .hero-visual h3 {
            margin-bottom: 12px;
            color: var(--color-primary);
        }

        .hero-visual ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 10px;
        }

        .hero-visual li {
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 14px;
            border-radius: 14px;
            font-weight: 600;
        }

        .trust-bar {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            color: var(--color-muted);
            font-size: 0.9rem;
        }

        .trust-logos {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .trust-logos span {
            font-weight: 600;
            color: #94a3b8;
        }

        .site-section {
            padding: 60px 24px;
        }

        .journey-section {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 28px;
        }

        .journey-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .journey-card {
            background: var(--color-card);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--color-border);
            scroll-snap-align: start;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .journey-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-strong);
        }

        .journey-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            display: block;
            line-height: 1;
        }

        .journey-card span {
            font-size: 0.85rem;
            color: var(--color-muted);
        }

        .journey-card strong {
            font-size: 1.2rem;
            display: block;
            margin-bottom: 8px;
            color: var(--color-primary);
        }

        .pillars-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
        }

        .pillar-card {
            border-radius: 18px;
            padding: 18px 20px;
            border: 1px solid rgba(124, 58, 237, 0.15);
            background: rgba(255, 255, 255, 0.9);
            scroll-snap-align: start;
        }

        .pillar-card h4 {
            margin-bottom: 6px;
            color: var(--color-primary);
        }

        .sticky-assistant {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 40;
            background: linear-gradient(135deg, #7C3AED, #EC4899);
            color: white;
            border-radius: 16px;
            padding: 18px 22px;
            box-shadow: 0 18px 35px rgba(124, 58, 237, 0.4);
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: min(280px, 80vw);
            position: relative;
        }

        .sticky-assistant summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 6px;
            position: relative;
        }
        .sticky-assistant summary::-webkit-details-marker { display: none; }

        .sticky-assistant button {
            margin-top: 6px;
            border: none;
            border-radius: 12px;
            padding: 10px;
            background: rgba(15, 23, 42, 0.15);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .assistant-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
            z-index: 10;
            padding: 0;
            line-height: 1;
        }

        .assistant-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .assistant-toggle:active {
            transform: scale(0.95);
        }

        .assistant-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
            padding: 20px;
        }

        .modal-backdrop.is-visible {
            display: flex;
        }

        .signup-modal {
            background: #fff;
            border-radius: 24px;
            max-width: 480px;
            width: 100%;
            padding: 28px;
            box-shadow: var(--shadow-strong);
        }

        .signup-modal h3 {
            margin-bottom: 8px;
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .signup-modal p {
            color: var(--color-muted);
            margin-bottom: 20px;
        }

        .modal-form {
            display: grid;
            gap: 12px;
        }

        .modal-form label {
            font-size: 0.85rem;
            color: var(--color-muted);
        }

        .modal-form input,
        .modal-form select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.12);
            font-family: inherit;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 8px;
        }

        .profile-wizard-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
            padding: 24px;
        }

        .profile-wizard-backdrop.is-visible {
            display: flex;
        }

        .profile-wizard {
            background: #fff;
            border-radius: 28px;
            width: min(640px, 100%);
            padding: 28px;
            box-shadow: 0 30px 60px rgba(15, 23, 42, 0.25);
            position: relative;
        }

        .wizard-close {
            position: absolute;
            top: 18px;
            right: 18px;
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--color-muted);
        }

        .wizard-progress {
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 12px;
        }

        .wizard-step {
            display: none;
            animation: fadeSlide 0.25s ease;
        }

        .wizard-step.is-active {
            display: block;
        }

        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .wizard-chip {
            border: 1px solid rgba(124, 58, 237, 0.18);
            border-radius: 16px;
            padding: 10px 14px;
            background: #fff;
            font-weight: 600;
            color: var(--color-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .wizard-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
        }

        .wizard-chip.is-active {
            border-color: transparent;
            background: rgba(124, 58, 237, 0.15);
            color: var(--color-primary);
            box-shadow: 0 8px 18px rgba(124, 58, 237, 0.25);
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 18px;
        }

        .wizard-actions .btn-secondary {
            flex: 1;
            margin-right: 12px;
        }

        .wizard-actions .btn-primary {
            flex: 1;
        }

        .progress-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }

        .progress-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(124, 58, 237, 0.12);
            color: var(--color-primary);
            font-size: 0.82rem;
            font-weight: 600;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto 60px;
            background: var(--color-card);
            border-radius: 24px;
            box-shadow: var(--shadow-strong);
            overflow: hidden;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 24px;
            padding: 32px 40px 48px;
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            .hero-inner {
                grid-template-columns: 1fr;
            }
            .hero-visual {
                order: -1;
            }
            .app-shell {
                grid-template-columns: 1fr;
                padding: 24px;
            }
            .sticky-assistant {
                right: 12px;
                bottom: 12px;
            }
            .journey-grid,
            .pillars-grid {
                display: flex;
                overflow-x: auto;
                padding-bottom: 6px;
                scroll-snap-type: x mandatory;
                gap: 14px;
            }
            .journey-card,
            .pillar-card {
                min-width: 240px;
            }
            .steps-pane {
                position: static;
                max-height: none;
                overflow: visible;
            }
        }

        .steps-pane {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow-soft);
            position: sticky;
            top: 24px;
            align-self: start;
            max-height: calc(100vh - 48px);
            overflow-y: auto;
        }

        .steps-pane h2 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 16px;
        }

        .steps-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 14px;
        }

        .steps-item {
            display: grid;
            grid-template-columns: 36px 1fr;
            gap: 12px;
            align-items: center;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(168, 85, 247, 0.18);
            background: rgba(255, 255, 255, 0.85);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .steps-item .step-index {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            background: rgba(168, 85, 247, 0.12);
            color: var(--color-primary);
        }

        .steps-item .step-label {
            font-weight: 600;
            color: var(--color-dark);
        }

        .steps-item .step-hint {
            font-size: 0.82rem;
            color: var(--color-muted);
        }

        .steps-item.is-active {
            border-color: var(--color-primary);
            box-shadow: 0 10px 22px rgba(168, 85, 247, 0.16);
            transform: translateY(-2px);
        }

        .steps-item.is-active .step-index {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-accent));
            color: #fff;
        }

        .steps-item.is-nav-focus:not(.is-active) {
            border-color: var(--color-primary);
            box-shadow: 0 12px 26px rgba(168, 85, 247, 0.16);
        }

        .steps-item.is-nav-focus:not(.is-active) .step-index {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-accent));
            color: #fff;
        }

        .steps-item.is-complete {
            opacity: 0.85;
        }

        .steps-item.is-complete .step-index {
            background: rgba(16, 185, 129, 0.18);
            color: #059669;
        }

        .header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-accent));
            color: #ffffff;
            padding: 40px;
            text-align: center;
        }

        .app-brand {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
        }

        .brand-logo {
            height: 52px;
            width: auto;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            border: 0;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .main-content {
            padding: 40px;
        }

        .profile-card {
            background: linear-gradient(145deg, rgba(252, 251, 255, 0.95), rgba(255, 255, 255, 0.98));
            border-radius: 28px;
            padding: 28px;
            border: 1px solid rgba(124, 58, 237, 0.12);
            box-shadow: var(--shadow-soft);
            margin-bottom: 30px;
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .profile-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(124, 58, 237, 0.12);
            color: var(--color-primary);
            font-weight: 600;
        }

        .profile-hero {
            font-size: 1.9rem;
            font-weight: 700;
            color: var(--color-dark);
            margin: 8px 0;
        }

        .profile-highlights {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 16px 0 8px;
        }

        .profile-highlight {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.92rem;
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.08);
            background: rgba(15, 23, 42, 0.08);
            color: var(--color-dark);
        }

        .profile-highlight--skin,
        .profile-highlight--hair,
        .profile-highlight--concern,
        .profile-highlight--goal {
            background: rgba(15, 23, 42, 0.08);
            color: var(--color-dark);
        }

        .profile-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .profile-actions .btn-primary {
            background: linear-gradient(120deg, #7C3AED, #EC4899);
            color: #fff;
        }

        .profile-actions .btn-secondary {
            background: rgba(124, 58, 237, 0.08);
            color: var(--color-primary);
        }

        .profile-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #22c55e;
            color: white;
            padding: 12px 18px;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(34, 197, 94, 0.4);
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 80;
        }

        .profile-toast.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .profile-form {
            display: none;
        }

        .profile-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-pill {
            position: relative;
            display: inline-flex;
            align-items: center;
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid rgba(168, 85, 247, 0.25);
            background: white;
            color: #5b21b6;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .checkbox-pill input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .checkbox-pill.active,
        .checkbox-pill:hover {
            background: rgba(168, 85, 247, 0.15);
            border-color: rgba(168, 85, 247, 0.35);
        }

        .builder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
            margin-top: 18px;
        }

        .builder-card {
            border: 1px solid rgba(168, 85, 247, 0.18);
            border-radius: 14px;
            padding: 18px;
            background: white;
            box-shadow: 0 12px 24px rgba(168, 85, 247, 0.08);
        }

        .builder-card h4 {
            margin-bottom: 8px;
            font-size: 1.1rem;
            color: #5b21b6;
        }

        .builder-card p {
            margin-bottom: 12px;
            color: #4b5563;
            font-size: 0.95rem;
        }

        .builder-card select {
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            padding: 10px;
            font-size: 0.95rem;
        }

        .builder-summary {
            margin-top: 24px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(236, 233, 254, 0.9));
            padding: 18px;
            border-radius: 14px;
            border: 1px solid rgba(168, 85, 247, 0.18);
        }

        .builder-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 18px;
        }

        .builder-actions button {
            border-radius: 999px;
            padding: 10px 20px;
            font-weight: 600;
            border: 1px solid rgba(168, 85, 247, 0.35);
            background: white;
            color: #5b21b6;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .builder-actions button.primary {
            background: linear-gradient(135deg, #A855F7, #8B5CF6);
            color: white;
            border: none;
        }

        .builder-actions button:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(168, 85, 247, 0.18);
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed rgba(168, 85, 247, 0.25);
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--color-primary);
            background: rgba(168, 85, 247, 0.08);
        }

        .upload-area {
            text-align: center;
            padding: 40px;
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--color-primary);
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-accent));
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: var(--shadow-soft);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(168, 85, 247, 0.2);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            color: var(--color-dark);
            background: rgba(255,255,255,0.9);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15);
        }

        .analyze-btn {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-accent));
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            box-shadow: var(--shadow-soft);
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            display: none;
        }

        .results-section.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-card {
            background: var(--color-card);
            border-radius: 18px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
        }

        .card-collapse {
            border: none;
            padding: 0;
            margin: 0;
        }

        .card-collapse > summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            padding: 0;
        }

        .card-collapse > summary::-webkit-details-marker {
            display: none;
        }

        .summary-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 15px;
            font-family: 'Playfair Display', Georgia, serif;
        }

        .summary-info .result-title {
            margin-bottom: 0;
        }

        .summary-subtitle {
            font-size: 0.92rem;
            color: var(--color-muted);
        }

        .summary-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .collapse-icon {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: 1px solid rgba(168, 85, 247, 0.25);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-primary);
            background: rgba(168, 85, 247, 0.08);
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .card-collapse:hover .collapse-icon {
            background: rgba(168, 85, 247, 0.15);
        }

        .card-collapse[open] .collapse-icon::after {
            content: '−';
        }

        .card-collapse:not([open]) .collapse-icon::after {
            content: '+';
        }

        .card-body {
            margin-top: 18px;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(168, 85, 247, 0.08);
            border-radius: 12px;
            border-left: 4px solid rgba(168, 85, 247, 0.5);
        }

        .ingredient-item.warning {
            border-left-color: #f59e0b;
        }

        .ingredient-item.danger {
            border-left-color: #ef4444;
        }

        .ingredient-name {
            font-weight: 600;
            color: var(--color-dark);
        }

        .ingredient-score {
            background: rgba(16, 185, 129, 0.2);
            color: #047857;
            padding: 6px 16px;
            border-radius: 999px;
            font-weight: 600;
        }

        .ingredient-score.warning {
            background: rgba(245, 158, 11, 0.25);
            color: #b45309;
        }

        .ingredient-score.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #b91c1c;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.6);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.12);
            color: #b91c1c;
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid rgba(239, 68, 68, 0.25);
        }

        .success {
            background: rgba(16, 185, 129, 0.12);
            color: #047857;
            padding: 16px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid rgba(16, 185, 129, 0.25);
        }

        .preview-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tabs {
            display: flex;
            margin-bottom: 24px;
            background: rgba(168, 85, 247, 0.08);
            border-radius: 12px;
            padding: 6px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--color-muted);
        }

        .tab.active {
            background: #ffffff;
            color: var(--color-primary);
            box-shadow: var(--shadow-soft);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .results-wrapper {
            display: grid;
            gap: 20px;
        }

        .muted {
            color: var(--color-muted);
        }

        .score-badge {
            min-width: 88px;
            border-radius: 16px;
            background: rgba(236, 72, 153, 0.15);
            color: var(--color-primary);
            font-weight: 700;
            text-align: center;
            padding: 10px;
            font-size: 1.1rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px;
        }

        .summary-chip {
            background: rgba(168, 85, 247, 0.08);
            border-radius: 14px;
            padding: 12px 14px;
        }

        .summary-chip strong {
            display: block;
            margin-bottom: 4px;
            color: var(--color-primary);
        }

        .ingredient-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ingredient-filter-btn {
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 999px;
            padding: 6px 14px;
            background: #fff;
            font-weight: 600;
            color: var(--color-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ingredient-filter-btn.is-active {
            background: rgba(124, 58, 237, 0.12);
            color: var(--color-primary);
            border-color: transparent;
        }

        .ingredients-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }

        .ingredient-card {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 18px;
            padding: 18px;
            border: 1px solid rgba(124, 58, 237, 0.08);
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .ingredient-card[data-status="warning"] {
            border-color: rgba(248, 113, 113, 0.4);
        }

        .ingredient-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 35px rgba(15, 23, 42, 0.12);
        }

        .ingredient-card[data-level="high"] { border-left: 4px solid #34d399; }
        .ingredient-card[data-level="medium"] { border-left: 4px solid #fbbf24; }
        .ingredient-card[data-level="low"] { border-left: 4px solid #fb7185; }
        .ingredient-card[data-level="neutral"] { border-left: 4px solid rgba(15, 23, 42, 0.15); }

        .ingredient-card h4 {
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .ingredient-meta {
            font-size: 0.85rem;
            color: var(--color-muted);
            margin-bottom: 10px;
        }

        .ingredient-description {
            font-size: 0.92rem;
            color: var(--color-dark);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .ingredient-benefits {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .benefit-badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .benefit-badge--clean { background: #ddf5eb; color: #1f9254; }
        .benefit-badge--hydrate { background: #e4f0fa; color: #16658a; }
        .benefit-badge--calm { background: #fbd2d7; color: #9d174d; }
        .benefit-badge--balance { background: #fff8b5; color: #92400e; }
        .benefit-badge--antiox { background: #fff6cc; color: #854d0e; }
        .benefit-badge--default { background: rgba(15, 23, 42, 0.08); color: var(--color-dark); }

        .recommendations-card {
            background: #fff;
            border-radius: 24px;
            padding: 24px;
            border: 1px solid rgba(124, 58, 237, 0.12);
            box-shadow: var(--shadow-soft);
        }

        .recommendations-summary {
            background: linear-gradient(180deg, #e8fff1 0%, #f8fffc 100%);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 16px;
            font-size: 0.95rem;
            color: #115e38;
        }

        .goal-progress {
            margin-bottom: 12px;
        }

        .goal-progress-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .goal-progress-bar {
            margin-top: 6px;
            height: 8px;
            background: rgba(15, 23, 42, 0.08);
            border-radius: 999px;
            overflow: hidden;
        }

        .goal-progress-bar span {
            display: block;
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(120deg, #34d399, #3b82f6);
        }

        .recommendations-cta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 18px;
        }

        .recommendations-cta .btn {
            flex: 1;
            min-width: 180px;
        }

        .compat-summary {
            margin-bottom: 16px;
            font-size: 0.95rem;
            color: var(--color-muted);
        }

        .compat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
        }

        .compat-card {
            background: #fff;
            border-radius: 18px;
            border: 1px solid rgba(124, 58, 237, 0.1);
            padding: 16px;
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.05);
        }

        .compat-card strong {
            display: block;
            margin-bottom: 6px;
        }

        .compat-level {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 999px;
            padding: 4px 10px;
        }

        .compat-level[data-level="high"] { background: #d9fbe3; color: #1f9254; }
        .compat-level[data-level="medium"] { background: #fff3c4; color: #92400e; }
        .compat-level[data-level="low"] { background: #ffe4e6; color: #b91c1c; }

        .compat-progress {
            height: 6px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.08);
            margin: 10px 0;
            overflow: hidden;
        }

        .compat-progress span {
            display: block;
            height: 100%;
            border-radius: inherit;
        }

        .ingredients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 14px;
            font-size: 0.95rem;
        }

        .ingredients-table thead {
            background: rgba(168, 85, 247, 0.1);
        }

        .ingredients-table th,
        .ingredients-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(168, 85, 247, 0.12);
        }

        .ingredients-table tbody tr:last-child td {
            border-bottom: none;
        }

        .ingredients-table .utility-cell {
            max-width: 260px;
            white-space: normal;
            line-height: 1.45;
            vertical-align: top;
        }

        .alignment-summary {
            border-radius: 14px;
            padding: 14px 16px;
            margin-bottom: 14px;
            font-weight: 500;
            line-height: 1.45;
        }

        .alignment-summary--success {
            background: rgba(16, 185, 129, 0.12);
            color: #047857;
        }

        .alignment-summary--warning {
            background: rgba(239, 68, 68, 0.12);
            color: #b91c1c;
        }

        .alignment-summary--neutral {
            background: rgba(168, 85, 247, 0.1);
            color: var(--color-primary);
        }

        .goal-breakdown {
            margin: 18px 0 4px;
        }

        .goal-breakdown h4 {
            margin: 0 0 10px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--color-muted);
        }

        .goal-breakdown ul {
            margin: 0;
            padding: 0;
            list-style: none;
            display: grid;
            gap: 10px;
        }

        .goal-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.92rem;
            font-weight: 600;
        }

        .goal-pill--success {
            background: rgba(16, 185, 129, 0.14);
            color: #047857;
        }

        .goal-pill--warning {
            background: rgba(239, 68, 68, 0.14);
            color: #b91c1c;
        }

        .goal-pill--neutral {
            background: rgba(168, 85, 247, 0.12);
            color: var(--color-primary);
        }

        .utility-summary {
            font-weight: 600;
            margin-bottom: 6px;
            color: #0f172a;
        }

        .utility-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 6px;
        }

        .utility-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .utility-chip--support {
            background: rgba(16, 185, 129, 0.18);
            color: #047857;
        }

        .utility-chip--conflict {
            background: rgba(239, 68, 68, 0.18);
            color: #b91c1c;
        }

        .utility-note {
            font-size: 0.82rem;
            color: var(--color-muted);
            line-height: 1.4;
        }

        .compat-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.95rem;
        }

        .compat-table thead {
            background: rgba(15, 23, 42, 0.08);
        }

        .compat-table th,
        .compat-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
            text-align: left;
        }

        .compat-table tbody tr:last-child td {
            border-bottom: none;
        }

        .compat-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .compat-badge--high {
            background: rgba(16, 185, 129, 0.16);
            color: #047857;
        }

        .compat-badge--medium {
            background: rgba(234, 179, 8, 0.18);
            color: #b45309;
        }

        .compat-badge--low {
            background: rgba(249, 115, 22, 0.16);
            color: #c2410c;
        }

        .compat-badge--none {
            background: rgba(148, 163, 184, 0.18);
            color: #475569;
        }

        .compat-badge--warning {
            background: rgba(239, 68, 68, 0.18);
            color: #b91c1c;
        }

        .ingredient-columns {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            margin: 18px 0;
        }

        .ingredient-columns h5 {
            margin: 0 0 8px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--color-muted);
        }

        .ingredient-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 8px;
        }

        .ingredient-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(15, 23, 42, 0.08);
            color: #111827;
        }

        .ingredient-chip--base {
            background: rgba(15, 23, 42, 0.08);
            color: #111827;
        }

        .ingredient-chip--new {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        .ingredient-chip--warning {
            background: rgba(239, 68, 68, 0.14);
            color: #b91c1c;
        }

        .labs-card {
            border-radius: 24px;
            padding: 28px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(168, 85, 247, 0.18);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        .labs-card h4 {
            margin: 12px 0 6px;
            font-size: 1.35rem;
            color: var(--color-dark);
        }

        .labs-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin: 16px 0 4px;
        }

        .labs-score strong {
            font-size: 2.4rem;
            color: var(--color-primary);
            line-height: 1;
        }

        .labs-score span {
            display: block;
            font-size: 0.85rem;
            color: var(--color-muted);
        }

        .labs-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-radius: 16px;
            background: rgba(124, 58, 237, 0.08);
            margin-top: 16px;
        }

        .labs-formula-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .labs-formula-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-radius: 18px;
            background: rgba(16, 185, 129, 0.12);
        }

        .labs-formula-list li span {
            display: block;
        }

        .labs-result-card {
            border-radius: 28px;
            background: #fff;
            border: 1px solid rgba(124, 58, 237, 0.12);
            padding: 28px;
            box-shadow: var(--shadow-soft);
        }

        .labs-result-header {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .labs-result-body {
            margin-top: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .labs-result-footer {
            margin-top: 20px;
        }

        .labs-result-stats {
            font-size: 0.9rem;
        }

        .labs-gauge {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: conic-gradient(var(--color-primary) calc(var(--gauge-value, 0) * 1%), rgba(15,23,42,0.08) 0);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--color-dark);
            font-weight: 700;
        }

        .labs-gauge span {
            font-size: 1.8rem;
        }

        .labs-gauge small {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .labs-base-chips {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .labs-base-chip {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .labs-base-chip--safe { background: #d9fbe3; color: #166534; }
        .labs-base-chip--warning { background: #fee2e2; color: #b91c1c; }
        .labs-base-chip--boost { background: #e0e7ff; color: #312e81; }

        .labs-substitutes {
            display: grid;
            gap: 12px;
        }

        .labs-substitute-card {
            background: #fff;
            border-radius: 18px;
            border: 1px solid rgba(124, 58, 237, 0.12);
            padding: 16px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
        }

        .labs-substitute-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .labs-substitute-percent {
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .labs-substitute-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .labs-substitute-tags span {
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(124, 58, 237, 0.12);
            color: var(--color-primary);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .labs-result-footer .cta-buy {
            margin-top: 12px;
        }

        .labs-impact-table {
            width: 100%;
            margin-top: 12px;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .labs-impact-table th,
        .labs-impact-table td {
            padding: 6px 4px;
            text-align: left;
        }

        .labs-replacements {
            margin-top: 20px;
            display: grid;
            gap: 12px;
        }

        .labs-replacement-card {
            border-radius: 18px;
            padding: 16px;
            border: 1px solid rgba(248, 113, 113, 0.4);
            background: #fff5f5;
        }

        .labs-replacement-card strong {
            display: block;
            margin-bottom: 4px;
        }

        .labs-replacement-card p {
            margin: 4px 0;
            font-size: 0.9rem;
        }

        .labs-pill {
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.85rem;
            background: rgba(16, 185, 129, 0.18);
            color: #047857;
        }

        .labs-highlights {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .labs-highlights span {
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(236, 72, 153, 0.12);
            font-size: 0.8rem;
            color: #9d174d;
            font-weight: 600;
        }

        .alternatives-shell {
            position: relative;
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            border-radius: 24px;
            padding: 28px;
            background: linear-gradient(135deg, rgba(29, 78, 216, 0.12), rgba(236, 72, 153, 0.08));
            overflow: hidden;
        }

        .alternatives-shell::before {
            content: '';
            position: absolute;
            top: -45%;
            right: -30%;
            width: 60%;
            height: 160%;
            background: radial-gradient(circle at center, rgba(124, 58, 237, 0.25), transparent 60%);
            transform: rotate(12deg);
        }

        .alternatives-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .lab-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(124, 58, 237, 0.18);
            color: var(--color-primary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-size: 0.78rem;
        }

        .alternatives-content h4 {
            margin: 0;
            font-size: 1.35rem;
            color: #0f172a;
        }

        .alternatives-visual {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mommy-bottle {
            position: relative;
            width: 160px;
            height: 250px;
            border-radius: 80px 80px 55px 55px;
            background: linear-gradient(160deg, #4c1d95 0%, #6366f1 55%, #22d3ee 100%);
            box-shadow: 0 24px 55px rgba(79, 70, 229, 0.38);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            text-align: center;
            padding: 0 20px;
        }

        .mommy-bottle::before {
            content: '';
            position: absolute;
            inset: 8px;
            border-radius: 72px 72px 48px 48px;
            border: 2px solid rgba(255, 255, 255, 0.22);
        }

        .mommy-bottle::after {
            content: '';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 32px;
            border-radius: 18px 18px 8px 8px;
            background: rgba(15, 23, 42, 0.9);
        }

        .mommy-emblem {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            font-size: 1.7rem;
            letter-spacing: 0.08em;
        }

        .mommy-emblem span {
            font-size: 0.82rem;
            font-weight: 500;
            letter-spacing: 0.1em;
        }

        .cta-zone {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .cta-buy {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 999px;
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--color-primary), #c084fc);
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-size: 0.95rem;
        }

        .cta-buy::after {
            content: '→';
            margin-left: 10px;
            font-size: 1rem;
        }

        .cta-buy:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge.safe {
            background: rgba(16, 185, 129, 0.14);
            color: #047857;
        }

        .badge.warning {
            background: rgba(245, 158, 11, 0.16);
            color: #b45309;
        }

        .badge.danger {
            background: rgba(239, 68, 68, 0.16);
            color: #b91c1c;
        }

        .actions-card {
            display: grid;
            gap: 12px;
        }

        .actions-card button {
            width: 100%;
        }

        details.fold {
            border-radius: 16px;
            border: 1px solid rgba(168, 85, 247, 0.18);
            background: rgba(255,255,255,0.92);
            padding: 14px 18px;
        }

        details.fold summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--color-primary);
        }

        .insights-list {
            list-style: disc;
            padding-left: 22px;
            color: var(--color-muted);
        }

        .builder-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .builder-table th,
        .builder-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(168, 85, 247, 0.12);
        }

        .builder-table select {
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            padding: 8px;
        }

        .builder-summary {
            margin-top: 16px;
            background: rgba(168, 85, 247, 0.08);
            border-radius: 14px;
            padding: 14px 16px;
            color: var(--color-dark);
        }

        .builder-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
        }

        @media (max-width: 1024px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            .steps-pane {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            .app-shell {
                padding: 24px;
            }

            .builder-actions {
                flex-direction: column;
            }

            .steps-item {
                grid-template-columns: 32px 1fr;
                padding: 10px;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <nav class="site-nav">
        <div class="nav-inner">
            <div class="nav-logo">
                <span>Mommyshops Labs</span>
            </div>
            <div class="nav-links" aria-label="Navegación principal">
                <a href="#inicio">Inicio</a>
                <a href="#solucion">Productos</a>
                <a href="#laboratorio">Laboratorio</a>
                <a href="#recursos">Recursos</a>
            </div>
            <div class="nav-cta">
                <button class="btn btn-secondary" onclick="startMainFlow()">Comienza ahora</button>
                <button class="btn btn-primary" onclick="openSignupModal()">Conoce más</button>
            </div>
        </div>
    </nav>

    <header class="site-hero" id="inicio">
        <div class="hero-inner">
            <div class="hero-copy">
                <p class="lab-badge">Mommyshops Bebé. Sin Lágrimas, Con Amor y un poco de IA</p>
                <h1>El primer jabón-shampoo que ajusta su fórmula por clima, ciudad y la piel de tu bebé.</h1>
                <p>IA que analiza tu producto, cruza OMS/FDA/CIR/SCCS y entrega una fórmula microbiome friendly, 100 % biodegradable y libre de alérgenos EU26.</p>
                <div class="nav-cta" style="margin-bottom:12px;">
                    <button class="btn btn-primary" onclick="openSignupModal()">Recibe nuestro Newsletter </button>
                    <button class="btn btn-secondary" onclick="startMainFlow()">Prueba de producto gratis</button>
                </div>
                <div class="hero-metrics">
                    <div class="metric-card">
                        <strong>+100K</strong>
                        <span>Ingredientes analizados</span>
                    </div>
                    <div class="metric-card">
                        <strong>99%</strong>
                        <span>Compatibilidad</span>
                    </div>
                    <div class="metric-card">
                        <strong>5-7</strong>
                        <span>Días de entrega</span>
                    </div>
                </div>
            </div>
            <div class="hero-visual" aria-label="Laboratorio inteligente">
                <div id="heroLottie" aria-hidden="true" style="height:120px;margin-bottom:10px;"></div>
                <h3>Mommyshops Labs 🧪</h3>
                <ul>
                    <li>✔️ Fórmulas 100 % biodegradables en 28 días (OECD 301B)</li>
                    <li>🌿 Ajuste IA con estándares OMS/FDA/CIR, ICCR, SCCS</li>
                    <li>🍼 Personalización por edad de bebé, clima y humedad en tiempo real</li>
                </ul>
            </div>
        </div>
    </header>

    <div class="trust-bar" id="solucion">
        <span>Mommyshops Labs contrasta su información con bases de datos globales</span>
        <div class="trust-logos">
            <span>EWG Verified</span>
            <span>USDA Organic</span>
            <span>Microbiome Friendly</span>
            <span>Libre EU26</span>
            <span>OK Compost Home</span>
        </div>
    </div>

    <section class="site-section" id="bebes" style="padding:80px 24px;background:linear-gradient(180deg, #fdf8ff 0%, #f6f9ff 50%, #f9fffb 100%);">
        <div style="max-width:1200px;margin:0 auto;display:grid;gap:48px;">
            <div style="text-align:center;">
                <p class="lab-badge">Lanzamiento • Mommyshops Bebé</p>
                <h2 style="font-size:2.6rem;margin:10px 0;line-height:1.2;font-weight:700;">Sin lágrimas. Sin tóxicos. Sin disruptores endocrinos.</h2>
                <p style="color:var(--color-muted);font-size:1.1rem;max-width:820px;margin:16px auto 0;line-height:1.6;">"El primer jabón-shampoo que ajusta su fórmula con IA según clima, ciudad y piel del bebé."</p>
            </div>

            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));gap:28px;margin-top:32px;">
                <!-- Nube de Avena - Beige/Crema -->
                <div style="background:linear-gradient(135deg, #faf8f3 0%, #f5f1e8 100%);border:1px solid rgba(210, 180, 140, 0.2);border-radius:28px;padding:32px;box-shadow:0 20px 45px rgba(210, 180, 140, 0.14), 0 0 0 1px rgba(255,255,255,0.5) inset;position:relative;overflow:hidden;backdrop-filter:blur(10px);">
                    <div style="position:absolute;top:-20px;right:-20px;width:120px;height:120px;background:radial-gradient(circle, rgba(255,248,220,0.6), transparent);border-radius:50%;opacity:0.5;"></div>
                    <div style="position:relative;z-index:1;">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                            <span style="font-size:2rem;">☁️🌾</span>
                            <div>
                                <span style="display:inline-block;background:rgba(210, 180, 140, 0.15);color:#8b6f47;padding:6px 14px;border-radius:20px;font-size:0.8rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Piel Seca</span>
                                <h3 style="font-size:1.5rem;margin:8px 0 4px;color:#5c4a37;font-weight:700;">Nube de Avena</h3>
                            </div>
                        </div>
                        <p style="color:#6b5d47;margin-bottom:16px;font-size:0.95rem;line-height:1.5;">Para piel seca/atópica o clima seco</p>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#6b5d47;">🌾 Avena 5%</span>
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#6b5d47;">🧈 Karité</span>
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#6b5d47;">🌻 Caléndula</span>
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#6b5d47;">💧 pH 5.5</span>
                        </div>
                        <p style="background:rgba(255,248,220,0.6);padding:14px;border-radius:14px;margin-bottom:20px;font-size:0.9rem;line-height:1.5;color:#5c4a37;font-style:italic;">
                            💛 "Tu bebé deja de sentir tirantez y resequedad desde el primer uso."
                        </p>
                        <button onclick="startMainFlow()" style="width:100%;padding:14px 24px;background:linear-gradient(135deg, #7C3AED, #EC4899);color:white;border:none;border-radius:999px;font-weight:600;font-size:0.95rem;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;box-shadow:0 8px 20px rgba(124, 58, 237, 0.25);">
                            💜 Descubrir mezcla →
                        </button>
                    </div>
                </div>

                <!-- Brisa de Té Verde - Verde Menta -->
                <div style="background:linear-gradient(135deg, #f0f9f4 0%, #e8f5ed 100%);border:1px solid rgba(76, 175, 80, 0.2);border-radius:28px;padding:32px;box-shadow:0 20px 45px rgba(76, 175, 80, 0.14), 0 0 0 1px rgba(255,255,255,0.5) inset;position:relative;overflow:hidden;backdrop-filter:blur(10px);">
                    <div style="position:absolute;top:-20px;right:-20px;width:120px;height:120px;background:radial-gradient(circle, rgba(200,230,201,0.6), transparent);border-radius:50%;opacity:0.5;"></div>
                    <div style="position:relative;z-index:1;">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                            <span style="font-size:2rem;">🍃💧</span>
                            <div>
                                <span style="display:inline-block;background:rgba(76, 175, 80, 0.15);color:#2e7d32;padding:6px 14px;border-radius:20px;font-size:0.8rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Piel Húmeda</span>
                                <h3 style="font-size:1.5rem;margin:8px 0 4px;color:#1b5e20;font-weight:700;">Brisa de Té Verde</h3>
                            </div>
                        </div>
                        <p style="color:#4a7c59;margin-bottom:16px;font-size:0.95rem;line-height:1.5;">Para clima húmedo/caliente o dermatitis de pañal</p>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#4a7c59;">🍃 Té verde</span>
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#4a7c59;">🍂 Hamamelis</span>
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#4a7c59;">🌱 Aloe 99%</span>
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#4a7c59;">💧 pH 5.5</span>
                        </div>
                        <p style="background:rgba(200,230,201,0.6);padding:14px;border-radius:14px;margin-bottom:20px;font-size:0.9rem;line-height:1.5;color:#1b5e20;font-style:italic;">
                            💚 "Protege la piel cuando hace calor o humedad alta."
                        </p>
                        <button onclick="startMainFlow()" style="width:100%;padding:14px 24px;background:linear-gradient(135deg, #7C3AED, #EC4899);color:white;border:none;border-radius:999px;font-weight:600;font-size:0.95rem;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;box-shadow:0 8px 20px rgba(124, 58, 237, 0.25);">
                            💜 Descubrir mezcla →
                        </button>
                    </div>
                </div>

                <!-- Equilibrio Caléndula - Amarillo Suave -->
                <div style="background:linear-gradient(135deg, #fffef5 0%, #fffbea 100%);border:1px solid rgba(255, 193, 7, 0.2);border-radius:28px;padding:32px;box-shadow:0 20px 45px rgba(255, 193, 7, 0.14), 0 0 0 1px rgba(255,255,255,0.5) inset;position:relative;overflow:hidden;backdrop-filter:blur(10px);">
                    <div style="position:absolute;top:-20px;right:-20px;width:120px;height:120px;background:radial-gradient(circle, rgba(255,248,220,0.6), transparent);border-radius:50%;opacity:0.5;"></div>
                    <div style="position:relative;z-index:1;">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                            <span style="font-size:2rem;">🌼☀️</span>
                            <div>
                                <span style="display:inline-block;background:rgba(255, 193, 7, 0.15);color:#f57c00;padding:6px 14px;border-radius:20px;font-size:0.8rem;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Piel Normal</span>
                                <h3 style="font-size:1.5rem;margin:8px 0 4px;color:#e65100;font-weight:700;">Equilibrio Caléndula</h3>
                            </div>
                        </div>
                        <p style="color:#8d6e63;margin-bottom:16px;font-size:0.95rem;line-height:1.5;">Para uso diario y piel normal/mixta</p>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#8d6e63;">🌼 Caléndula</span>
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#8d6e63;">🟡 Jojoba</span>
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#8d6e63;">🌿 Manzanilla</span>
                            <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.7);padding:6px 12px;border-radius:12px;font-size:0.85rem;color:#8d6e63;">💧 pH 5.5</span>
                        </div>
                        <p style="background:rgba(255,248,220,0.6);padding:14px;border-radius:14px;margin-bottom:20px;font-size:0.9rem;line-height:1.5;color:#e65100;font-style:italic;">
                            🤍 "Rutina suave para todos los días."
                        </p>
                        <button onclick="startMainFlow()" style="width:100%;padding:14px 24px;background:linear-gradient(135deg, #7C3AED, #EC4899);color:white;border:none;border-radius:999px;font-weight:600;font-size:0.95rem;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;box-shadow:0 8px 20px rgba(124, 58, 237, 0.25);">
                            💜 Descubrir mezcla →
                        </button>
                    </div>
                </div>
            </div>

            <!-- Características comunes visual -->
            <div style="background:rgba(255,255,255,0.8);backdrop-filter:blur(20px);border-radius:24px;padding:32px;box-shadow:0 20px 45px rgba(0,0,0,0.08);border:1px solid rgba(255,255,255,0.5);">
                <h3 style="margin:0 0 24px;font-size:1.4rem;color:var(--color-dark);text-align:center;font-weight:700;">Características comunes</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:20px;">
                    <div style="text-align:center;">
                        <div style="font-size:2rem;margin-bottom:8px;">🌍</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-muted);line-height:1.4;">100% biodegradable</p>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:2rem;margin-bottom:8px;">🧪</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-muted);line-height:1.4;">pH 5.5</p>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:2rem;margin-bottom:8px;">🧡</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-muted);line-height:1.4;">Tear-free</p>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:2rem;margin-bottom:8px;">🌱</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-muted);line-height:1.4;">Orgánico</p>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:2rem;margin-bottom:8px;">🧬</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-muted);line-height:1.4;">Microbiome-friendly</p>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:2rem;margin-bottom:8px;">♻️</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-muted);line-height:1.4;">Refill aluminio</p>
                    </div>
                </div>
            </div>

            <!-- Activaciones IA visual -->
            <div style="background:linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(236, 72, 153, 0.05));border-radius:24px;padding:32px;box-shadow:0 20px 45px rgba(124, 58, 237, 0.1);border:1px solid rgba(124, 58, 237, 0.15);">
                <h3 style="margin:0 0 12px;font-size:1.4rem;color:var(--color-dark);text-align:center;font-weight:700;">"Tu bebé cambia, la fórmula cambia contigo."</h3>
                <p style="text-align:center;color:var(--color-muted);margin-bottom:28px;font-size:0.95rem;">Ajustes automáticos de IA según:</p>
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:20px;">
                    <div style="text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:8px;">🌤️</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-dark);font-weight:600;">Clima</p>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:8px;">👶</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-dark);font-weight:600;">Edad</p>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:8px;">💧</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-dark);font-weight:600;">Humedad</p>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:8px;">✈️</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-dark);font-weight:600;">Viaje</p>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:8px;">💖</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-dark);font-weight:600;">Sensibilidad</p>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:8px;">🚿</div>
                        <p style="margin:0;font-size:0.85rem;color:var(--color-dark);font-weight:600;">Agua dura</p>
                    </div>
                </div>
            </div>

            <!-- Claim técnico (colapsable) -->
            <details style="background:rgba(255,255,255,0.6);backdrop-filter:blur(10px);border-radius:20px;padding:24px;border:1px solid rgba(124, 58, 237, 0.1);">
                <summary style="cursor:pointer;font-weight:600;color:var(--color-primary);font-size:1rem;margin-bottom:12px;">📋 Ver información técnica y legal</summary>
                <div style="margin-top:20px;display:grid;gap:16px;">
                    <div>
                        <h4 style="margin:0 0 8px;color:var(--color-dark);font-size:0.95rem;font-weight:600;">Claim técnico</h4>
                        <p style="color:var(--color-muted);margin:0;font-size:0.9rem;line-height:1.6;">Las fórmulas Mommyshops Bebé —evaluadas con análisis IA y validadas por bases regulatorias SCCS (Europa), CIR (EE. UU.), ECHA Endocrine Disruptor List, EWG Skin Deep y estándares FDA— excluyen completamente todos los ingredientes cosméticos con evidencia o sospecha de actividad endocrina, incluyendo parabenos, ftalatos, fenoxietanol, triclosán, benzofenonas, fijadores sintéticos y fragancias con alérgenos EU26.</p>
                    </div>
                    <div>
                        <h4 style="margin:0 0 8px;color:var(--color-primary);font-size:0.95rem;font-weight:600;">Legal-safe (UE/FDA)</h4>
                        <p style="color:var(--color-muted);margin:0;font-size:0.9rem;line-height:1.6;">Formulado sin ingredientes identificados por autoridades científicas internacionales (SCCS, CIR, ECHA) como sospechosos o confirmados disruptores endocrinos. Evaluado por IA con revisión automática de listas regulatorias vigentes.</p>
                    </div>
                </div>
            </details>
        </div>
    </section>

    <section class="site-section" id="laboratorio">
        <div class="journey-section">
            <div style="text-align:center;margin-bottom:48px;">
                <p class="lab-badge">Flujo guiado</p>
                <h2 style="font-size:2.5rem;margin-bottom:16px;line-height:1.2;">Del producto de tienda, a un producto diseñado 100% para las necesidades de tu bebé</h2>
                <p style="color:var(--color-muted);font-size:1.1rem;max-width:700px;margin:0 auto;">Con seguimiento en tiempo real transformamos ingredientes comerciales en fórmulas personalizadas y seguras.</p>
            </div>
            <div class="journey-grid">
                <div class="journey-card">
                    <div class="journey-icon">👤</div>
                    <span>01 • Perfil</span>
                    <strong>Contexto inteligente</strong>
                    <p>Tipo de piel, metas y restricciones médicas. Nuestra IA aprende tus necesidades específicas para personalizar cada análisis.</p>
                    <ul style="margin-top:12px;padding-left:20px;font-size:0.9rem;color:var(--color-muted);">
                        <li>Perfil de piel y edad del bebé</li>
                        <li>Condiciones médicas</li>
                        <li>Objetivos personalizados</li>
                    </ul>
                </div>
                <div class="journey-card">
                    <div class="journey-icon">📸</div>
                    <span>02 • Escaneo</span>
                    <strong>OCR + IA</strong>
                    <p>Detecta riesgos, crea ingredientes y valida normativas. Escaneamos etiquetas con tecnología de reconocimiento óptico avanzado.</p>
                    <ul style="margin-top:12px;padding-left:20px;font-size:0.9rem;color:var(--color-muted);">
                        <li>Reconocimiento de texto (OCR)</li>
                        <li>Validación regulatoria</li>
                        <li>Detección de riesgos</li>
                    </ul>
                </div>
                <div class="journey-card">
                    <div class="journey-icon">🔍</div>
                    <span>03 • Diagnóstico</span>
                    <strong>Compatibilidad personalizada</strong>
                    <p>Métricas, alertas y recomendaciones claras para cada necesidad. Análisis profundo con estándares OMS, FDA, CIR y SCCS.</p>
                    <ul style="margin-top:12px;padding-left:20px;font-size:0.9rem;color:var(--color-muted);">
                        <li>Análisis de compatibilidad</li>
                        <li>Alertas de seguridad</li>
                        <li>Recomendaciones inteligentes</li>
                    </ul>
                </div>
                <div class="journey-card">
                    <div class="journey-icon">🧪</div>
                    <span>04 • Fórmula Mommyshops Lbas</span>
                    <strong>Blend listo para fabricar</strong>
                    <p>Ingredientes sustitutos, porcentajes y producto hiper personalizados con inteligencia artificial. Fórmula completa lista para producción.</p>
                    <ul style="margin-top:12px;padding-left:20px;font-size:0.9rem;color:var(--color-muted);">
                        <li>Sustitutos certificados</li>
                        <li>Porcentajes precisos</li>
                        <li>Lista de ingredientes completa</li>
                    </ul>
                </div>
            </div>
            <div style="text-align:center;margin-top:48px;">
                <button class="btn btn-primary" onclick="startMainFlow()" style="font-size:1.1rem;padding:16px 32px;">Comenzar tu análisis ahora</button>
            </div>
        </div>
    </section>

    <div class="container" id="analizador">
        <div class="header">
            <div class="app-brand">
                <img src="/frontend/assets/mommyshops-logo.svg" alt="Mommyshops logo" class="brand-logo">
            </div>
            <h1 class="sr-only">MommyShops Análisis de Productos de Bebés</h1>
            <p>Análisis de Productos de Bebés</p>
        </div>

        <div class="app-shell">
            <aside class="stepsto estasto estas-pane" aria-label="Progreso de la experiencia">
                <h2>Tu recorrido</h2>
                <ol class="steps-list" id="journeySteps">
                    <li class="steps-item" data-step="1" data-target="profileCard">
                        <span class="step-index">1</span>
                        <div>
                            <div class="step-label">Perfil personalizado</div>
                            <div class="step-hint">Completa el cuestionario inicial</div>
                        </div>
                    </li>
                    <li class="steps-item" data-step="2" data-target="analysisEntry">
                        <span class="step-index">2</span>
                        <div>
                            <div class="step-label">Elige cómo analizar</div>
                            <div class="step-hint">Sube imagen o pega ingredientes</div>
                        </div>
                    </li>
                    <li class="steps-item" data-step="3" data-target="results">
                        <span class="step-index">3</span>
                        <div>
                            <div class="step-label">Escaneo inteligente</div>
                            <div class="step-hint">Mommyshops trabaja por ti</div>
                        </div>
                    </li>
                    <li class="steps-item" data-step="4" data-target="resultsContent">
                        <span class="step-index">4</span>
                        <div>
                            <div class="step-label">Resultados al instante</div>
                            <div class="step-hint">Revisa riesgos y fortalezas</div>
                        </div>
                    </li>
                    <li class="steps-item" data-step="5" data-target="labsFormulationMount">
                        <span class="step-index">5</span>
                        <div>
                            <div class="step-label">Formula personalizada</div>
                            <div class="step-hint">Elige sustitutos recomendados</div>
                        </div>
                    </li>
                    <li class="steps-item" data-step="6" data-target="builderMount">
                        <span class="step-index">6</span>
                        <div>
                            <div class="step-label">Compra segura</div>
                            <div class="step-hint">Solicita tu producto ideal</div>
                        </div>
                    </li>
                </ol>
            </aside>

        <div class="main-content">
            <div class="profile-card" id="profileCard">
                <div class="profile-header">
                    <div>
                        <span class="profile-pill" id="profilePill">Perfil incompleto</span>
                        <div class="profile-hero" id="profileHeroTitle">Diseñemos la fórmula Mommyshops Bebé para tu hijo/a</div>
                        <p id="profileSubtitle" class="profile-subtitle">Cuéntanos edad, tipo de piel y clima para recomendar la versión exacta (Nube de Avena, Brisa de Té Verde o Equilibrio de Caléndula).</p>
                    </div>
                    <div class="profile-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetProfile()">Restablecer</button>
                        <button type="button" class="btn btn-primary" onclick="openProfileWizard()">💜 Actualizar perfil bebé</button>
                    </div>
                </div>
                <div class="profile-highlights" id="profileHighlights"></div>
                <p id="profileHint" class="muted" style="margin-top:12px;">Usamos tu perfil para ajustar clima, modo recién nacido, fragancia 0 % y prebióticos.</p>
                <form id="profileForm" class="profile-form" onsubmit="saveProfile(event)">
                    <div class="profile-columns">
                        <div class="form-group">
                            <label for="skinType">Tipo de piel del bebé</label>
                            <select id="skinType" required>
                                <option value="">Selecciona una opción</option>
                                <option value="seca_atopica">Piel seca/atópica</option>
                                <option value="humeda_grasosa">Piel húmeda/grasosa</option>
                                <option value="normal_mixta">Piel normal/mixta</option>
                                <option value="ultra_sensitive">Ultra-sensitive (0 % fragancia)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="hairType">Edad del bebé</label>
                            <select id="hairType" required>
                                <option value="">Selecciona una opción</option>
                                <option value="0_3m">0-3 meses (modo recién nacido)</option>
                                <option value="3_12m">3-12 meses</option>
                                <option value="1_3y">1-3 años</option>
                                <option value="3_6y">3-6 años</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="faceShape">Clima y entorno</label>
                            <select id="faceShape" required>
                                <option value="">Selecciona una opción</option>
                                <option value="clima_seco_ac">Clima seco o aire acondicionado</option>
                                <option value="clima_humedo_calor">Clima húmedo o caliente</option>
                                <option value="transicion_estacional">Transición estacional</option>
                                <option value="agua_dura">Agua dura (cal/pozos)</option>
                                <option value="modo_viaje">Modo viaje</option>
                            </select>
                        </div>
                    </div>

                    <div class="profile-columns">
                        <div class="form-group">
                            <label>Preocupaciones de la piel del bebé</label>
                            <div class="checkbox-group" id="skinConcernsGroup">
                                <label class="checkbox-pill"><input type="checkbox" value="eccema leve" onchange="togglePill(this)">Eccema leve</label>
                                <label class="checkbox-pill"><input type="checkbox" value="dermatitis del pañal" onchange="togglePill(this)">Dermatitis del pañal</label>
                                <label class="checkbox-pill"><input type="checkbox" value="brote de calor" onchange="togglePill(this)">Brote de calor</label>
                                <label class="checkbox-pill"><input type="checkbox" value="irritación ocular" onchange="togglePill(this)">Irritación ocular</label>
                                <label class="checkbox-pill"><input type="checkbox" value="piel enrojecida" onchange="togglePill(this)">Piel enrojecida</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Preferencias de fórmula</label>
                            <div class="checkbox-group" id="hairConcernsGroup">
                                <label class="checkbox-pill"><input type="checkbox" value="0% fragancia" onchange="togglePill(this)">0 % fragancia</label>
                                <label class="checkbox-pill"><input type="checkbox" value="fragancia natural 0.3%" onchange="togglePill(this)">Fragancia natural 0.3 %</label>
                                <label class="checkbox-pill"><input type="checkbox" value="prebióticos microbiome" onchange="togglePill(this)">Prebióticos + microbiome</label>
                                <label class="checkbox-pill"><input type="checkbox" value="refill aluminio" onchange="togglePill(this)">Refill + aluminio</label>
                                <label class="checkbox-pill"><input type="checkbox" value="modo viaje" onchange="togglePill(this)">Modo viaje</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Objetivos principales</label>
                            <div class="checkbox-group" id="overallGoalsGroup">
                                <label class="checkbox-pill"><input type="checkbox" value="calmar eccema leve" onchange="togglePill(this)">Calmar eccema leve</label>
                                <label class="checkbox-pill"><input type="checkbox" value="control de humedad/pañal" onchange="togglePill(this)">Control de humedad/pañal</label>
                                <label class="checkbox-pill"><input type="checkbox" value="mantenimiento diario suave" onchange="togglePill(this)">Mantenimiento diario suave</label>
                                <label class="checkbox-pill"><input type="checkbox" value="microbiome friendly + prebióticos" onchange="togglePill(this)">Microbiome friendly + prebióticos</label>
                                <label class="checkbox-pill"><input type="checkbox" value="sin fragancia / tear-free" onchange="togglePill(this)">Sin fragancia / tear-free</label>
                            </div>
                        </div>
                    </div>

                    <div style="display:none;">
                        <button type="button">Cancelar</button>
                        <button type="submit">Guardar perfil</button>
                    </div>
                </form>
            </div>

            <div class="tabs" id="analysisEntry">
                <div class="tab active" onclick="switchTab('image', event)">📸 Analizar Imagen </div>
                <div class="tab" onclick="switchTab('text', event)">📝 Analizar Analysis</div>
            </div>

            <!-- Image Analysis Tab -->
            <div id="image-tab" class="tab-content active">
                <div class="upload-section">
                    <div class="upload-area">
                        <div class="upload-icon">📷</div>
                        <h3>Adjunta una imagen</h3>
                        <p>Toma una foto de los ingredientes de tu producto</p>
                        <input type="file" id="imageInput" class="file-input" accept="image/jpeg,image/png,image/webp,image/jpg">
                        <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                            Choose Image
                        </button>
                        <div id="imagePreview"></div>
                    </div>
                </div>

                <button class="analyze-btn" onclick="analyzeImage()">
                    🔍 Analizar Producto
                </button>
            </div>

            <!-- Text Analysis Tab -->
            <div id="text-tab" class="tab-content">
                <div class="form-group">
                    <label for="ingredientText">Lista de Ingredientes</label>
                    <textarea id="ingredientText" rows="6" placeholder="Paste your ingredient list here...&#10;Example:&#10;AQUA, GLYCERIN, DIMETHICONE, CYCLOPENTASILOXANE, BUTYLENE GLYCOL, SODIUM HYALURONATE, PHENOXYETHANOL, METHYLPARABEN, PROPYLPARABEN, FRAGRANCE"></textarea>
                </div>

                <button class="analyze-btn" onclick="analyzeText()">
                    🔍 Analizar Ingredientes
                </button>
            </div>

            <!-- Results Section -->
            <div id="results" class="results-section">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Analizando tu producto.... Puede tomar unos segundos.</p>
                </div>

                <div id="resultsContent" style="display: none;">
                    <!-- Results will be populated here -->
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API base URL - detect environment and use appropriate endpoint
        const API_BASE = (() => {
            if (typeof window === 'undefined') {
                return 'http://localhost:8000';
            }
            const { hostname, protocol } = window.location;
            const isLocalHost = !hostname || hostname === '' || hostname === 'localhost' || hostname === '127.0.0.1';
            const isLanHost = /^10\./.test(hostname || '') ||
                /^192\.168\./.test(hostname || '') ||
                /^172\.(1[6-9]|2\d|3[0-1])\./.test(hostname || '');
            if (protocol === 'file:' || isLocalHost || isLanHost) {
                return 'http://localhost:8000';
            }
            // Production - use relative /api path which Vercel rewrites to ngrok
            // This works for both vercel.app domains and custom domains
            return '/api';
        })();
        const PROFILE_STORAGE_KEY = 'mommyshopsProfile';
        let journeyStepItems = [];
        const PRODUCT_TYPE_CONTEXT = {
            hair: { label: 'Pelo', context: 'tu cuidado capilar' },
            face: { label: 'Cara', context: 'tu cuidado facial' },
            body: { label: 'Cuerpo', context: 'tu cuidado corporal' }
        };
        let currentProductTypeKey = null;
        let journeySections = [];
        let journeyScrollScheduled = false;
        let journeyScrollBound = false;
        let labsFormulationState = {
            controller: null,
            lastPayloadKey: null,
            lastResult: null
        };
        const defaultProfileData = () => ({
            skin_type: null,
            hair_type: null,
            face_shape: null,
            skin_concerns: [],
            hair_concerns: [],
            overall_goals: []
        });
        let profileWizardState = {
            step: 1,
            data: defaultProfileData()
        };

        const BABY_PRODUCTS = {
            nube_avena: {
                name: 'Nube de Avena',
                subtitle: 'Piel seca/atópica o clima seco/AC',
                price: '$11.90 (refill $6.90)',
                description: 'Hidratación intensiva para pieles muy secas o con eccema leve. Ajusta avena coloidal y karité según la sequedad detectada y mantiene el pH 5.5 tear-free.',
                bullets: [
                    '+30 % avena y karité cuando hay baja humedad',
                    'Prebióticos que fortalecen el microbioma',
                    'Modo ultra-sensitive 0 % fragancia'
                ]
            },
            brisa_te: {
                name: 'Brisa de Té Verde',
                subtitle: 'Piel húmeda/grasosa o clima húmedo/cálido',
                price: '$11.90 (refill $6.90)',
                description: 'Equilibra sebo y previene dermatitis del pañal en climas cálidos. Reduce emolientes pesados y aumenta hamamelis cuando la humedad supera 70 %.',
                bullets: [
                    'Hamamelis sin alcohol y aloe 99 %',
                    'Foam baby-safe que no obstruye poros',
                    'IA ajusta limpieza ligera vs. balance'
                ]
            },
            equilibrio_calendula: {
                name: 'Equilibrio de Caléndula',
                subtitle: 'Piel normal/mixta, transición estacional',
                price: '$10.90 (refill $5.90)',
                description: 'Blend diario para bebés sin problemas específicos. Nutre sin exceso y adapta caléndula/jojoba según edad y estación.',
                bullets: [
                    'Caléndula orgánica 3 % + jojoba golden',
                    'Modo fragancia natural 0.3 % o 0 %',
                    'Soporta cambios de clima sin irritar'
                ]
            }
        };

        function suggestBabyProduct(profile) {
            if (!profile) return null;
            const skin = (profile.skin_type || '').toLowerCase();
            const climate = (profile.face_shape || '').toLowerCase();
            if (skin === 'seca_atopica' || climate === 'clima_seco_ac') {
                return BABY_PRODUCTS.nube_avena;
            }
            if (skin === 'humeda_grasosa' || climate === 'clima_humedo_calor') {
                return BABY_PRODUCTS.brisa_te;
            }
            return BABY_PRODUCTS.equilibrio_calendula;
        }

        function startMainFlow() {
            const analyzerSection = document.getElementById('analizador');
            if (analyzerSection) {
                analyzerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            const imageInput = document.getElementById('imageInput');
            if (imageInput) {
                setTimeout(() => imageInput.focus(), 200);
            }
        }

        function scrollToLabsResult() {
            const labs = document.getElementById('labsFormulationMount');
            if (labs) {
                labs.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function setCurrentProductType(key) {
            currentProductTypeKey = key || null;
        }

        function updateProductTypeFromSelect(selectEl) {
            if (!selectEl) return;
            const value = selectEl.value || '';
            setCurrentProductType(value || null);
        }

        function getCurrentProductTypeInfo() {
            if (!currentProductTypeKey) return null;
            return PRODUCT_TYPE_CONTEXT[currentProductTypeKey] || null;
        }

        function getCurrentProductTypeLabel() {
            const info = getCurrentProductTypeInfo();
            return info ? info.label : null;
        }

        function getCurrentProductTypeContext() {
            const info = getCurrentProductTypeInfo();
            return info ? info.context : null;
        }

        function applyProductTypeContext(description) {
            const info = getCurrentProductTypeInfo();
            if (!info) {
                return description;
            }
            const baseText = (description || '').trim();
            const labelLower = info.label.toLowerCase();
            if (baseText.toLowerCase().includes(labelLower)) {
                return baseText;
            }
            const contextText = info.context || `tu cuidado de ${labelLower}`;
            if (!baseText) {
                return `Enfocado en ${contextText}.`;
            }
            const hasEndingPeriod = /[.!?]$/.test(baseText);
            return hasEndingPeriod
                ? `${baseText} Enfocado en ${contextText}.`
                : `${baseText}. Enfocado en ${contextText}.`;
        }

        function openSignupModal() {
            const modal = document.getElementById('signupModal');
            if (!modal) return;
            modal.classList.add('is-visible');
            modal.setAttribute('aria-hidden', 'false');
            const firstInput = modal.querySelector('input, select');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 0);
            }
        }

        function closeSignupModal() {
            const modal = document.getElementById('signupModal');
            if (!modal) return;
            modal.classList.remove('is-visible');
            modal.setAttribute('aria-hidden', 'true');
        }

        function setupProductTypeListeners() {
            ['userNeed', 'textUserNeed'].forEach(id => {
                const selectEl = document.getElementById(id);
                if (!selectEl) return;
                selectEl.addEventListener('change', () => updateProductTypeFromSelect(selectEl));
                if (selectEl.value) {
                    setCurrentProductType(selectEl.value);
                }
            });
        }

        function updateToggleIcon() {
            const assist = document.getElementById('assistPanel');
            const toggleIcon = document.getElementById('toggleIcon');
            if (!assist || !toggleIcon) return;
            const isOpen = assist.hasAttribute('open');
            toggleIcon.textContent = isOpen ? '−' : '+';
        }

        function toggleAssistPanel() {
            const assist = document.getElementById('assistPanel');
            if (!assist) return;
            const isOpen = assist.hasAttribute('open');
            if (isOpen) {
                assist.removeAttribute('open');
                localStorage.setItem('assist_open_state', 'false');
            } else {
                assist.setAttribute('open', '');
                localStorage.setItem('assist_open_state', 'true');
            }
            updateToggleIcon();
        }

        function collapseAssistPanel() {
            const assist = document.getElementById('assistPanel');
            if (!assist) return;
            assist.removeAttribute('open');
            localStorage.setItem('assist_open_state', 'false');
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeSignupModal();
                closeProfileWizard();
            }
        });

        document.addEventListener('click', (event) => {
            const modal = document.getElementById('signupModal');
            if (modal && event.target === modal) {
                closeSignupModal();
            }
            const wizard = document.getElementById('profileWizard');
            if (wizard && event.target === wizard) {
                closeProfileWizard();
            }
        });

        function setupSignupForm() {
            const form = document.getElementById('signupForm');
            if (!form || form.dataset.bound === 'true') {
                return;
            }
            form.dataset.bound = 'true';
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const formData = new FormData(form);
                const firstName = formData.get('firstName') || 'creador/a';
                const lastName = formData.get('lastName') || '';
                const email = formData.get('email') || '';
                const phone = formData.get('phone') || '';
                const country = formData.get('country') || '';
                
                // Disable submit button to prevent double submission
                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = 'Enviando...';
                
                try {
                    const payload = {
                        first_name: firstName,
                        last_name: lastName,
                        email: email,
                        phone: phone || null,
                        country: country
                    };
                    
                    console.log('Enviando datos:', payload);
                    console.log('API_BASE:', API_BASE);
                    
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    // Add ngrok header if using ngrok (production)
                    if (API_BASE === '/api' || API_BASE.includes('ngrok')) {
                        headers['ngrok-skip-browser-warning'] = 'true';
                    }
                    
                    // Create AbortController for timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                    
                    // Try without trailing slash first, then with
                    let url = `${API_BASE}/leads`;
                    console.log('Fetch URL:', url);
                    console.log('Fetch headers:', headers);
                    
                    let response;
                    try {
                        response = await fetch(url, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(payload),
                            signal: controller.signal,
                            mode: 'cors', // Explicitly set CORS mode
                            credentials: 'omit' // Don't send credentials
                        });
                        clearTimeout(timeoutId);
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        console.error('Fetch error details:', {
                            name: fetchError.name,
                            message: fetchError.message,
                            stack: fetchError.stack,
                            cause: fetchError.cause
                        });
                        
                        if (fetchError.name === 'AbortError') {
                            throw new Error('La solicitud tardó demasiado tiempo. Por favor, intenta de nuevo.');
                        }
                        
                        // Network error - server might be down or CORS issue
                        if (fetchError.message.includes('Failed to fetch') || 
                            fetchError.message.includes('NetworkError') ||
                            fetchError.message.includes('Network request failed')) {
                            throw new Error(`No se pudo conectar con el servidor. Verifica que el backend esté corriendo en ${API_BASE}`);
                        }
                        
                        throw fetchError;
                    }
                    
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'Error desconocido' }));
                        console.error('Error response:', errorData);
                        throw new Error(errorData.detail || `Error ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log('Lead creado:', result);
                    
                    closeSignupModal();
                    alert(`Gracias ${firstName}! Nuestro equipo Mommyshops se pondrá en contacto muy pronto.`);
                    form.reset();
                } catch (error) {
                    console.error('Error al enviar formulario:', error);
                    console.error('Error completo:', {
                        message: error.message,
                        name: error.name,
                        stack: error.stack,
                        cause: error.cause
                    });
                    
                    // Check if it's a network error
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        alert('No se pudo conectar con el servidor. Por favor, verifica tu conexión a internet o intenta más tarde.');
                    } else {
                        const errorMessage = error.message || 'Error desconocido';
                        alert(`Hubo un error al enviar tus datos: ${errorMessage}. Por favor, intenta de nuevo.`);
                    }
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = originalButtonText;
                }
            });
        }

        const GOAL_KEYWORDS = {
            'calmar eccema leve': ['eccem', 'eczema', 'oat', 'avena', 'bisabolol', 'karite', 'ceramid', 'panthenol', 'calm'],
            'control de humedad/pañal': ['humedad', 'diaper', 'pañal', 'hamamelis', 'aloe', 'zinc', 'sebo', 'oil control'],
            'mantenimiento diario suave': ['suave', 'gentle', 'ph 5.5', 'tear free', 'glucoside', 'mild', 'delicado'],
            'microbiome friendly + prebióticos': ['prebio', 'inulin', 'alfa-glucan', 'microbiome', 'flora', 'oligosac'],
            'sin fragancia / tear-free': ['sin fragancia', 'fragrance free', 'tear', '0% fragancia', 'hipoalerg'],
            // Compatibilidad retro (por si hay reglas previas)
            'una rutina limpia': ['suave', 'gentle', 'botan', 'natural', 'veg', 'clean', 'sin fragancia'],
            'hidratar intensamente con vitaminas': ['hidrat', 'humect', 'moist', 'hialuron', 'glicer', 'panthenol'],
            'calmar inflamaciones activas': ['antiinflam', 'calm', 'soothe', 'aloe', 'bisabolol', 'centella', 'oat'],
            'regular el exceso de grasa': ['sebo', 'oil control', 'seboreg', 'matific', 'purific', 'salic', 'bha', 'niacinamide'],
            'sumar antioxidantes anti-edad': ['antiage', 'antiedad', 'retino', 'peptid', 'colagen', 'resveratrol', 'firm']
        };

        const GOAL_MESSAGES = {
            'calmar eccema leve': 'calmar eccema leve',
            'control de humedad/pañal': 'control de humedad/pañal',
            'mantenimiento diario suave': 'mantenimiento diario suave',
            'microbiome friendly + prebióticos': 'microbiome friendly + prebióticos',
            'sin fragancia / tear-free': 'sin fragancia / tear-free',
            // Compatibilidad retro (por si hay reglas previas)
            'una rutina limpia': 'mantenimiento diario suave',
            'hidratar intensamente con vitaminas': 'mantenimiento diario suave',
            'calmar inflamaciones activas': 'calmar eccema leve',
            'regular el exceso de grasa': 'control de humedad/pañal',
            'sumar antioxidantes anti-edad': 'microbiome friendly + prebióticos'
        };

        const SKIN_TYPE_SUPPORT_KEYWORDS = {
            'seca_atopica': ['avena', 'oat', 'karite', 'shea', 'glicer', 'ceramid', 'panthenol', 'barrier', 'almendra'],
            'humeda_grasosa': ['hamamelis', 'witch hazel', 'seboreg', 'matific', 'oil control', 'light', 'aloe'],
            'normal_mixta': ['equilibr', 'balance', 'calendula', 'jojoba', 'hydration'],
            'ultra_sensitive': ['sin fragancia', 'fragrance free', 'calm', 'bisabolol', 'centella', 'tear free', 'ph 5.5']
        };

        const SKIN_TYPE_RISK_KEYWORDS = {
            'seca_atopica': ['sulfato', 'alcohol denat', 'detergente', 'astring', 'reseca', 'parfum', 'fragancia'],
            'humeda_grasosa': ['aceite mineral', 'oclusiv', 'pesado', 'comedog'],
            'normal_mixta': ['graso', 'pesado', 'irrit'],
            'ultra_sensitive': ['fragancia', 'parfum', 'alcohol denat', 'irrit']
        };

        const SKIN_TYPE_SUPPORT_LABELS = {
            'seca_atopica': 'nutrir piel seca/atópica con avena y karité',
            'humeda_grasosa': 'regular humedad/grasa con hamamelis',
            'normal_mixta': 'mantener piel normal/mixta equilibrada',
            'ultra_sensitive': 'proteger modo ultra-sensitive (0 % fragancia)'
        };

        const SKIN_TYPE_RISK_LABELS = {
            'seca_atopica': 'podría resecar la piel seca/atópica',
            'humeda_grasosa': 'podría obstruir o aportar grasa en clima húmedo',
            'normal_mixta': 'podría desbalancear tu piel normal/mixta',
            'ultra_sensitive': 'podría irritar piel ultra-sensitive'
        };

        const HAIR_TYPE_SUPPORT_KEYWORDS = {
            '0_3m': ['recién nacido', 'newborn', 'sin fragancia', 'tear free', 'ph 5.5'],
            '3_12m': ['suave', 'gentle', 'tear free', 'aloe'],
            '1_3y': ['prebio', 'microbiome', 'refuerzo barrera'],
            '3_6y': ['microbiome', 'limpieza suave', 'foam ligero']
        };

        const HAIR_TYPE_RISK_KEYWORDS = {
            '0_3m': ['aceites esenciales', 'fragancia', 'alcohol'],
            '3_12m': ['fragancia', 'sulfato fuerte', 'alcohol'],
            '1_3y': ['sulfato', 'irrit', 'fragancia fuerte'],
            '3_6y': ['sulfato', 'pesado', 'irrit']
        };

        const HAIR_TYPE_SUPPORT_LABELS = {
            '0_3m': 'modo recién nacido (0-3 m) sin fragancia',
            '3_12m': 'modo bebé 3-12 m tear-free',
            '1_3y': 'modo toddler con prebióticos',
            '3_6y': 'modo kids suave y equilibrado'
        };

        const HAIR_TYPE_RISK_LABELS = {
            '0_3m': 'evita fragancias o irritantes en 0-3 m',
            '3_12m': 'evita sulfatos/fragancias en 3-12 m',
            '1_3y': 'evita sulfatos fuertes en 1-3 años',
            '3_6y': 'evita detergentes agresivos en 3-6 años'
        };

        const FACE_ZONE_SUPPORT_KEYWORDS = {
            'clima_seco_ac': ['seco', 'dry', 'ac', 'aire acondicionado', 'baja humedad', 'oat', 'karite'],
            'clima_humedo_calor': ['humedad', 'humid', 'calor', 'heat', 'hamamelis', 'aloevera'],
            'transicion_estacional': ['estacional', 'transición', 'caléndula', 'balance'],
            'agua_dura': ['agua dura', 'hard water', 'quelante', 'chelating'],
            'modo_viaje': ['viaje', 'travel', 'compacto', 'refill']
        };

        const FACE_ZONE_RISK_KEYWORDS = {
            'clima_seco_ac': ['reseca', 'alcohol', 'sulfato fuerte'],
            'clima_humedo_calor': ['oclusiv', 'graso', 'pesado'],
            'transicion_estacional': ['irrit', 'desbalance'],
            'agua_dura': ['mineral buildup', 'residuo'],
            'modo_viaje': []
        };

        const FACE_ZONE_SUPPORT_LABELS = {
            'clima_seco_ac': 'reforzar en clima seco/AC con avena y karité',
            'clima_humedo_calor': 'equilibrar en clima húmedo/cálido',
            'transicion_estacional': 'adaptar a transición de estaciones',
            'agua_dura': 'proteger frente a agua dura',
            'modo_viaje': 'activar modo viaje y refills'
        };

        const FACE_ZONE_RISK_LABELS = {
            'clima_seco_ac': 'podría resecar en clima seco/AC',
            'clima_humedo_calor': 'podría sentirse pesado en clima húmedo',
            'transicion_estacional': 'podría irritar en transición estacional',
            'agua_dura': 'podría dejar residuos en agua dura',
            'modo_viaje': 'podría requerir ajuste de dosis en viaje'
        };

        const INGREDIENT_RULES_BASE = {
            'avena sativa': {
                aliases: ['oat', 'beta-glucan', 'avenasativa'],
                supports: [
                    { type: 'skin_concern', key: 'sensibilidad', label: 'calmar tu sensibilidad' },
                    { type: 'goal', key: 'calmar inflamaciones activas', label: 'calmar inflamaciones activas' },
                    { type: 'skin_type', key: 'sensible', label: 'proteger tu piel sensible' },
                    { type: 'goal', key: 'una rutina limpia', label: 'mantener tu rutina limpia con activos suaves' }
                ],
                summary: 'Calma e hidrata la piel sensible con avenantramidas.'
            },
            'camellia sinensis': {
                aliases: ['green tea', 'matcha', 'tea leaf'],
                supports: [
                    { type: 'goal', key: 'calmar inflamaciones activas', label: 'aportar antioxidantes antiinflamatorios' },
                    { type: 'goal', key: 'regular el exceso de grasa', label: 'regular el exceso de grasa' },
                    { type: 'skin_type', key: 'grasa', label: 'equilibrar la producción de sebo' },
                    { type: 'skin_concern', key: 'acné', label: 'apoyar piel con brotes' }
                ],
                summary: 'Controla el sebo y aporta antioxidantes potentes.'
            },
            'rosmarinus officinalis': {
                aliases: ['rosemary'],
                supports: [
                    { type: 'hair_concern', key: 'frizz', label: 'controlar el frizz y sellar cutícula' },
                    { type: 'hair_concern', key: 'falta de brillo', label: 'estimular el brillo natural' },
                    { type: 'goal', key: 'una rutina limpia', label: 'mantener una sensación herbal fresca' }
                ],
                summary: 'Estimula el cuero cabelludo y reduce el frizz.'
            },
            'serenoa repens': {
                aliases: ['saw palmetto'],
                supports: [
                    { type: 'goal', key: 'regular el exceso de grasa', label: 'equilibrar el sebo de piel y cuero cabelludo' },
                    { type: 'hair_concern', key: 'caída', label: 'fortalecer la fibra para reducir la caída' }
                ],
                summary: 'Regula la producción de sebo y cuida la raíz capilar.'
            },
            'linum usitatissimum': {
                aliases: ['linseed', 'flax', 'flaxseed'],
                supports: [
                    { type: 'hair_concern', key: 'resequedad', label: 'nutrir la resequedad extrema' },
                    { type: 'goal', key: 'hidratar intensamente con vitaminas', label: 'sellar hidratación duradera' },
                    { type: 'hair_type', key: 'rizado', label: 'definir tus rizos con humectación' },
                    { type: 'hair_concern', key: 'frizz', label: 'disminuir el frizz' }
                ],
                summary: 'Aporta mucílagos que definen rizos y sellan hidratación.'
            },
            'ginkgo biloba': {
                aliases: ['ginkgo'],
                supports: [
                    { type: 'goal', key: 'sumar antioxidantes anti-edad', label: 'sumar antioxidantes anti-edad' },
                    { type: 'skin_concern', key: 'arrugas', label: 'suavizar la aparición de arrugas' },
                    { type: 'hair_concern', key: 'caída', label: 'estimular la microcirculación' }
                ],
                summary: 'Estimula la microcirculación y protege frente a radicales libres.'
            },
            'tropaeolum majus': {
                aliases: ['nasturtium'],
                supports: [
                    { type: 'hair_concern', key: 'caída', label: 'estimular el crecimiento del cabello' },
                    { type: 'hair_concern', key: 'falta de brillo', label: 'potenciar el brillo natural' }
                ],
                summary: 'Oxigena la fibra capilar y devuelve luminosidad.'
            },
            'guazuma ulmifolia': {
                aliases: ['guazuma'],
                supports: [
                    { type: 'hair_concern', key: 'frizz', label: 'suavizar el encrespamiento' },
                    { type: 'hair_concern', key: 'resequedad', label: 'aportar elasticidad a cabellos resecos' }
                ],
                summary: 'Reestructura la fibra y controla el frizz rebelde.'
            },
            'bactris gasipaes': {
                aliases: ['peach palm', 'pejibaye'],
                supports: [
                    { type: 'goal', key: 'hidratar intensamente con vitaminas', label: 'hidratar intensamente con vitaminas' },
                    { type: 'hair_concern', key: 'resequedad', label: 'nutrir tu cabello reseco' },
                    { type: 'skin_concern', key: 'deshidratación', label: 'apoyar la hidratación de la piel' }
                ],
                summary: 'Rico en lípidos y antioxidantes para hidratación profunda.'
            },
            'sucuribuba': {
                aliases: ['sucuribuba bark'],
                supports: [
                    { type: 'skin_concern', key: 'sensibilidad', label: 'calmar piel reactiva' },
                    { type: 'goal', key: 'calmar inflamaciones activas', label: 'aportar efecto reparador' }
                ],
                summary: 'Extracto calmante con perfil antioxidante.'
            }
        };

        const INGREDIENT_SYNONYMS = {
            'green tea': 'camellia sinensis',
            'matcha': 'camellia sinensis',
            'tea leaf': 'camellia sinensis',
            'beta glucan': 'avena sativa',
            'oat': 'avena sativa',
            'oatmeal': 'avena sativa',
            'flaxseed': 'linum usitatissimum',
            'linseed': 'linum usitatissimum',
            'flax': 'linum usitatissimum',
            'peach palm': 'bactris gasipaes',
            'saw palmetto': 'serenoa repens',
            'rosemary': 'rosmarinus officinalis',
            'nasturtium': 'tropaeolum majus',
            'sucuribuba bark': 'sucuribuba'
        };

        const FUNCTION_KEYWORDS_BASE = {
            hydration: ['hydr', 'moist', 'humect', 'hyaluron', 'glicer', 'panthenol', 'linseed', 'flax', 'bactris'],
            soothing: ['calm', 'sooth', 'oat', 'aloe', 'centella', 'bisabolol', 'chamomile', 'sucuribuba'],
            sebum: ['seboreg', 'sebum', 'purific', 'salic', 'tea tree', 'camellia', 'niacinamide'],
            antiage: ['retin', 'peptid', 'collagen', 'resveratrol', 'ginkgo', 'bakuchiol', 'vitamin c'],
            frizz: ['frizz', 'smooth', 'guazuma', 'linseed'],
            strengthening: ['fortalec', 'keratin', 'protein', 'tropaeolum', 'biotin', 'serenoa'],
            detox: ['detox', 'charcoal', 'clay', 'willow', 'purific'],
            shine: ['shine', 'gloss', 'lustre', 'tropaeolum'],
            barrier: ['ceramide', 'beta-glucan', 'panthenol', 'oat'],
            botanical: ['extract', 'leaf', 'flower', 'root', 'seed', 'fruit', 'bark']
        };

        const FUNCTION_CATEGORY_MAP_BASE = {
            hydration: [
                { type: 'goal', key: 'hidratación profunda', label: 'proveer hidratación profunda' },
                { type: 'skin_concern', key: 'deshidratación', label: 'combatir la deshidratación' },
                { type: 'hair_concern', key: 'resequedad', label: 'nutrir el cabello reseco' }
            ],
            soothing: [
                { type: 'goal', key: 'calmar inflamaciones activas', label: 'calmar inflamaciones' },
                { type: 'skin_concern', key: 'sensibilidad', label: 'reducir la sensibilidad' }
            ],
            sebum: [
                { type: 'goal', key: 'regular el exceso de grasa', label: 'controlar el exceso de grasa' },
                { type: 'skin_type', key: 'grasa', label: 'equilibrar piel grasa' },
                { type: 'skin_concern', key: 'acné', label: 'apoyar piel con acné' }
            ],
            antiage: [
                { type: 'goal', key: 'sumar antioxidantes anti-edad', label: 'reforzar efectos anti-edad' },
                { type: 'skin_concern', key: 'arrugas', label: 'suavizar arrugas' }
            ],
            frizz: [
                { type: 'hair_concern', key: 'frizz', label: 'controlar el frizz' },
                { type: 'hair_type', key: 'rizado', label: 'definir rizos' }
            ],
            strengthening: [
                { type: 'hair_concern', key: 'caída', label: 'fortalecer la fibra capilar' }
            ],
            detox: [
                { type: 'goal', key: 'una rutina limpia', label: 'refrescar tu rutina limpia' },
                { type: 'skin_concern', key: 'acné', label: 'purificar la piel propensa a brotes' }
            ],
            shine: [
                { type: 'hair_concern', key: 'falta de brillo', label: 'aumentar el brillo natural' }
            ],
            barrier: [
                { type: 'skin_concern', key: 'sensibilidad', label: 'reforzar la barrera cutánea' }
            ],
            botanical: [
                { type: 'goal', key: 'una rutina limpia', label: 'aportar activos botánicos suaves' }
            ]
        };

        const FUNCTION_SUMMARY_BASE = {
            hydration: 'Aporta hidratación sostenida y confort duradero.',
            soothing: 'Calma irritaciones y ayuda a reparar la barrera.',
            sebum: 'Ayuda a controlar el sebo y prevenir brotes.',
            antiage: 'Refuerza la protección antioxidante y anti-edad.',
            frizz: 'Controla el frizz y mantiene los rizos definidos.',
            strengthening: 'Fortalece el folículo y disminuye la caída.',
            detox: 'Purifica e impulsa tu rutina limpia.',
            shine: 'Devuelve luminosidad sin dejar residuos.',
            barrier: 'Protege y repara la barrera cutánea.',
            botanical: 'Extracto botánico con perfil amable para rutinas limpias.'
        };

        const LEARNED_RULES_KEY = 'mommy_learned_rules_v1';

        const SKIN_CONCERN_SUPPORT_KEYWORDS = {
            'sensibilidad': ['calm', 'suav', 'hipoalergen', 'manzanilla', 'aloe', 'oat', 'centella'],
            'acné': ['acne', 'antibacter', 'purific', 'salic', 'bha', 'azelaic', 'niacinamide'],
            'manchas': ['mancha', 'ilumin', 'brighten', 'vitamina c', 'niacinamide'],
            'arrugas': ['antiage', 'colagen', 'peptid', 'firm', 'retino'],
            'deshidratación': ['hidrat', 'humect', 'moist', 'glicer', 'hialuron']
        };

        const SKIN_CONCERN_RISK_KEYWORDS = {
            'eccema leve': ['irrit', 'fragancia', 'parfum', 'sulfat', 'alcohol denat'],
            'dermatitis del pañal': ['irrit', 'perfume', 'petrolatum pesado'],
            'brote de calor': ['oclusiv', 'pesado', 'heat rash'],
            'irritación ocular': ['alcohol', 'fragancia', 'detergente'],
            'piel enrojecida': ['irrit', 'perfume', 'alcohol']
        };

        const HAIR_CONCERN_SUPPORT_KEYWORDS = {
            '0% fragancia': ['fragrance free', 'sin fragancia', '0% perfume'],
            'fragancia natural 0.3%': ['fragancia natural', 'essential oil', '0.3%'],
            'prebióticos microbiome': ['prebio', 'inulin', 'alfa-glucan', 'microbiome'],
            'refill aluminio': ['refill', 'aluminio', 'pouch'],
            'modo viaje': ['travel', 'compacto']
        };

        const HAIR_CONCERN_RISK_KEYWORDS = {
            '0% fragancia': ['fragancia', 'perfume'],
            'fragancia natural 0.3%': ['perfume alto', 'fragancia alta'],
            'prebióticos microbiome': [],
            'refill aluminio': [],
            'modo viaje': []
        };

        const FACE_ZONE_LABELS = {
            'clima_seco_ac': 'Clima seco/AC',
            'clima_humedo_calor': 'Clima húmedo/caliente',
            'transicion_estacional': 'Transición estacional',
            'agua_dura': 'Agua dura',
            'modo_viaje': 'Modo viaje'
        };

        function normalizeText(value) {
            return (value || '')
                .toString()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');
        }

        function matchesKeywords(text, keywords) {
            if (!text || !keywords || !keywords.length) return false;
            const normalized = normalizeText(text);
            return keywords.some(keyword => normalized.includes(normalizeText(keyword)));
        }

        function formatList(items) {
            if (!items || !items.length) return '';
            if (items.length === 1) return items[0];
            if (items.length === 2) return `${items[0]} y ${items[1]}`;
            const head = items.slice(0, -1).join(', ');
            return `${head} y ${items[items.length - 1]}`;
        }

        function getFaceZoneLabel(value) {
            return FACE_ZONE_LABELS[value] || value;
        }

        function hasValue(list, value) {
            if (!list) return false;
            const target = normalizeText(value);
            return list.some(item => normalizeText(item) === target);
        }

        function matchesProfileValue(value, target) {
            return normalizeText(value) === normalizeText(target);
        }

        function titleCase(text) {
            return (text || '')
                .toLowerCase()
                .split(' ')
                .map(word => word ? word.charAt(0).toUpperCase() + word.slice(1) : '')
                .join(' ');
        }

        function addEntry(map, type, key, label) {
            if (!label) return;
            const normalizedKey = `${type}:${(key || label).toString().toLowerCase()}`;
            if (!map.has(normalizedKey)) {
                map.set(normalizedKey, { type, key, label });
            }
        }

        function entriesToArray(map) {
            return Array.from(map.values());
        }

        function uniqueLabels(entries) {
            const seen = new Set();
            const result = [];
            entries.forEach(entry => {
                const label = entry.label;
                if (!label) return;
                const key = label.toLowerCase();
                if (!seen.has(key)) {
                    seen.add(key);
                    result.push(label);
                }
            });
            return result;
        }

        function uniqueStrings(list) {
            const seen = new Set();
            const ordered = [];
            (list || []).forEach(item => {
                if (item == null) return;
                const label = item.toString().trim();
                if (!label) return;
                const key = label.toLowerCase();
                if (!seen.has(key)) {
                    seen.add(key);
                    ordered.push(label);
                }
            });
            return ordered;
        }

        function scoreToPercent(value) {
            if (value == null) return null;
            const num = Number(value);
            if (!Number.isFinite(num)) return null;
            if (Math.abs(num) <= 1) {
                return Math.round(num * 100);
            }
            return Math.round(num);
        }

        function normalizeEvaluatedIngredients(list) {
            if (!Array.isArray(list)) {
                return [];
            }
            return list.map(item => {
                const name = item.inci || item.name || item.ingredient || '';
                const description = item.comment || item.description || item.analysis || '';
                return {
                    ...item,
                    ingredient: name || item.ingredient,
                    name: name || item.name || item.ingredient,
                    analysis: description,
                    description,
                    ewg_score: item.ewg_score ?? item.ewg ?? item.ewg_index,
                    eco_score: item.eco_score ?? item.eco ?? item.eco_index,
                    risk: item.state === 'conflict' || (Array.isArray(item.risk_flags) && item.risk_flags.length) ? 'high' : (item.state === 'neutral' ? 'moderate' : 'low'),
                    safety_level: item.state === 'conflict' ? 'caution' : 'safe'
                };
            });
        }

        function extractBaseIngredientNamesFromFormula(formula) {
            if (!formula || !Array.isArray(formula.base_ingredients)) {
                return [];
            }
            return formula.base_ingredients
                .map(item => item.inci || item.name || item.ingredient || '')
                .filter(Boolean);
        }

        function buildReplacementReason(to) {
            if (!to) return 'Alternativa recomendada';
            const parts = [];
            if (Array.isArray(to.benefits) && to.benefits.length) {
                parts.push(to.benefits.slice(0, 3).join(', '));
            }
            if (Array.isArray(to.safe_for) && to.safe_for.length) {
                parts.push(`Seguro para ${to.safe_for.join(', ')}`);
            }
            const deltaSource = to.delta_global ?? to.delta_compatibility;
            const delta = scoreToPercent(deltaSource);
            if (delta != null && delta !== 0) {
                parts.push(`${delta > 0 ? '+' : ''}${delta}% compatibilidad`);
            }
            return parts.length ? parts.join(' · ') : (to.reason || 'Alternativa recomendada');
        }

        function buildRecommendedReason(substitute) {
            if (!substitute) {
                return 'Sugerencia Mommyshops';
            }
            const tags = Array.isArray(substitute.tags) ? substitute.tags.slice(0, 3).join(', ') : '';
            if (tags) return tags;
            const delta = scoreToPercent(substitute.compatibility_delta);
            if (delta != null) {
                return `Δ compatibilidad ${delta}%`;
            }
            return 'Sugerencia Mommyshops';
        }

        function renderIngredientFilterButton(status, label, count, isActive) {
            return `<button type="button" class="ingredient-filter-btn ${isActive ? 'is-active' : ''}" data-ingredient-filter="${status}" onclick="filterIngredientCards('${status}')">${escapeHtml(label)} (${count})</button>`;
        }

        function getBenefitBadgeClass(label) {
            if (!label) return 'benefit-badge benefit-badge--default';
            const text = label.toLowerCase();
            if (text.includes('rutina') || text.includes('limpia')) return 'benefit-badge benefit-badge--clean';
            if (text.includes('hidrat')) return 'benefit-badge benefit-badge--hydrate';
            if (text.includes('calm') || text.includes('sensible')) return 'benefit-badge benefit-badge--calm';
            if (text.includes('sebo') || text.includes('balance') || text.includes('grasa')) return 'benefit-badge benefit-badge--balance';
            if (text.includes('antiox') || text.includes('vitamin')) return 'benefit-badge benefit-badge--antiox';
            return 'benefit-badge benefit-badge--default';
        }

        function buildBenefitBadges(evaluation) {
            if (!evaluation) return '';
            const supports = evaluation.supports || [];
            const labels = supports.map(entry => entry.label || entry).filter(Boolean);
            const unique = uniqueLabels(labels.map(label => ({ label }))).slice(0, 4);
            const badges = unique.length ? unique : (evaluation.summary ? [evaluation.summary] : []);
            if (!badges.length) {
                return '<span class="benefit-badge benefit-badge--default">Sin datos específicos</span>';
            }
            const extra = Math.max(0, labels.length - unique.length);
            const chips = badges.map(label => `<span class="${getBenefitBadgeClass(label)}">${escapeHtml(label)}</span>`);
            if (extra > 0) {
                chips.push(`<span class="benefit-badge benefit-badge--default">+${extra} beneficios</span>`);
            }
            return chips.join('');
        }

        function renderIngredientCard(item, profile) {
            const evaluation = computeIngredientUtility(item, profile);
            const badges = buildBenefitBadges(evaluation);
            const compat = determineIngredientCompatibility(item, evaluation);
            let statusIcon = '🌿';
            if (compat.level === 'medium') statusIcon = '🟡';
            if (compat.level === 'neutral') statusIcon = '⚪';
            if (compat.level === 'low') statusIcon = '⚠️';
            const ewgValue = item.ewg_score ?? item.ewg ?? item.ewg_index;
            const ecoValue = item.eco_score ?? item.eco ?? item.eco_index;
            const metaParts = [];
            if (ewgValue != null && ewgValue !== '') {
                metaParts.push(`EWG ${ewgValue}/10`);
            }
            if (ecoValue != null && ecoValue !== '') {
                metaParts.push(`Eco ${ecoValue}/100`);
            }
            const meta = metaParts.length ? metaParts.join(' · ') : 'Sin índices de referencia';
            const baseDescription = item.comment || item.analysis || evaluation.summary || 'Sin descripción personalizada.';
            const description = applyProductTypeContext(baseDescription);
            const datasetStatus = item.status || item.state || 'safe';
            const title = item.inci || item.ingredient || item.name || '-';
            return `
                <article class="ingredient-card" data-status="${datasetStatus}" data-level="${compat.level}">
                    <h4>${statusIcon} ${escapeHtml(title)}</h4>
                    <div class="ingredient-meta">${escapeHtml(meta)}</div>
                    <p class="muted" style="font-weight:600;">${escapeHtml(compat.label)}</p>
                    <p class="ingredient-description">${escapeHtml(description)}</p>
                    <div class="ingredient-benefits">
                        ${badges}
                    </div>
                </article>
            `;
        }

        function determineIngredientCompatibility(item, evaluation) {
            const state = (item.state || item.status || '').toLowerCase();
            if (['replace', 'conflict', 'warning', 'risk', 'critical'].includes(state)) {
                return { level: 'low', label: 'Baja compatibilidad — revisa sustitutos' };
            }
            if (state === 'neutral') {
                return { level: 'neutral', label: 'Compatibilidad neutra' };
            }
            if (['keep', 'compatible', 'safe', 'high'].includes(state)) {
                return { level: 'high', label: 'Alta compatibilidad — ideal para tu perfil' };
            }
            const percent = scoreToPercent(item.compatibility_percent ?? item.compatibility_score);
            if (percent != null) {
                if (percent >= 80) return { level: 'high', label: 'Alta compatibilidad — ideal para tu perfil' };
                if (percent >= 50) return { level: 'medium', label: 'Compatibilidad media — aporte complementario' };
                return { level: 'low', label: 'Baja compatibilidad — revisa sustitutos' };
            }
            const supports = evaluation?.supports?.length || 0;
            const conflicts = evaluation?.conflicts?.length || 0;
            if (conflicts > 0) {
                return { level: 'low', label: 'Baja compatibilidad — puede generar alertas' };
            }
            if (supports >= 2) {
                return { level: 'high', label: 'Alta compatibilidad — ideal para tu perfil' };
            }
            if (supports === 1) {
                return { level: 'medium', label: 'Compatibilidad media — aporte complementario' };
            }
            return { level: 'neutral', label: 'Sin datos específicos para tu perfil' };
        }

        window.filterIngredientCards = function(status) {
            const container = document.getElementById('ingredientsCardGrid');
            if (!container) return;
            const cards = container.querySelectorAll('.ingredient-card');
            cards.forEach(card => {
                const shouldShow = status === 'all'
                    || (status === 'safe' && card.dataset.status !== 'warning')
                    || (status === 'warning' && card.dataset.status === 'warning');
                card.style.display = shouldShow ? '' : 'none';
            });
            document.querySelectorAll('[data-ingredient-filter]').forEach(btn => {
                btn.classList.toggle('is-active', btn.getAttribute('data-ingredient-filter') === status);
            });
        }

        function buildSummaryFromEntries(supports, conflicts) {
            const supportSpecific = supports.filter(entry => entry.type !== 'general');
            const conflictSpecific = conflicts.filter(entry => entry.type !== 'general');
            const supportLabels = uniqueLabels(supportSpecific);
            const conflictLabels = uniqueLabels(conflictSpecific);

            if (!supportLabels.length && !conflictLabels.length) {
                return 'Neutral';
            }
            if (supportLabels.length && !conflictLabels.length) {
                return `Apoya ${formatList(supportLabels)}`;
            }
            if (!supportLabels.length && conflictLabels.length) {
                return `No recomendado: ${formatList(conflictLabels)}`;
            }
            return `Apoya ${formatList(supportLabels)}, pero ${formatList(conflictLabels)}`;
        }

        function evaluateIngredientUtility(ingredient, profile) {
            if (!profile || Object.keys(profile).length === 0) {
                return {
                    summary: 'Completa tu perfil para personalizar',
                    supports: [],
                    conflicts: []
                };
            }

            const { normalizedName, normalizedDescription: description, baseName, ruleEntry, summaryOverride, isLearned } = normalizeIngredientProfile(ingredient);
            const risk = (ingredient.risk || '').toLowerCase();
            const safetyLevel = (ingredient.safety_level || '').toLowerCase();

            const supportMap = new Map();
            const conflictMap = new Map();

            const goals = Array.isArray(profile.overall_goals) ? profile.overall_goals : [];
            goals.forEach(goal => {
                const key = goal.toLowerCase();
                const keywords = GOAL_KEYWORDS[key];
                if (keywords && matchesKeywords(description, keywords)) {
                    addEntry(supportMap, 'goal', key, GOAL_MESSAGES[key] || goal);
                }
            });

            const skinConcerns = Array.isArray(profile.skin_concerns) ? profile.skin_concerns : [];
            skinConcerns.forEach(concern => {
                const key = concern.toLowerCase();
                const supportKeywords = SKIN_CONCERN_SUPPORT_KEYWORDS[key];
                if (supportKeywords && matchesKeywords(description, supportKeywords)) {
                    addEntry(supportMap, 'skin_concern', key, `atender ${concern}`);
                }
                const riskKeywords = SKIN_CONCERN_RISK_KEYWORDS[key];
                if (riskKeywords && matchesKeywords(description, riskKeywords)) {
                    addEntry(conflictMap, 'skin_concern', key, `podría agravar ${concern}`);
                }
                if ((risk === 'high' || risk === 'critical' || safetyLevel === 'caution') && key === 'sensibilidad') {
                    addEntry(conflictMap, 'skin_concern', key, 'podría irritar piel sensible');
                }
                if ((risk === 'high' || risk === 'critical') && key === 'acné') {
                    addEntry(conflictMap, 'skin_concern', key, 'puede obstruir poros');
                }
            });

            const hairConcerns = Array.isArray(profile.hair_concerns) ? profile.hair_concerns : [];
            hairConcerns.forEach(concern => {
                const key = concern.toLowerCase();
                const supportKeywords = HAIR_CONCERN_SUPPORT_KEYWORDS[key];
                if (supportKeywords && matchesKeywords(description, supportKeywords)) {
                    addEntry(supportMap, 'hair_concern', key, `mejorar ${concern}`);
                }
                const riskKeywords = HAIR_CONCERN_RISK_KEYWORDS[key];
                if (riskKeywords && matchesKeywords(description, riskKeywords)) {
                    addEntry(conflictMap, 'hair_concern', key, `podría empeorar ${concern}`);
                }
            });

            const skinType = (profile.skin_type || '').toLowerCase();
            if (skinType) {
                const supportKeywords = SKIN_TYPE_SUPPORT_KEYWORDS[skinType];
                if (supportKeywords && matchesKeywords(description, supportKeywords)) {
                    addEntry(supportMap, 'skin_type', skinType, SKIN_TYPE_SUPPORT_LABELS[skinType] || `cuidar tu piel ${skinType}`);
                }
                const riskKeywords = SKIN_TYPE_RISK_KEYWORDS[skinType];
                if (riskKeywords && matchesKeywords(description, riskKeywords)) {
                    addEntry(conflictMap, 'skin_type', skinType, SKIN_TYPE_RISK_LABELS[skinType] || `puede no favorecer tu piel ${skinType}`);
                }
            }

            const hairType = (profile.hair_type || '').toLowerCase();
            if (hairType) {
                const supportKeywords = HAIR_TYPE_SUPPORT_KEYWORDS[hairType];
                if (supportKeywords && matchesKeywords(description, supportKeywords)) {
                    addEntry(supportMap, 'hair_type', hairType, HAIR_TYPE_SUPPORT_LABELS[hairType] || `favorece la edad ${hairType}`);
                }
                const riskKeywords = HAIR_TYPE_RISK_KEYWORDS[hairType];
                if (riskKeywords && matchesKeywords(description, riskKeywords)) {
                    addEntry(conflictMap, 'hair_type', hairType, HAIR_TYPE_RISK_LABELS[hairType] || `puede no ser ideal para la edad ${hairType}`);
                }
            }

            const faceZoneRaw = profile.face_shape || '';
            const faceZone = faceZoneRaw.toLowerCase();
            if (faceZone) {
                const supportKeywords = FACE_ZONE_SUPPORT_KEYWORDS[faceZone];
                if (supportKeywords && matchesKeywords(description, supportKeywords)) {
                    addEntry(supportMap, 'face_zone', faceZone, FACE_ZONE_SUPPORT_LABELS[faceZone] || `cuidar tus zonas faciales`);
                }
                const riskKeywords = FACE_ZONE_RISK_KEYWORDS[faceZone];
                if (riskKeywords && matchesKeywords(description, riskKeywords)) {
                    addEntry(conflictMap, 'face_zone', faceZone, FACE_ZONE_RISK_LABELS[faceZone] || `puede no adaptarse a tus zonas faciales`);
                }
            }

            if (risk === 'high' || risk === 'critical' || safetyLevel === 'caution') {
                addEntry(conflictMap, 'safety', 'high-risk', 'presenta riesgo alto, considera sustituirlo');
            }

            const combinedText = `${normalizedName} ${description}`;

            // Use ruleEntry from normalization if available
            if (ruleEntry) {
                (ruleEntry.supports || []).forEach(entry => {
                    if (!entry.requiresProfile || entry.requiresProfile(profile)) {
                        addEntry(supportMap, entry.type, entry.key, entry.label);
                    }
                });
                (ruleEntry.conflicts || []).forEach(entry => {
                    if (!entry.requiresProfile || entry.requiresProfile(profile)) {
                        addEntry(conflictMap, entry.type, entry.key, entry.label);
                    }
                });
            }

            if (description.includes('extracto natural') || description.includes('jugo natural')) {
                addEntry(supportMap, 'general', `botanico-${normalizedName}`, 'es un extracto botánico suave');
                if (hasValue(profile?.overall_goals, 'mantenimiento diario suave')) {
                    addEntry(supportMap, 'goal', 'mantenimiento diario suave', GOAL_MESSAGES['mantenimiento diario suave']);
                }
            }

            const supports = entriesToArray(supportMap);
            const conflicts = entriesToArray(conflictMap);
            const summary = buildSummaryFromEntries(supports, conflicts);

            return {
                summary,
                supports,
                conflicts
            };
        }

        function normalizeIngredientProfile(ingredient) {
            const descriptionRaw = `${ingredient.description || ''} ${ingredient.analysis || ''} ${ingredient.comment || ''}`;
            const normalizedDescription = normalizeText(descriptionRaw);
            const rawName = (ingredient.name || ingredient.ingredient || ingredient.inci || '').trim();
            const normalizedName = normalizeText(rawName);
            const baseName = INGREDIENT_SYNONYMS[normalizedName] || normalizedName;
            const learnedRules = JSON.parse(localStorage.getItem(LEARNED_RULES_KEY) || "{}");
            const learnedEntry = learnedRules[baseName];
            const cumulativeRules = {
                ...INGREDIENT_RULES_BASE,
                ...(learnedRules || {}),
            };
            let ruleEntry = cumulativeRules[baseName] || null;
            let summaryOverride = ruleEntry?.summary || learnedEntry?.summary || null;

            if (!ruleEntry) {
                const directMatch = Object.entries(INGREDIENT_RULES_BASE).find(([key, value]) => {
                    const cleanKey = normalizeText(key);
                    if (normalizedName.includes(cleanKey)) return true;
                    return value.aliases && value.aliases.some(alias => normalizedName.includes(normalizeText(alias)));
                });
                if (directMatch) {
                    ruleEntry = directMatch[1];
                    summaryOverride = ruleEntry.summary || summaryOverride;
                }
            }
            const isLearned = Boolean(ruleEntry && learnedEntry);

            if (!ruleEntry) {
                const guessedFunction = guessFunctionFromName(normalizedName) || guessFunctionFromDescription(normalizedDescription);
                if (guessedFunction) {
                    const mappedCategories = FUNCTION_CATEGORY_MAP_BASE[guessedFunction] || [];
                    if (mappedCategories.length) {
                        ruleEntry = {
                            supports: mappedCategories.map(item => ({
                                type: item.type,
                                key: item.key,
                                label: item.label,
                                requiresProfile: null,
                            })),
                            summary: FUNCTION_SUMMARY_BASE[guessedFunction] || null,
                        };
                        summaryOverride = ruleEntry.summary;
                    }
                }
            }

            return { descriptionRaw, normalizedDescription, rawName, normalizedName, baseName, ruleEntry, summaryOverride, isLearned };
        }

        function guessFunctionFromName(normalizedName) {
            if (!normalizedName) return null;
            for (const [functionKey, keywords] of Object.entries(FUNCTION_KEYWORDS_BASE)) {
                if (keywords.some(keyword => normalizedName.includes(normalizeText(keyword)))) {
                    return functionKey;
                }
            }
            return null;
        }

        function guessFunctionFromDescription(normalizedDescription) {
            if (!normalizedDescription) return null;
            for (const [functionKey, keywords] of Object.entries(FUNCTION_KEYWORDS_BASE)) {
                if (keywords.some(keyword => normalizedDescription.includes(normalizeText(keyword)))) {
                    return functionKey;
                }
            }
            return null;
        }

        function computeIngredientUtility(ingredient, profile) {
            return evaluateIngredientUtility(ingredient, profile);
        }

        function renderUtilityCell(evaluation) {
            if (!evaluation) {
                return '<div class="utility-summary">Sin datos específicos</div>';
            }

            const supportEntries = evaluation.supports || [];
            const conflictEntries = evaluation.conflicts || [];

            const supportSpecific = supportEntries.filter(entry => entry.type && entry.type !== 'general');
            const conflictSpecific = conflictEntries.filter(entry => entry.type && entry.type !== 'general');
            const generalSupports = supportEntries.filter(entry => entry.type === 'general');

            const supportLabels = uniqueLabels(supportSpecific.length ? supportSpecific : supportEntries);
            const conflictLabels = uniqueLabels(conflictSpecific.length ? conflictSpecific : conflictEntries);
            const generalLabels = uniqueLabels(generalSupports);

            const chips = [];
            supportLabels.forEach(label => {
                chips.push(`<span class="utility-chip utility-chip--support">✔ ${escapeHtml(label)}</span>`);
            });
            conflictLabels.forEach(label => {
                chips.push(`<span class="utility-chip utility-chip--conflict">⚠ ${escapeHtml(label)}</span>`);
            });

            const generalNote = generalLabels.length
                ? `<div class="utility-note">${escapeHtml(generalLabels.join('. '))}</div>`
                : '';

            return `
                <div class="utility-summary">${escapeHtml(evaluation.summary || 'Neutral')}</div>
                ${chips.length ? `<div class="utility-chips">${chips.join('')}</div>` : ''}
                ${generalNote}
            `;
        }
        function computeProfileIngredientAlignment(structuredReport, profile) {
            if (!profile || Object.keys(profile).length === 0) {
                return null;
            }
            const evaluated = normalizeEvaluatedIngredients(structuredReport?.ingredients_evaluated);
            const safe = normalizeEvaluatedIngredients(structuredReport?.safety?.safe);
            const problematic = normalizeEvaluatedIngredients(structuredReport?.safety?.problematic);
            const combined = evaluated.length ? evaluated : [...safe, ...problematic];
            if (!combined.length) {
                return null;
            }

            const totalIngredients = combined.length;
            const supportMap = new Map();
            const conflictMap = new Map();
            const categoryMap = new Map();
            const ingredientSummary = new Map();
            const compatibilityLabelMap = {
                high: 'Alta compatibilidad',
                medium: 'Compatibilidad media',
                low: 'Baja compatibilidad',
                neutral: 'Compatibilidad neutra'
            };

            const ensureCategory = (type, key, label) => {
                if (!key && !label) return null;
                const categoryKey = `${type}:${key || label}`.toLowerCase();
                if (!categoryMap.has(categoryKey)) {
                    categoryMap.set(categoryKey, {
                        type,
                        key,
                        label,
                        supported: 0,
                        conflicting: 0
                    });
                }
                return categoryMap.get(categoryKey);
            };

            const goals = profile.overall_goals || [];
            goals.forEach(goal => {
                const key = goal.toLowerCase();
                ensureCategory('goal', key, GOAL_MESSAGES[key] || titleCase(goal));
            });

            const skinConcerns = profile.skin_concerns || [];
            skinConcerns.forEach(concern => {
                const key = concern.toLowerCase();
                ensureCategory('skin_concern', key, `Preocupación piel: ${titleCase(concern)}`);
            });

            const hairConcerns = profile.hair_concerns || [];
            hairConcerns.forEach(concern => {
                const key = concern.toLowerCase();
                ensureCategory('hair_concern', key, `Preferencia: ${titleCase(concern)}`);
            });

            if (profile.skin_type) {
                ensureCategory('skin_type', profile.skin_type.toLowerCase(), `Piel ${titleCase(profile.skin_type)}`);
            }
            if (profile.hair_type) {
                ensureCategory('hair_type', profile.hair_type.toLowerCase(), `Edad ${titleCase(profile.hair_type)}`);
            }
            if (profile.face_shape) {
                ensureCategory('face_zone', normalizeText(profile.face_shape), `Clima: ${getFaceZoneLabel(profile.face_shape)}`);
            }

            let supportiveCount = 0;
            let conflictCount = 0;

            combined.forEach(item => {
                const evaluation = evaluateIngredientUtility(item, profile);
                if (evaluation.supports.length) {
                    supportiveCount += 1;
                    evaluation.supports.forEach(entry => {
                        addEntry(supportMap, entry.type || 'general', entry.key || entry.label, entry.label);
                        if (entry.type && entry.type !== 'general') {
                            const category = ensureCategory(entry.type, (entry.key || '').toLowerCase(), entry.label);
                            if (category) {
                                category.supported += 1;
                            }
                        }
                    });
                }
                if (evaluation.conflicts.length) {
                    conflictCount += 1;
                    evaluation.conflicts.forEach(entry => {
                        addEntry(conflictMap, entry.type || 'general', entry.key || entry.label, entry.label);
                        if (entry.type && entry.type !== 'general') {
                            const category = ensureCategory(entry.type, (entry.key || '').toLowerCase(), entry.label);
                            if (category) {
                                category.conflicting += 1;
                            }
                        }
                    });
                }

                const ingredientName = item.inci || item.ingredient || item.name || 'Ingrediente';
                const compat = determineIngredientCompatibility(item, evaluation);
                const objectiveSource = evaluation.supports.find(entry => entry.type === 'goal')
                    || evaluation.supports.find(entry => entry.type && entry.type !== 'general')
                    || evaluation.conflicts.find(entry => entry.type === 'goal')
                    || evaluation.conflicts.find(entry => entry.type && entry.type !== 'general')
                    || null;
                const fallbackGoal = (profile.overall_goals || [])[0] || 'Objetivo general';
                const objectiveLabel = objectiveSource
                    ? titleCase(objectiveSource.label || objectiveSource)
                    : titleCase(fallbackGoal);
                const key = ingredientName.toLowerCase();
                const current = ingredientSummary.get(key);
                const level = compat.level || 'neutral';
                const labelText = compatibilityLabelMap[level] || compatibilityLabelMap.neutral;
                if (!current) {
                    ingredientSummary.set(key, {
                        ingredient: ingredientName,
                        objective: objectiveLabel,
                        level,
                        label: labelText
                    });
                }
            });

            const categories = Array.from(categoryMap.values()).filter(category => {
                return category.supported > 0 || category.conflicting > 0;
            }).map(category => ({
                ...category,
                total: totalIngredients,
                evidence: category.supported + category.conflicting
            }));

            const supportHighlightsAll = entriesToArray(supportMap);
            const conflictHighlightsAll = entriesToArray(conflictMap);
            const supportHighlightsSpecific = supportHighlightsAll.filter(entry => entry.type && entry.type !== 'general');
            const conflictHighlightsSpecific = conflictHighlightsAll.filter(entry => entry.type && entry.type !== 'general');

            return {
                supportiveCount,
                conflictCount,
                supports: uniqueLabels(supportHighlightsSpecific.length ? supportHighlightsSpecific : supportHighlightsAll),
                conflicts: uniqueLabels(conflictHighlightsSpecific.length ? conflictHighlightsSpecific : conflictHighlightsAll),
                categories,
                totalIngredients,
                ingredientRows: Array.from(ingredientSummary.values())
            };
        }

        function initializeJourneySteps() {
            journeyStepItems = Array.from(document.querySelectorAll('#journeySteps .steps-item'));
            journeyStepItems.forEach(item => item.classList.remove('is-active', 'is-complete'));
            setStepStatus(1, 'active');
            setupJourneyNavigation();
        }

        function setStepStatus(step, status) {
            const item = journeyStepItems.find(el => Number(el.dataset.step) === Number(step));
            if (!item) return;
            item.classList.remove('is-active', 'is-complete');
            if (status === 'active') {
                item.classList.add('is-active');
            } else if (status === 'completed') {
                item.classList.add('is-complete');
            }
        }

        function activateStep(step) {
            journeyStepItems.forEach(el => {
                const stepNumber = Number(el.dataset.step);
                if (stepNumber < step) {
                    setStepStatus(stepNumber, 'completed');
                } else if (stepNumber === step) {
                    setStepStatus(stepNumber, 'active');
                } else {
                    setStepStatus(stepNumber, 'pending');
                }
            });
        }

        function highlightJourneyStep(step) {
            if (!journeyStepItems.length) {
                journeyStepItems = Array.from(document.querySelectorAll('#journeySteps .steps-item'));
            }
            journeyStepItems.forEach(item => {
                const matches = Number(item.dataset.step) === Number(step);
                item.classList.toggle('is-nav-focus', matches && step != null);
                if (!matches && step == null) {
                    item.classList.remove('is-nav-focus');
                }
            });
        }

        function handleJourneyScroll() {
            if (journeyScrollScheduled) return;
            journeyScrollScheduled = true;
            requestAnimationFrame(() => {
                const offset = window.scrollY + 160;
                let current = null;
                journeySections.forEach(section => {
                    const top = section.element ? section.element.offsetTop : 0;
                    if (top <= offset) {
                        current = section.step;
                    }
                });
                highlightJourneyStep(current);
                journeyScrollScheduled = false;
            });
        }

        function setupJourneyNavigation() {
            journeyStepItems = Array.from(document.querySelectorAll('#journeySteps .steps-item'));
            journeyStepItems.forEach(item => {
                if (!item.dataset.navBound) {
                    item.addEventListener('click', (event) => {
                        const targetId = item.dataset.target;
                        if (!targetId) return;
                        const target = document.getElementById(targetId);
                        if (!target) return;
                        event.preventDefault();
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    });
                    item.dataset.navBound = 'true';
                }
            });
            journeySections = journeyStepItems
                .map(item => {
                    const targetId = item.dataset.target;
                    const target = targetId ? document.getElementById(targetId) : null;
                    if (!target) return null;
                    return { step: Number(item.dataset.step), element: target };
                })
                .filter(Boolean)
                .sort((a, b) => (a.element.offsetTop || 0) - (b.element.offsetTop || 0));
            if (!journeyScrollBound) {
                window.addEventListener('scroll', handleJourneyScroll, { passive: true });
                journeyScrollBound = true;
            }
            handleJourneyScroll();
        }

        function getStoredProfile() {
            try {
                const raw = localStorage.getItem(PROFILE_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                return parsed && Object.keys(parsed).length ? parsed : null;
            } catch (error) {
                console.warn('Unable to read profile from storage', error);
                return null;
            }
        }

        function serializeProfileFromForm() {
            const getCheckedValues = (containerId) => {
                return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`))
                    .map(input => input.value);
            };

            const profile = {
                skin_type: document.getElementById('skinType').value || null,
                hair_type: document.getElementById('hairType').value || null,
                face_shape: document.getElementById('faceShape').value || null,
                skin_concerns: getCheckedValues('skinConcernsGroup'),
                hair_concerns: getCheckedValues('hairConcernsGroup'),
                overall_goals: getCheckedValues('overallGoalsGroup'),
            };

            // Remove empty arrays/strings
            Object.keys(profile).forEach(key => {
                const value = profile[key];
                if (Array.isArray(value) && value.length === 0) {
                    profile[key] = [];
                } else if (value === '') {
                    profile[key] = null;
                }
            });
            return profile;
        }

        function applyProfileToForm(profile) {
            const skinSelect = document.getElementById('skinType');
            const hairSelect = document.getElementById('hairType');
            const faceSelect = document.getElementById('faceShape');

            skinSelect.value = profile?.skin_type || '';
            hairSelect.value = profile?.hair_type || '';
            faceSelect.value = profile?.face_shape || '';

            const syncCheckboxes = (containerId, values = []) => {
                const inputs = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
                inputs.forEach(input => {
                    const checked = values.includes(input.value);
                    input.checked = checked;
                    input.parentElement.classList.toggle('active', checked);
                });
            };

            syncCheckboxes('skinConcernsGroup', profile?.skin_concerns || []);
            syncCheckboxes('hairConcernsGroup', profile?.hair_concerns || []);
            syncCheckboxes('overallGoalsGroup', profile?.overall_goals || []);
        }

        function renderProfile(profile) {
            const pill = document.getElementById('profilePill');
            const hero = document.getElementById('profileHeroTitle');
            const subtitle = document.getElementById('profileSubtitle');
            const highlights = document.getElementById('profileHighlights');
            const hint = document.getElementById('profileHint');

            if (!pill || !hero || !highlights) return;

            highlights.innerHTML = '';

            if (!profile || !Object.keys(profile).length) {
                pill.textContent = 'Perfil incompleto';
                hero.textContent = 'Diseñemos la fórmula Mommyshops Bebé para tu hijo/a';
                subtitle.textContent = 'Cuéntanos edad, tipo de piel y clima para recomendar la versión exacta (Nube de Avena, Brisa de Té Verde o Equilibrio de Caléndula).';
                hint.textContent = 'Usamos tu perfil para ajustar clima, modo recién nacido, fragancia 0 % y prebióticos.';
                highlights.innerHTML = '<span class="muted">Completa tu perfil para desbloquear recomendaciones personalizadas.</span>';
                return;
            }

            pill.textContent = 'Perfil activo';
            hero.textContent = 'Perfil Mommyshops Bebé';
            subtitle.textContent = 'Aplicamos tu edad, clima y preferencias (fragancia, prebióticos, refill) en cada análisis.';
            const summaryParts = [];
            if (profile.skin_type) summaryParts.push(`piel ${profile.skin_type}`);
            if (profile.face_shape) summaryParts.push(`clima ${profile.face_shape}`);
            if (profile.hair_type) summaryParts.push(`edad ${profile.hair_type}`);
            hint.textContent = summaryParts.length
                ? `Basado en ${summaryParts.join(' y ')}, preferencias y objetivos declarados.`
                : 'Tus datos nos permiten personalizar cada resultado.';

            const chipTexts = [];
            if (profile.skin_type) chipTexts.push(`Piel: ${titleCase(profile.skin_type.replace(/_/g, ' '))}`);
            if (profile.face_shape) chipTexts.push(`Clima: ${getFaceZoneLabel(profile.face_shape)}`);
            if (profile.hair_type) chipTexts.push(`Edad: ${titleCase(profile.hair_type.replace(/_/g, ' '))}`);
            (profile.skin_concerns || []).slice(0, 3).forEach(item => chipTexts.push(`Piel: ${titleCase(item)}`));
            (profile.hair_concerns || []).slice(0, 3).forEach(item => chipTexts.push(`Preferencia: ${titleCase(item)}`));
            (profile.overall_goals || []).slice(0, 4).forEach(item => chipTexts.push(titleCase(item)));

            if (!chipTexts.length) {
                highlights.innerHTML = '<span class="muted">Añade tus objetivos para personalizar más los resultados.</span>';
                return;
            }

            highlights.innerHTML = chipTexts.map(text => `<span class="profile-highlight">${escapeHtml(text)}</span>`).join('');
        }

        window.toggleProfileForm = function toggleProfileForm() {};

        function showProfileToast(message) {
            const toast = document.getElementById('profileToast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.add('is-visible');
            clearTimeout(showProfileToast.timer);
            showProfileToast.timer = setTimeout(() => toast.classList.remove('is-visible'), 2600);
        }

        function togglePill(input) {
            input.parentElement.classList.toggle('active', input.checked);
        }

        function persistProfile(profile, options = {}) {
            localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profile));
            applyProfileToForm(profile);
            renderProfile(profile);
            attemptSyncProfile(profile);
            setStepStatus(1, 'completed');
            setStepStatus(2, 'active');
            if (options.toast !== false) {
                showProfileToast(options.toastMessage || 'Perfil actualizado 💜');
            }
        }

        window.resetProfile = function resetProfile() {
            localStorage.removeItem(PROFILE_STORAGE_KEY);
            profileWizardState.data = defaultProfileData();
            applyProfileToForm(null);
            renderProfile(null);
            setStepStatus(1, 'active');
            setStepStatus(2, 'pending');
            showProfileToast('Perfil restablecido');
        }

        async function attemptSyncProfile(profile) {
            try {
                const response = await fetch(`${API_BASE}/profile/me`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profile)
                });
                if (!response.ok) {
                    console.info('Profile sync skipped:', response.status);
                }
            } catch (error) {
                console.info('Profile sync unavailable:', error.message);
            }
        }

        window.saveProfile = async function saveProfile(event) {
            event.preventDefault();
            const profile = serializeProfileFromForm();

            if (!profile.skin_type || !profile.hair_type || !profile.face_shape) {
                alert('Por favor elige tu tipo de piel del bebé, edad y clima.');
                return;
            }

            persistProfile(profile, { toastMessage: 'Perfil actualizado 🤍' });
        }

        function getProfileForRequest() {
            return getStoredProfile();
        }

        function ensureProfileReady() {
            const profile = getStoredProfile();
            if (profile) {
                applyProfileToForm(profile);
                renderProfile(profile);
                setStepStatus(1, 'completed');
                setStepStatus(2, 'active');
            } else {
                applyProfileToForm(null);
                renderProfile(null);
                setStepStatus(1, 'active');
            }
        }

        function syncWizardChips() {
            const chips = document.querySelectorAll('.wizard-chip');
            chips.forEach(chip => {
                const field = chip.dataset.field;
                const value = chip.dataset.value;
                const mode = chip.dataset.mode || 'single';
                let isActive = false;
                if (mode === 'single') {
                    isActive = profileWizardState.data[field] === value;
                } else {
                    const arr = profileWizardState.data[field] || [];
                    isActive = arr.includes(value);
                }
                chip.classList.toggle('is-active', isActive);
            });
        }

        function goToProfileWizardStep(step) {
            profileWizardState.step = Math.max(1, Math.min(3, step));
            const steps = document.querySelectorAll('.wizard-step');
            steps.forEach(stepEl => {
                const isActive = Number(stepEl.dataset.step) === profileWizardState.step;
                stepEl.classList.toggle('is-active', isActive);
            });
            const progress = document.getElementById('profileWizardProgress');
            if (progress) {
                progress.textContent = `Paso ${profileWizardState.step} de 3`;
            }
            const primaryButton = document.getElementById('wizardPrimaryButton');
            if (primaryButton) {
                primaryButton.textContent = profileWizardState.step === 3 ? 'Guardar y continuar' : 'Siguiente';
            }
            const prevButton = document.getElementById('wizardPrevButton');
            if (prevButton) {
                prevButton.disabled = profileWizardState.step === 1;
            }
        }

        window.openProfileWizard = function openProfileWizard() {
            const stored = getStoredProfile();
            profileWizardState.data = stored
                ? {
                    skin_type: stored.skin_type || null,
                    hair_type: stored.hair_type || null,
                    face_shape: stored.face_shape || null,
                    skin_concerns: [...(stored.skin_concerns || [])],
                    hair_concerns: [...(stored.hair_concerns || [])],
                    overall_goals: [...(stored.overall_goals || [])]
                }
                : defaultProfileData();
            const wizard = document.getElementById('profileWizard');
            if (!wizard) return;
            wizard.classList.add('is-visible');
            wizard.setAttribute('aria-hidden', 'false');
            goToProfileWizardStep(1);
            syncWizardChips();
        }

        window.closeProfileWizard = function closeProfileWizard() {
            const wizard = document.getElementById('profileWizard');
            if (!wizard) return;
            wizard.classList.remove('is-visible');
            wizard.setAttribute('aria-hidden', 'true');
            profileWizardState.step = 1;
        }

        window.handleWizardChip = function handleWizardChip(button) {
            const field = button.dataset.field;
            const value = button.dataset.value;
            const mode = button.dataset.mode || 'single';
            if (mode === 'single') {
                profileWizardState.data[field] = value;
            } else {
                const arr = new Set(profileWizardState.data[field] || []);
                if (arr.has(value)) {
                    arr.delete(value);
                } else {
                    arr.add(value);
                }
                profileWizardState.data[field] = Array.from(arr);
            }
            syncWizardChips();
        }

        window.nextProfileWizardStep = function nextProfileWizardStep() {
            if (profileWizardState.step === 3) {
                saveProfileFromWizard();
            } else {
                goToProfileWizardStep(profileWizardState.step + 1);
            }
        }

        window.prevProfileWizardStep = function prevProfileWizardStep() {
            if (profileWizardState.step === 1) return;
            goToProfileWizardStep(profileWizardState.step - 1);
        }

        function buildProfileFromWizard() {
            return {
                skin_type: profileWizardState.data.skin_type,
                hair_type: profileWizardState.data.hair_type,
                face_shape: profileWizardState.data.face_shape,
                skin_concerns: profileWizardState.data.skin_concerns || [],
                hair_concerns: profileWizardState.data.hair_concerns || [],
                overall_goals: profileWizardState.data.overall_goals || [],
            };
        }

        function saveProfileFromWizard() {
            const profile = buildProfileFromWizard();
            if (!profile.skin_type || !profile.hair_type || !profile.face_shape) {
                alert('Selecciona al menos tipo de piel, edad y clima del bebé.');
                return;
            }
            persistProfile(profile, { toastMessage: 'Perfil listo para personalizar tus análisis ✨' });
            closeProfileWizard();
        }

        function buildCollapsibleCard({ title, subtitle = '', badgeHtml = '', bodyHtml = '', classes = '', defaultOpen = true }) {
            const openAttr = defaultOpen ? ' open' : '';
            const subtitleHtml = subtitle ? `<span class="summary-subtitle">${subtitle}</span>` : '';
            const metaContent = badgeHtml ? `${badgeHtml}<span class="collapse-icon" aria-hidden="true"></span>` : `<span class="collapse-icon" aria-hidden="true"></span>`;

            return `
                <section class="result-card ${classes}">
                    <details class="card-collapse"${openAttr}>
                        <summary>
                            <span class="summary-info">
                                <span class="result-title">${title}</span>
                                ${subtitleHtml}
                            </span>
                            <span class="summary-meta">
                                ${metaContent}
                            </span>
                        </summary>
                        <div class="card-body">
                            ${bodyHtml}
                        </div>
                    </details>
                </section>
            `;
        }

        function renderProfileResult(profile) {
            if (!profile || Object.keys(profile).length === 0) {
                return '';
            }
            const lines = [];
            if (profile.skin_type) lines.push(`<li><strong>Piel:</strong> ${escapeHtml(profile.skin_type)}</li>`);
            if (profile.hair_type) lines.push(`<li><strong>Edad:</strong> ${escapeHtml(profile.hair_type)}</li>`);
            if (profile.face_shape) lines.push(`<li><strong>Clima/entorno:</strong> ${escapeHtml(getFaceZoneLabel(profile.face_shape))}</li>`);
            if (Array.isArray(profile.skin_concerns) && profile.skin_concerns.length) {
                const concerns = profile.skin_concerns.map(escapeHtml).join(', ');
                lines.push(`<li><strong>Preocupaciones de piel:</strong> ${concerns}</li>`);
            }
            if (Array.isArray(profile.hair_concerns) && profile.hair_concerns.length) {
                const concerns = profile.hair_concerns.map(escapeHtml).join(', ');
                lines.push(`<li><strong>Preferencias de fórmula:</strong> ${concerns}</li>`);
            }
            if (Array.isArray(profile.overall_goals) && profile.overall_goals.length) {
                const goals = profile.overall_goals.map(escapeHtml).join(', ');
                lines.push(`<li><strong>Objetivos:</strong> ${goals}</li>`);
            }
            if (!lines.length) return '';
            const body = `
                <ul style="list-style: disc; padding-left: 20px;">
                    ${lines.join('')}
                </ul>
            `;
            return buildCollapsibleCard({
                title: '👤 Perfil personalizado aplicado',
                subtitle: 'Tus preferencias se aplicaron a este análisis.',
                bodyHtml: body
            });
        }

        function buildSummaryCard(structuredReport, result) {
            const analysisSummary = structuredReport?.analysis_summary || {};
            const productName = structuredReport?.product_name || result.product_name || 'Producto analizado';
            const compatibilityPercent = scoreToPercent(analysisSummary.score_global ?? analysisSummary.compatibility_score ?? result.compatibility_score);
            const ecoPercent = scoreToPercent(analysisSummary.eco_score_avg ?? result.avg_eco_score);
            const ingredientsAnalyzed = analysisSummary.ingredients_analyzed ?? structuredReport?.stats?.total ?? result.ingredients_analyzed;
            const riskLevelRaw = analysisSummary.risk_level || result.risk_level || result.suitability;
            const subtitleText = analysisSummary.description || result.description || 'Estas son las conclusiones clave del producto que escaneaste.';
            const summaryChips = [
                { label: 'Producto', value: productName },
                { label: 'Compatibilidad global', value: compatibilityPercent != null ? `${compatibilityPercent}%` : null },
                { label: 'Índice eco', value: ecoPercent != null ? `${ecoPercent}/100` : null },
                { label: 'Ingredientes', value: ingredientsAnalyzed != null ? `${ingredientsAnalyzed} analizados` : null },
            ];
            if (riskLevelRaw) {
                summaryChips.push({ label: 'Riesgo', value: titleCase(riskLevelRaw), badge: getRiskBadge(riskLevelRaw) });
            }
            const chipsHtml = summaryChips
                .filter(chip => chip.value)
                .map(chip => `
                    <div class="summary-chip">
                        <strong>${escapeHtml(chip.label)}</strong>
                        ${escapeHtml(chip.value)} ${chip.badge || ''}
                    </div>
                `).join('');
            const badgeValue = compatibilityPercent != null
                ? `${compatibilityPercent}%`
                : (ecoPercent != null ? `${ecoPercent}/100` : '');
            const badgeHtml = badgeValue ? `<span class="score-badge">${badgeValue}</span>` : '';
            const body = `
                <div class="summary-grid">
                    ${chipsHtml}
                </div>
            `;
            return buildCollapsibleCard({
                title: '📊 Resumen del análisis',
                subtitle: escapeHtml(subtitleText),
                badgeHtml,
                bodyHtml: body,
                classes: 'result-card--summary'
            });
        }

        function buildExtractedTextCard(text) {
            const body = `
                <p class="muted" style="margin-bottom:12px;">Texto extraído del empaque para tu referencia.</p>
                <div style="background: rgba(168,85,247,0.08); padding: 16px; border-radius: 14px; font-family: monospace; white-space: pre-wrap;">
                    ${escapeHtml(text)}
                </div>
            `;
            return buildCollapsibleCard({
                title: '📄 Ingredientes detectados',
                bodyHtml: body
            });
        }

        function getRiskBadge(risk) {
            const value = (risk || '').toLowerCase();
            if (value === 'high' || value === 'critical' || value === 'alto') return '<span class="badge danger">Alto</span>';
            if (value === 'moderate' || value === 'moderado') return '<span class="badge warning">Moderado</span>';
            if (!value) return '';
            return '<span class="badge safe">Bajo</span>';
        }

        function buildIngredientsCard(structuredReport, profileContext) {
            const profile = profileContext && Object.keys(profileContext || {}).length
                ? profileContext
                : getProfileForRequest();
            const ingredientsEvaluated = normalizeEvaluatedIngredients(structuredReport?.ingredients_evaluated);
            const safety = structuredReport?.safety || {};
            const safeIngredients = Array.isArray(safety.safe) ? safety.safe : [];
            const problematicIngredients = Array.isArray(safety.problematic) ? safety.problematic : [];
            const combined = ingredientsEvaluated.length
                ? ingredientsEvaluated.map(item => ({
                    ...item,
                    status: (item.state === 'conflict' || item.state === 'replace') ? 'warning' : (item.state || 'safe')
                }))
                : [
                    ...safeIngredients.map(item => ({ ...item, status: 'safe' })),
                    ...problematicIngredients.map(item => ({ ...item, status: 'warning' }))
                ];

            if (!combined.length) {
                return '';
            }

            const productContextText = getCurrentProductTypeContext();
            const cardsHtml = combined.map(item => renderIngredientCard(item, profile)).join('');
            const body = `
                <p class="muted" style="margin-bottom:8px;">Colores según compatibilidad con tu perfil: 🟢 Alta · 🟡 Media · 🔴 Baja · ⚪ Neutra</p>
                <div class="ingredient-filters">
                    ${renderIngredientFilterButton('all', 'Todos', combined.length, true)}
                    ${renderIngredientFilterButton('safe', 'Seguros', combined.filter(item => item.status !== 'warning').length, false)}
                    ${renderIngredientFilterButton('warning', 'A revisar', combined.filter(item => item.status === 'warning').length, false)}
                </div>
                <div class="ingredients-cards" id="ingredientsCardGrid">
                    ${cardsHtml}
                </div>
            `;

            return buildCollapsibleCard({
                title: '🧪 Ingredientes evaluados',
                subtitle: productContextText
                    ? `${combined.length} ingredientes analizados para ${productContextText}.`
                    : `${combined.length} ingredientes analizados por nuestro laboratorio inteligente.`,
                bodyHtml: body
            });
        }

        function humanizeIngredientBenefit(evaluation, profile) {
            if (!evaluation || !evaluation.supports || evaluation.supports.length === 0) {
                return 'Beneficioso para tu bebé';
            }
            
            const supports = evaluation.supports.filter(s => s.type !== 'general');
            if (supports.length === 0) return 'Beneficioso para tu bebé';
            
            const firstSupport = supports[0];
            const label = firstSupport.label || '';
            
            // Humanizar según tipo
            if (label.toLowerCase().includes('hidrat') || label.toLowerCase().includes('humect')) {
                return 'Hidrata sin irritar';
            }
            if (label.toLowerCase().includes('barrera') || label.toLowerCase().includes('ceramid')) {
                return 'Ayuda a reparar la piel atópica';
            }
            if (label.toLowerCase().includes('calm') || label.toLowerCase().includes('suave') || label.toLowerCase().includes('gentle')) {
                return 'Suave y protector';
            }
            if (label.toLowerCase().includes('eccem') || label.toLowerCase().includes('atópica')) {
                return 'Ayuda con piel seca/atópica';
            }
            if (label.toLowerCase().includes('bebé') || label.toLowerCase().includes('tear')) {
                return 'Seguro para bebés, sin lágrimas';
            }
            if (label.toLowerCase().includes('prebio') || label.toLowerCase().includes('microbiome')) {
                return 'Favorece el microbioma';
            }
            
            // Simplificar texto técnico
            return label
                .replace(/proveer hidratación profunda/i, 'Hidratación profunda')
                .replace(/combatir la deshidratación/i, 'Evita resequedad')
                .replace(/mantenimiento diario suave/i, 'Suave para uso diario')
                .replace(/modo bebé.*tear-free/i, 'Sin lágrimas')
                .replace(/nutrir piel seca\/atópica/i, 'Ayuda piel seca/atópica')
                .replace(/reforzar la barrera cutánea/i, 'Protege la piel')
                .substring(0, 50);
        }

        function humanizeIngredientProblem(conflict, profile) {
            if (!conflict) return 'No recomendado para tu bebé';
            
            const label = conflict.label || '';
            
            // Humanizar según tipo
            if (label.toLowerCase().includes('dermatitis') || label.toLowerCase().includes('pañal')) {
                return 'Puede empeorar la dermatitis del pañal';
            }
            if (label.toLowerCase().includes('clima húmedo') || label.toLowerCase().includes('pesado')) {
                return 'Sensación pesada en clima húmedo/calor';
            }
            if (label.toLowerCase().includes('reseca') || label.toLowerCase().includes('irrit')) {
                return 'Puede resecar o irritar más';
            }
            if (label.toLowerCase().includes('microbiome') || label.toLowerCase().includes('prebio')) {
                return 'Puede afectar el microbioma';
            }
            if (label.toLowerCase().includes('fragancia') || label.toLowerCase().includes('sulfato')) {
                return 'No ideal para bebés sensibles';
            }
            
            return label.substring(0, 60);
        }

        function buildSimplifiedAnalysisCard(structuredReport, result, profileContext, alignment) {
            const profile = profileContext && Object.keys(profileContext || {}).length
                ? profileContext
                : getProfileForRequest();
            
            const analysisSummary = structuredReport?.analysis_summary || {};
            const compatibilityPercent = scoreToPercent(analysisSummary.score_global ?? analysisSummary.compatibility_score ?? result.compatibility_score) ?? 71;
            
            // Calcular frase corta basada en score
            let scorePhrase = '';
            if (compatibilityPercent >= 80) {
                scorePhrase = 'Adecuado para tu bebé';
            } else if (compatibilityPercent >= 60) {
                scorePhrase = 'Aceptable, pero no ideal para tu bebé';
            } else {
                scorePhrase = 'No recomendamos este producto para tu bebé';
            }
            
            // Obtener ingredientes evaluados
            const evaluated = normalizeEvaluatedIngredients(structuredReport?.ingredients_evaluated || []);
            const safe = normalizeEvaluatedIngredients(structuredReport?.safety?.safe || []);
            const problematic = normalizeEvaluatedIngredients(structuredReport?.safety?.problematic || []);
            const allIngredients = [...evaluated, ...safe, ...problematic];
            
            // Identificar ingredientes buenos (máx 5) - basado en perfil bebé
            const goodIngredients = [];
            const ingredientEvaluations = new Map();
            
            allIngredients.forEach(ing => {
                const evaluation = computeIngredientUtility(ing, profile);
                const compat = determineIngredientCompatibility(ing, evaluation);
                const name = ing.inci || ing.ingredient || ing.name || '';
                
                // Solo incluir si tiene alta compatibilidad Y supports relevantes para bebés
                if (name && compat.level === 'high' && evaluation.supports.length > 0) {
                    // Filtrar supports relevantes para bebés (no genéricos)
                    const babyRelevantSupports = evaluation.supports.filter(s => 
                        s.type !== 'general' && 
                        (s.type === 'skin_concern' || s.type === 'skin_type' || s.type === 'hair_type' || s.type === 'goal')
                    );
                    
                    if (babyRelevantSupports.length > 0 || evaluation.supports.length >= 2) {
                        ingredientEvaluations.set(name, {
                            name,
                            evaluation,
                            compat,
                            ing,
                            babyRelevantSupports
                        });
                    }
                }
            });
            
            // Ordenar por relevancia para bebés y tomar top 5
            const sortedGood = Array.from(ingredientEvaluations.values())
                .sort((a, b) => {
                    // Priorizar supports específicos de bebé
                    const aBabyScore = a.babyRelevantSupports.length * 2 + a.evaluation.supports.length;
                    const bBabyScore = b.babyRelevantSupports.length * 2 + b.evaluation.supports.length;
                    return bBabyScore - aBabyScore;
                })
                .slice(0, 5);
            
            sortedGood.forEach(item => {
                const humanizedReason = humanizeIngredientBenefit(item.evaluation, profile);
                goodIngredients.push({
                    name: item.name,
                    reason: humanizedReason
                });
            });
            
            // Identificar ingredientes problemáticos (máx 3) - basado en perfil bebé
            const badIngredients = [];
            const problematicMap = new Map();
            
            problematic.forEach(ing => {
                const name = ing.inci || ing.ingredient || ing.name || '';
                if (!name) return;
                const evaluation = computeIngredientUtility(ing, profile);
                const conflicts = evaluation.conflicts.filter(c => c.type !== 'general');
                
                if (conflicts.length > 0) {
                    problematicMap.set(name, {
                        name,
                        evaluation,
                        ing,
                        conflicts,
                        severity: conflicts.length
                    });
                }
            });
            
            // También revisar ingredientes con riesgo alto específico para bebés
            allIngredients.forEach(ing => {
                const name = ing.inci || ing.ingredient || ing.name || '';
                if (!name || problematicMap.has(name)) return;
                const risk = (ing.risk || '').toLowerCase();
                const ewg = ing.ewg_score ?? ing.ewg ?? 10;
                const evaluation = computeIngredientUtility(ing, profile);
                const conflicts = evaluation.conflicts.filter(c => c.type !== 'general');
                
                // Priorizar ingredientes problemáticos para bebés
                const nameLower = name.toLowerCase();
                const isBabyProblematic = nameLower.includes('phenoxy') || 
                                         nameLower.includes('petrol') || 
                                         nameLower.includes('paraben') ||
                                         nameLower.includes('dimethicone') ||
                                         (risk === 'high' && ewg >= 6);
                
                if (isBabyProblematic && conflicts.length > 0) {
                    problematicMap.set(name, {
                        name,
                        evaluation,
                        conflicts,
                        ing,
                        severity: conflicts.length + (ewg >= 6 ? 1 : 0)
                    });
                }
            });
            
            // Ordenar por severidad y relevancia para bebés, tomar top 3
            const sortedBad = Array.from(problematicMap.values())
                .sort((a, b) => b.severity - a.severity)
                .slice(0, 3);
            
            sortedBad.forEach(item => {
                const conflict = item.conflicts[0];
                const humanizedReason = humanizeIngredientProblem(conflict, profile);
                badIngredients.push({
                    name: item.name,
                    reason: humanizedReason
                });
            });
            
            // Generar resumen personalizado basado en cuestionario (humanizado)
            let personalizedSummary = '';
            if (profile && Object.keys(profile).length > 0) {
                const skinType = profile.skin_type || '';
                const climate = profile.face_shape || '';
                const concerns = Array.isArray(profile.skin_concerns) ? profile.skin_concerns : [];
                const goals = Array.isArray(profile.overall_goals) ? profile.overall_goals : [];
                
                const warnings = [];
                
                // Verificar problemas específicos del cuestionario
                if (concerns.some(c => c.toLowerCase().includes('dermatitis') || c.toLowerCase().includes('pañal'))) {
                    const hasProblematic = badIngredients.some(b => {
                        const name = b.name.toLowerCase();
                        return name.includes('phenoxy') || name.includes('petrol') || name.includes('ethylhexyl');
                    });
                    if (hasProblematic) {
                        warnings.push('puede empeorar la dermatitis del pañal');
                    }
                }
                
                if (climate === 'clima_humedo_calor') {
                    const hasOcclusive = badIngredients.some(b => {
                        const name = b.name.toLowerCase();
                        return name.includes('petrol') || name.includes('dimethicone');
                    });
                    if (hasOcclusive) {
                        warnings.push('no es ideal para clima húmedo/calor');
                    }
                }
                
                // Construir resumen final (más simple y directo)
                if (warnings.length > 0) {
                    personalizedSummary = `Funciona, pero ${warnings.join(' y ')}.`;
                } else if (compatibilityPercent >= 60) {
                    personalizedSummary = `Es aceptable para tu bebé, aunque hay ingredientes que podríamos mejorar.`;
                } else {
                    personalizedSummary = `No es recomendable para el perfil de tu bebé.`;
                }
            } else {
                personalizedSummary = `Completa el cuestionario para obtener un resumen personalizado.`;
            }
            
            // Recomendación de producto (simplificada y humanizada)
            const suggestedProduct = suggestBabyProduct(profile);
            const productRecommendation = suggestedProduct ? `
                <div style="background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(236, 72, 153, 0.08)); border-radius: 20px; padding: 24px; margin-top: 24px; border: 2px solid rgba(124, 58, 237, 0.2);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="font-size: 1.5rem;">⭐</span>
                        <h3 style="margin: 0; font-size: 1.2rem; color: var(--color-primary);">Recomendación Mommyshops Bebé</h3>
                    </div>
                    <div style="background: white; border-radius: 16px; padding: 20px;">
                        <h4 style="margin: 0 0 8px; font-size: 1.3rem; color: var(--color-dark);">🧴 ${escapeHtml(suggestedProduct.name)} – Microbiome Edition</h4>
                        <p style="margin: 0 0 16px; color: var(--color-muted); font-size: 0.95rem; font-weight: 600;">La opción ideal para:</p>
                        <ul style="margin: 0 0 16px; padding-left: 20px; color: var(--color-dark); font-size: 0.95rem; line-height: 1.8;">
                            ${profile.skin_type ? `<li>${escapeHtml(profile.skin_type.replace('_', ' '))}</li>` : ''}
                            ${profile.skin_concerns && profile.skin_concerns.length ? `<li>${escapeHtml(profile.skin_concerns[0])}</li>` : ''}
                            ${profile.face_shape ? `<li>${escapeHtml(getFaceZoneLabel(profile.face_shape).toLowerCase())}</li>` : ''}
                            ${profile.hair_concerns && profile.hair_concerns.some(c => c.toLowerCase().includes('prebio')) ? `<li>preferencia por prebióticos</li>` : ''}
                        </ul>
                        <p style="margin: 0 0 12px; color: var(--color-dark); font-size: 0.9rem; line-height: 1.5;">
                            <strong>Ajustes IA:</strong>
                        </p>
                        <ul style="margin: 0 0 20px; padding-left: 20px; color: var(--color-muted); font-size: 0.9rem; line-height: 1.6;">
                            ${suggestedProduct.name === 'Nube de Avena' 
                                ? '<li>+30% avena + karité si tu clima está seco</li><li>pH 5.5 tear-free</li><li>versión ultra-sensitive sin fragancia</li>'
                                : suggestedProduct.name === 'Brisa de Té Verde'
                                ? '<li>Reduce emolientes pesados en clima húmedo</li><li>Hamamelis sin alcohol para dermatitis</li><li>pH 5.5 tear-free</li>'
                                : '<li>Ajuste automático según edad y estación</li><li>Fragancia natural 0.3% o 0%</li><li>pH 5.5 tear-free</li>'}
                        </ul>
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary);">${escapeHtml(suggestedProduct.price)}</div>
                            <button type="button" class="btn btn-primary" onclick="scrollToLabsResult()" style="flex: 1; min-width: 200px; padding: 14px 24px; font-size: 1rem;">👉 Diseñar la fórmula exacta para mi bebé</button>
                        </div>
                    </div>
                </div>
            ` : '';
            
            // Construir HTML simplificado y humanizado
            const profileLine = profile && Object.keys(profile).length > 0
                ? `Perfil aplicado: ${escapeHtml((profile.skin_type || '').replace('_', ' '))}, ${escapeHtml(profile.hair_type || '—')}, ${escapeHtml(getFaceZoneLabel(profile.face_shape) || '—')}${profile.skin_concerns?.length ? `, ${escapeHtml(profile.skin_concerns[0])}` : ''}${profile.hair_concerns?.length && profile.hair_concerns.some(c => c.toLowerCase().includes('prebio')) ? `, prebióticos` : ''}.`
                : '';
            
            const goodHtml = goodIngredients.length > 0
                ? goodIngredients.map(item => `
                    <div style="display: flex; align-items: start; gap: 10px; padding: 10px 0; border-bottom: 1px solid rgba(16, 185, 129, 0.1);">
                        <span style="font-size: 1rem; flex-shrink: 0;">🟢</span>
                        <div style="flex: 1;">
                            <strong style="display: block; margin-bottom: 2px; font-size: 0.95rem;">${escapeHtml(item.name)}</strong>
                            <span style="font-size: 0.85rem; color: var(--color-muted);">– ${escapeHtml(item.reason)}</span>
                        </div>
                    </div>
                `).join('')
                : '<p class="muted" style="font-size: 0.9rem;">No se detectaron ingredientes especialmente beneficiosos.</p>';
            
            const badHtml = badIngredients.length > 0
                ? badIngredients.map(item => `
                    <div style="display: flex; align-items: start; gap: 10px; padding: 10px 0; border-bottom: 1px solid rgba(239, 68, 68, 0.1);">
                        <span style="font-size: 1rem; flex-shrink: 0;">🔴</span>
                        <div style="flex: 1;">
                            <strong style="display: block; margin-bottom: 2px; font-size: 0.95rem;">${escapeHtml(item.name)}</strong>
                            <span style="font-size: 0.85rem; color: var(--color-muted);">${escapeHtml(item.reason)}</span>
                        </div>
                    </div>
                `).join('')
                : '<p class="muted" style="font-size: 0.9rem;">No se detectaron ingredientes problemáticos significativos.</p>';
            
            const bodyHtml = `
                <div style="background: white; border-radius: 20px; padding: 28px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                    <div style="text-align: center; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid rgba(124, 58, 237, 0.1);">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--color-primary); margin-bottom: 8px;">${compatibilityPercent}/100</div>
                        <div style="font-size: 1rem; font-weight: 600; color: var(--color-dark); margin-bottom: 8px;">— ${scorePhrase}</div>
                        ${profileLine ? `<p style="margin: 0; color: var(--color-muted); font-size: 0.9rem;">${profileLine}</p>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin: 0 0 12px; font-size: 1rem; color: var(--color-dark); font-weight: 600;">✔️ Lo bueno del producto</h4>
                        <p style="margin: 0 0 12px; color: var(--color-muted); font-size: 0.85rem;">${goodIngredients.length} ingrediente${goodIngredients.length !== 1 ? 's' : ''} positivo${goodIngredients.length !== 1 ? 's' : ''} para tu bebé:</p>
                        ${goodHtml}
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin: 0 0 12px; font-size: 1rem; color: var(--color-dark); font-weight: 600;">⚠️ Lo que no es ideal</h4>
                        <p style="margin: 0 0 12px; color: var(--color-muted); font-size: 0.85rem;">${badIngredients.length} ingrediente${badIngredients.length !== 1 ? 's' : ''} importante${badIngredients.length !== 1 ? 's' : ''} a revisar:</p>
                        ${badHtml}
                    </div>
                    
                    <div style="background: rgba(15, 23, 42, 0.03); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                        <h4 style="margin: 0 0 8px; font-size: 0.95rem; color: var(--color-dark); font-weight: 600;">🌦️ Compatibilidad para tu bebé</h4>
                        <p style="margin: 0; color: var(--color-dark); font-size: 0.9rem; line-height: 1.5;">
                            <strong>${compatibilityPercent}% adecuada</strong><br>
                            ${personalizedSummary}
                        </p>
                    </div>
                    
                    ${productRecommendation}
                </div>
                
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--color-primary); padding: 12px; background: rgba(124, 58, 237, 0.08); border-radius: 12px; font-size: 0.9rem;">
                        🔽 Ver análisis técnico de los ${allIngredients.length} ingredientes
                    </summary>
                    <div style="margin-top: 16px;">
                        ${buildIngredientsCard(structuredReport, profile)}
                        ${buildCompatibilityCard(structuredReport, alignment, profile)}
                    </div>
                </details>
            `;
            
            return buildCollapsibleCard({
                title: '🌿 Mommyshops – Análisis rápido para tu bebé',
                subtitle: '',
                bodyHtml: bodyHtml,
                defaultOpen: true
            });
        }

        function buildInsightsCard(structuredReport, result, profileContext, alignment) {
            const recommendationsBlock = structuredReport?.recommendations || null;
            const srRecommendations = Array.isArray(recommendationsBlock?.summary) ? recommendationsBlock.summary : [];
            const fallback = Array.isArray(result.recommendations) ? result.recommendations : [];
            const recommendations = srRecommendations.length ? srRecommendations : fallback;

            const profile = profileContext && Object.keys(profileContext || {}).length
                ? profileContext
                : getProfileForRequest();
            const effectiveAlignment = alignment || computeProfileIngredientAlignment(structuredReport, profile);

            const summaryPoints = [];
            if (recommendationsBlock?.summary) {
                const summary = recommendationsBlock.summary;
                if (summary.ingredients_supporting !== undefined) {
                    summaryPoints.push(`${summary.ingredients_supporting} ingredientes respaldan tus objetivos.`);
                }
                if (summary.conflicts !== undefined) {
                    summaryPoints.push(summary.conflicts
                        ? `${summary.conflicts} ingredientes requieren ajustes.`
                        : 'Sin conflictos con tus necesidades declaradas.');
                }
            } else if (effectiveAlignment) {
                summaryPoints.push(`${effectiveAlignment.supportiveCount} ingredientes respaldan tus objetivos clave.`);
                summaryPoints.push(effectiveAlignment.conflictCount
                    ? `${effectiveAlignment.conflictCount} generan alertas que podemos ajustar.`
                    : 'Sin conflictos con tus necesidades declaradas.');
            } else {
                summaryPoints.push('Completa tu perfil para personalizar recomendaciones.');
            }
            if (recommendations.length) {
                summaryPoints.push(recommendations[0]);
            }

            const goalSource = recommendationsBlock?.objectives?.length
                ? recommendationsBlock.objectives.map(obj => ({ label: obj.name, value: scoreToPercent(obj.percent ?? obj.value ?? 0) ?? 0 }))
                : (effectiveAlignment?.categories || []).filter(entry => entry.type === 'goal').map(entry => {
                    const total = entry.supported + entry.conflicting;
                    const ratio = total ? Math.round((entry.supported / total) * 100) : 0;
                    return { label: entry.label, value: ratio };
                });
            const goalBars = goalSource.length
                ? goalSource.slice(0, 5).map(entry => {
                    const color = entry.value >= 80 ? '#34d399' : entry.value >= 50 ? '#fbbf24' : '#fb7185';
                    return `
                        <div class="goal-progress">
                            <div class="goal-progress-header">
                                <span>${escapeHtml(entry.label)}</span>
                                <span>${Math.round(entry.value)}%</span>
                            </div>
                            <div class="goal-progress-bar"><span style="width:${Math.round(entry.value)}%; background:${color};"></span></div>
                        </div>
                    `;
                }).join('')
                : '<p class="muted">Aún no detectamos objetivos priorizados, agrega más información a tu perfil.</p>';

            const summaryHtml = summaryPoints.map(point => `<p>✅ ${escapeHtml(point)}</p>`).join('');
            const profileLine = profile && Object.keys(profile).length
                ? `Basado en tu perfil bebé: piel ${escapeHtml(profile.skin_type || '—')}, edad ${escapeHtml(profile.hair_type || '—')}, clima ${escapeHtml(getFaceZoneLabel(profile.face_shape) || '—')}${profile.skin_concerns?.length ? `, prioridad ${escapeHtml(profile.skin_concerns[0])}` : ''}.`
                : '';
            const body = `
                <div class="recommendations-card">
                    ${profileLine ? `<p class="muted" style="margin-bottom:10px;">${profileLine}</p>` : ''}
                    <div class="recommendations-summary">
                        ${summaryHtml}
                    </div>
                    <h4 style="margin-bottom:10px;">🎯 Objetivos priorizados</h4>
                    ${goalBars}
                    <div class="recommendations-cta">
                        <button type="button" class="btn btn-secondary" onclick="openProfileWizard()">Ajustar objetivos</button>
                        <button type="button" class="btn btn-primary" onclick="scrollToLabsResult()">Ver fórmula personalizada</button>
                    </div>
                </div>
            `;

            return buildCollapsibleCard({
                title: '💡 Recomendaciones para ti',
                subtitle: 'Alineamos las recomendaciones con tus objetivos.',
                bodyHtml: body
            });
        }

        function classifyCompatibility(entry) {
            const evidence = entry.evidence || (entry.supported + entry.conflicting);
            if (!evidence) {
                return { label: 'Sin evidencia', level: 'low', percent: 0 };
            }
            const ratio = entry.supported / evidence;
            if (entry.conflicting > entry.supported) {
                return { label: 'Requiere ajustes', level: 'low', percent: Math.round(ratio * 100) };
            }
            if (ratio >= 0.66) {
                return { label: 'Alta compatibilidad', level: 'high', percent: Math.round(ratio * 100) };
            }
            if (ratio >= 0.33) {
                return { label: 'Compatibilidad media', level: 'medium', percent: Math.round(ratio * 100) };
            }
            return { label: 'Compatibilidad baja', level: 'low', percent: Math.round(ratio * 100) };
        }

        function buildCompatibilityCard(structuredReport, alignment, profile) {
            const rows = alignment?.ingredientRows || [];
            if (!alignment || !rows.length) {
                return '';
            }

            const summaryText = structuredReport?.compatibility?.goals_summary
                || (alignment.conflictCount
                    ? `${alignment.supportiveCount} ingredientes están alineados y ${alignment.conflictCount} necesitan ajustes.`
                    : 'Todos los ingredientes detectados respaldan tus objetivos principales.');

            const subtitle = profile && Object.keys(profile || {}).length
                ? 'Relación entre ingredientes, tus objetivos y su compatibilidad.'
                : 'Completa tu perfil para obtener compatibilidad personalizada.';

            const badgeClassMap = {
                high: 'compat-badge compat-badge--high',
                medium: 'compat-badge compat-badge--medium',
                low: 'compat-badge compat-badge--low',
                neutral: 'compat-badge compat-badge--none'
            };

            const limitedRows = rows.slice(0, 12);
            const tableBody = limitedRows.map(row => {
                const badgeClass = badgeClassMap[row.level] || badgeClassMap.neutral;
                return `
                    <tr>
                        <td>${escapeHtml(row.ingredient)}</td>
                        <td>${escapeHtml(row.objective)}</td>
                        <td><span class="${badgeClass}">${escapeHtml(row.label)}</span></td>
                    </tr>
                `;
            }).join('');

            const productContext = getCurrentProductTypeContext();
            const contextNote = productContext
                ? `<p class="muted" style="margin-top:12px;">Contexto actual: ${escapeHtml(productContext)}.</p>`
                : '';

            const bodyHtml = `
                <div class="compat-summary">${escapeHtml(summaryText)}</div>
                <table class="compat-table">
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Objetivo del cuestionario</th>
                            <th>Compatibilidad</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableBody}
                    </tbody>
                </table>
                ${contextNote}
            `;

            return buildCollapsibleCard({
                title: '🔍 Compatibilidad personalizada',
                subtitle,
                bodyHtml
            });
        }

        function buildFallbackResults(result, profileHtml) {
            const summaryBody = `
                <p class="muted">${escapeHtml(result.product_name || 'Producto analizado')}</p>
                <div class="summary-grid" style="margin-top:12px;">
                    <div class="summary-chip"><strong>Seguridad</strong>${result.avg_eco_score || '-'} / 100</div>
                    <div class="summary-chip"><strong>Recomendaciones</strong>${(result.recommendations || []).map(escapeHtml).join(', ') || 'Consulta el detalle'}</div>
                                </div>
                                `;

            const ingredients = Array.isArray(result.ingredients) ? result.ingredients.map(ingredient => `
                <p class="ingredient-item ${getIngredientClass(ingredient.score || 0)}">
                    <span class="ingredient-name">${escapeHtml(ingredient.name || '')}</span>
                    <span class="ingredient-score ${getScoreClass(ingredient.score || 0)}">${ingredient.score || '-'} / 100</span>
                </p>
            `).join('') : '<p class="muted">No se pudo generar el detalle de ingredientes.</p>';

            const summaryCard = buildCollapsibleCard({
                title: '📊 Resumen del análisis',
                subtitle: 'Resultados generales de seguridad y desempeño del producto.',
                bodyHtml: summaryBody
            });

            const ingredientsCard = buildCollapsibleCard({
                title: '🧪 Ingredientes analizados',
                subtitle: 'Detalle general del puntaje individual de cada ingrediente.',
                bodyHtml: ingredients
            });

            return summaryCard + (profileHtml || '') + ingredientsCard;
        }

        let builderState = null;

        function renderProductBuilder(structuredReport, analysisResult, activeProfile) {
            const mount = document.getElementById('builderMount');
            if (!mount) return;

            const suggestedProduct = suggestBabyProduct(activeProfile || getProfileForRequest());
            builderState = null;

            if (!suggestedProduct) {
                mount.innerHTML = `
                    <div class="recommendations-card">
                        <p class="muted">Completa tu perfil para recomendar la versión exacta de Mommyshops Bebé.</p>
                        <button type="button" class="btn btn-primary" onclick="openProfileWizard()">Configurar perfil</button>
                    </div>
                `;
                setStepStatus(5, 'pending');
                setStepStatus(6, 'pending');
                return;
            }

            const benefits = (suggestedProduct.bullets || []).map(point => `<li style="margin-bottom:4px;">${escapeHtml(point)}</li>`).join('');

            const productCard = `
                <div class="labs-result-card">
                    <div class="labs-result-header">
                        <div>
                            <span class="lab-badge">Mommyshops Bebé</span>
                            <h4>🧴 ${escapeHtml(suggestedProduct.name)}</h4>
                            <p class="muted">${escapeHtml(suggestedProduct.subtitle)}</p>
                        </div>
                        <div class="score-badge">${escapeHtml(suggestedProduct.price)}</div>
                    </div>
                    <div class="labs-result-body" style="grid-template-columns:1fr;">
                        <p>${escapeHtml(suggestedProduct.description)}</p>
                        <ul style="padding-left:20px;margin:0;color:var(--color-dark);font-weight:500;">
                            ${benefits}
                        </ul>
                    </div>
                    <div class="recommendations-cta">
                        <button type="button" class="btn btn-primary" onclick="openSignupModal()">Solicitar esta fórmula</button>
                        <button type="button" class="btn btn-secondary" onclick="startMainFlow()">Compartir nuevos ingredientes</button>
                    </div>
                </div>
            `;

            mount.innerHTML = buildCollapsibleCard({
                title: '🧪 Diseña tu fórmula alternativa',
                subtitle: 'Recomendamos el blend Mommyshops Bebé ideal para tu perfil.',
                bodyHtml: productCard
            });

            setStepStatus(4, 'completed');
            setStepStatus(5, 'completed');
            setStepStatus(6, 'active');
        }

        function extractDetectedIngredientNames(structuredReport) {
            if (!structuredReport) return [];
            const pool = [];
            if (Array.isArray(structuredReport.detected_ingredients)) {
                pool.push(...structuredReport.detected_ingredients);
            }
            if (Array.isArray(structuredReport?.ingredients_evaluated)) {
                structuredReport.ingredients_evaluated.forEach(item => {
                    pool.push(item.inci || item.ingredient || item.name);
                });
            }
            const safe = Array.isArray(structuredReport?.safety?.safe) ? structuredReport.safety.safe : [];
            const problematic = Array.isArray(structuredReport?.safety?.problematic) ? structuredReport.safety.problematic : [];
            safe.forEach(item => pool.push(item.ingredient || item.name));
            problematic.forEach(item => pool.push(item.ingredient || item.name));
            const baseFromFormula = extractBaseIngredientNamesFromFormula(structuredReport?.intelligent_formula);
            pool.push(...baseFromFormula);
            return uniqueStrings(pool).slice(0, 40);
        }

        function buildLabsProfilePayload(profile) {
            if (!profile || !Object.keys(profile).length) {
                return null;
            }
            const concerns = [
                ...(profile.concerns || []),
                ...(profile.skin_concerns || []),
                ...(profile.hair_concerns || [])
            ];
            const goals = profile.overall_goals || profile.goals || [];
            return {
                skin_type: profile.skin_type || null,
                hair_type: profile.hair_type || null,
                concerns: uniqueStrings(concerns),
                goals: uniqueStrings(goals)
            };
        }

        function buildLabsFormulationPlaceholder(structuredReport) {
            const detected = extractDetectedIngredientNames(structuredReport);
            if (!detected.length) {
                return '';
            }
            return `
                <div class="labs-card" id="labsFormulationMount">
                    <span class="lab-badge">Mommyshops Labs</span>
                    <h4>🧪 Estamos formulando tu producto inteligente…</h4>
                    <p class="muted">Procesando ${detected.length} ingredientes para elevar tu compatibilidad.</p>
                    <div class="labs-progress">
                        <div class="spinner"></div>
                        <span>Preparando blend personalizado…</span>
                    </div>
                </div>
            `;
        }

        function renderLabsLoadingContent(baseIngredients) {
            const baseList = baseIngredients.slice(0, 6).map(name => (
                `<li class="ingredient-chip ingredient-chip--base">${escapeHtml(name)}</li>`
            )).join('');
            return `
                <span class="lab-badge">Mommyshops Labs</span>
                <h4>🧪 Tu fórmula está calculándose en tiempo real…</h4>
                <p class="muted">Identificando activos, compatibilidad y sustituciones seguras.</p>
                <div class="ingredient-columns">
                    <div>
                        <h5>Base analizada</h5>
                        <ul class="ingredient-list">
                            ${baseList || '<li class="ingredient-chip ingredient-chip--base">Identificando ingredientes…</li>'}
                        </ul>
                    </div>
                    <div>
                        <h5>Nuestros sustitutos</h5>
                        <p class="muted">Buscando activos optimizados…</p>
                    </div>
                </div>
                <div class="labs-progress">
                    <div class="spinner"></div>
                    <span>Aplicando reglas OMS / FDA / CIR…</span>
                </div>
            `;
        }

        function renderLabsFormulationCard(mount, payload, baseIngredients = []) {
            if (!mount) return;
            if (!payload) {
                renderLabsFormulationError(mount, 'Respuesta incompleta del laboratorio.');
                return;
            }
            const source = payload.intelligent_formula || payload;
            const summary = source.summary || payload.summary || {};
            const eta = source.delivery?.estimated_time
                || summary.delivery_eta
                || (payload.mockup && payload.mockup.eta_days)
                || '5-7 días hábiles';
            const baseFromPayload = extractBaseIngredientNamesFromFormula(source);
            const basePool = baseFromPayload.length ? baseFromPayload : baseIngredients;
            const originalIngredients = basePool.length
                ? basePool.map(name => ({ name, status: 'keep' }))
                : (Array.isArray(source.original_ingredients) ? source.original_ingredients : []);
            const goalImpact = source.compatibility_by_goal || summary.compatibility_by_goal || [];
            const focusLabel = source.optimization_focus || summary.profile_hint || 'tu rutina';
            const replacementsData = Array.isArray(source.replacements) && source.replacements.length
                ? source.replacements
                : (Array.isArray(source.substitutions) ? source.substitutions.map(sub => ({
                    from: { inci: sub.for || sub.original },
                    to: { inci: sub.alternatives?.[0]?.name, reason: sub.alternatives?.[0]?.reason }
                })) : []);

            const statusClass = status => {
                const value = (status || '').toString().toLowerCase();
                if (['sustituir', 'replace', 'warning', 'conflict'].includes(value)) return 'labs-base-chip labs-base-chip--warning';
                return 'labs-base-chip labs-base-chip--safe';
            };

            let baseListHtml = originalIngredients
                .map(item => {
                    const name = typeof item === 'string' ? item : (item.name || item.inci || item.ingredient || '');
                    const note = typeof item === 'string' ? '' : (item.note || '');
                    const status = typeof item === 'string' ? 'keep' : item.status;
                    return `<li class="${statusClass(status)}" title="${escapeHtml(note)}">${escapeHtml(name)}</li>`;
                })
                .join('');
            if (!baseListHtml) {
                baseListHtml = '<li class="labs-base-chip labs-base-chip--safe">Sin ingredientes detectados</li>';
            }

            const formulaList = Array.isArray(source.new_formula) ? source.new_formula : [];
            const ingredientCount = basePool.length;
            const substitutesCount = formulaList.length;
            const keptCount = Math.max(ingredientCount - substitutesCount, 0);
            // Cálculo: (detected ingredients - substitutes) / detected ingredients
            const compatibility = ingredientCount > 0 ? Math.round(((ingredientCount - substitutesCount) / ingredientCount) * 100) : 0;
            const gaugeValue = Math.max(0, Math.min(compatibility, 100));
            const substituteCards = formulaList.length
                ? formulaList.map(item => {
                    const tagHtml = item.function_tags && item.function_tags.length
                        ? `<div class="labs-substitute-tags">${item.function_tags.map(tag => `<span>${escapeHtml(tag)}</span>`).join('')}</div>`
                        : '';
                    return `
                        <div class="labs-substitute-card">
                            <div class="labs-substitute-head">
                                <strong>${escapeHtml(item.inci || item.name || 'Activo Mommyshops')}</strong>
                            </div>
                            <p class="muted">${escapeHtml(item.reason || 'Activo recomendado por Mommyshops Labs')}</p>
                            ${tagHtml}
                        </div>
                    `;
                }).join('')
                : '<p class="muted">Aún estamos preparando los sustitutos ideales.</p>';

            const impactTable = goalImpact.length
                ? `
                    <table class="labs-impact-table">
                        <thead>
                            <tr><th>Objetivo</th><th>Antes</th><th>Después</th></tr>
                        </thead>
                        <tbody>
                            ${goalImpact.map(goal => {
                                const before = scoreToPercent(goal.before ?? goal.percent_before ?? goal.compatibility_before ?? goal.percent) ?? 0;
                                const after = scoreToPercent(goal.after ?? goal.percent_after ?? goal.compatibility_after ?? goal.percent) ?? 0;
                                return `<tr><td>${escapeHtml(goal.name || goal.goal || 'Objetivo')}</td><td>${before}%</td><td>${after}%</td></tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `
                : '';

            const replacementsHtml = replacementsData.length
                ? `<div class="labs-replacements">
                        ${replacementsData.map(rep => {
                            const from = rep.from?.inci || rep.from || rep.for || 'Ingrediente a reemplazar';
                            const to = rep.to?.inci || rep.suggested || rep.to?.name || 'Sustituto recomendado';
                            const reason = buildReplacementReason(rep.to) || rep.reason || 'Optimización recomendada por Mommyshops.';
                            const usage = rep.to?.usage_range ? `Uso sugerido: ${rep.to.usage_range}` : '';
                            const deltaRaw = rep.to?.delta_global ?? rep.delta_global ?? rep.to?.delta_compatibility ?? rep.delta_compatibility;
                            const deltaValue = scoreToPercent(deltaRaw);
                            const deltaText = (deltaValue == null || deltaValue === 0) ? '' : `${deltaValue > 0 ? '+' : ''}${deltaValue}% compatibilidad`;
                            const detail = [usage, deltaText].filter(Boolean).join(' · ');
                            return `
                                <div class="labs-replacement-card">
                                    <strong>❌ ${escapeHtml(from)}</strong>
                                    <p>${escapeHtml(reason)}</p>
                                    <strong>✅ ${escapeHtml(to)}</strong>
                                    <p>${escapeHtml(detail)}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>`
                : '';

            const variantLabel = summary.variant_label || titleCase(summary.variant || source.variant || source.mode || 'Mommyshops Labs');

            mount.innerHTML = `
                <div class="labs-result-card">
                    <div class="labs-result-header">
                        <div>
                            <span class="lab-badge">${escapeHtml(variantLabel)}</span>
                            <h4>🧪 Tu fórmula inteligente está lista.</h4>
                            <p class="muted">Optimizada para ${escapeHtml(focusLabel)}. Procesamos ${ingredientCount} ingredientes y recomendamos ${substitutesCount} sustitutos. Compatibilidad estimada: ${compatibility}%.</p>
                        </div>
                        <div class="labs-gauge" style="--gauge-value:${gaugeValue}">
                            <span>${compatibility}%</span>
                            <small>Compatibilidad</small>
                        </div>
                    </div>
                    ${impactTable}
                    ${replacementsHtml}
                    <div class="labs-result-body">
                        <div class="labs-base">
                            <h5>Ingredientes producto</h5>
                            <ul class="labs-base-chips">
                                ${baseListHtml}
                            </ul>
                        </div>
                        <div class="labs-substitutes">
                            <h5>Sustitutos recomendados</h5>
                            ${substituteCards}
                        </div>
                    </div>
                    <div class="labs-result-footer">
                        <p class="muted">Entrega estimada en ${escapeHtml(eta)} · producido bajo estándares OMS/FDA/CIR.</p>
                        <button class="cta-buy" type="button" onclick="submitCustomProduct()">
                            Solicitar blend Mommyshops
                        </button>
                    </div>
                </div>
            `;
        }

        function renderLabsFormulationError(mount, message) {
            mount.innerHTML = `
                <span class="lab-badge">Mommyshops Labs</span>
                <h4>No pudimos terminar la formulación.</h4>
                <p class="muted">${escapeHtml(message || 'Intenta nuevamente más tarde o ajusta tus ingredientes.')}</p>
            `;
        }

        function syncBuilderWithLabs() {
            if (!builderState) return;
            const labsResult = labsFormulationState.lastResult;
            if (!labsResult) return;
            const source = labsResult.intelligent_formula || labsResult;
            if (Array.isArray(source.new_formula) && source.new_formula.length) {
                builderState.labsFormula = source.new_formula;
            }
            builderState.labsSummary = source.summary || builderState.labsSummary || {
                compatibility_before: source.compatibility_before,
                compatibility_after: source.compatibility_after,
                optimization_focus: source.optimization_focus
            };
            builderState.labsMockup = source.mockup || labsResult.mockup || builderState.labsMockup || null;
        }

        async function triggerLabsFormulation(structuredReport, profile, fallbackProductName) {
            const mount = document.getElementById('labsFormulationMount');
            if (!mount || !structuredReport) {
                return;
            }
            const baseIngredients = extractDetectedIngredientNames(structuredReport);
            if (!baseIngredients.length) {
                mount.innerHTML = `
                    <span class="lab-badge">Mommyshops Labs</span>
                    <h4>Necesitamos la lista de ingredientes para formular.</h4>
                    <p class="muted">Carga una foto o pega el INCI para continuar.</p>
                `;
                return;
            }

            const payload = {
                ingredients_detected: baseIngredients,
                product_name: structuredReport.product_name || fallbackProductName || 'Producto analizado',
            };
            const profilePayload = buildLabsProfilePayload(profile);
            if (profilePayload) {
                payload.profile = profilePayload;
            }
            if (profile && profile.hair_type && profile.hair_type.toLowerCase() === 'rizado') {
                payload.variant = 'botanical';
            }
            if (!payload.profile) {
                delete payload.profile;
            }
            if (!payload.variant) {
                delete payload.variant;
            }

            const payloadKey = JSON.stringify(payload);
            if (labsFormulationState.lastPayloadKey === payloadKey) {
                return;
            }
            labsFormulationState.lastPayloadKey = payloadKey;

            if (labsFormulationState.controller) {
                labsFormulationState.controller.abort();
            }
            const controller = new AbortController();
            labsFormulationState.controller = controller;
            mount.innerHTML = renderLabsLoadingContent(baseIngredients);

            try {
                const response = await fetch(`${API_BASE}/formulate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP ${response.status}`);
                }
                const data = await response.json();
                labsFormulationState.lastResult = data;
                syncBuilderWithLabs();
                renderLabsFormulationCard(mount, data, baseIngredients);
            } catch (error) {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Mommyshops Labs error:', error);
                renderLabsFormulationError(mount, error.message || 'No pudimos generar la fórmula.');
                labsFormulationState.lastResult = null;
            } finally {
                if (labsFormulationState.controller === controller) {
                    labsFormulationState.controller = null;
                }
            }
        }
        function updateBuilderSummary(message) {
            if (!builderState) return;
            const summaryElement = document.getElementById('builderSummary');
            if (!summaryElement) return;

            const selections = builderState.items.map(item => {
                if (item.selectedIndex === '__original__' || item.alternatives.length === 0) {
                    return {
                        original: item.original,
                        selected: item.original,
                        reason: 'Se mantiene el ingrediente original',
                    };
                }
                const alt = item.alternatives[item.selectedIndex] || {};
                // Clean substitute name and reason: remove newlines, extra spaces, and generic prefixes
                const cleanName = (alt.name || item.original || '').toString()
                    .replace(/\n/g, ' ')
                    .replace(/\s+/g, ' ')
                    .replace(/\(ej\.\s*/g, '') // Remove "ej." prefix
                    .replace(/^\s*Alternativas naturales certificadas\s*:?\s*/i, '') // Remove generic prefix
                    .trim()
                    .substring(0, 100); // Limit length
                
                const cleanReason = (alt.reason || 'Alternativa recomendada').toString()
                    .replace(/\n/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .substring(0, 150); // Limit length
                
                return {
                    original: item.original,
                    selected: cleanName || item.original,
                    reason: cleanReason || 'Alternativa recomendada',
                };
            });

            const substitutionCount = selections.filter(sel => sel.original !== sel.selected).length;
            const estimatedPrice = (28 + substitutionCount * 5 + builderState.safeIngredients.length * 1.5).toFixed(2);

            const safeListHtml = builderState.safeIngredients.length
                ? `<p style="margin-top:8px;"><strong>Base saludable:</strong> ${builderState.safeIngredients.join(', ')}</p>`
                : '';

            const substitutionListHtml = selections.map(sel => `<li><strong>${escapeHtml(sel.original)} → ${escapeHtml(sel.selected)}</strong><br/><span style="color:#4b5563;">${escapeHtml(sel.reason)}</span></li>`).join('');

            summaryElement.innerHTML = `
                <h4 style="margin-bottom:8px; color:#4c1d95;">Tu blend consciente</h4>
                <p style="margin-bottom:12px;">Inversión estimada: <strong>$${estimatedPrice} USD</strong> · incluye acompañamiento Mommyshops.</p>
                <div class="progress-badges">
                    <span class="progress-badge">✨ Personalizado</span>
                    <span class="progress-badge">🧪 Validado por Labs</span>
                    <span class="progress-badge">💬 Seguimiento humano</span>
                </div>
                ${safeListHtml}
                <ul style="margin-top:12px; list-style: disc; padding-left:20px;">
                    ${substitutionListHtml}
                </ul>
                ${message ? `<p style="margin-top:12px; color:#059669; font-weight:600;">${escapeHtml(message)}</p>` : ''}
            `;
        }

        async function submitCustomProduct() {
            if (!builderState) {
                const profile = getProfileForRequest();
                const suggestedProduct = suggestBabyProduct(profile);
                if (suggestedProduct) {
                    alert(`Recomendamos ${suggestedProduct.name}. Completa la solicitud para recibir la versión personalizada 💜.`);
                    openSignupModal();
                } else {
                    alert('Completa tu perfil y escanea un producto para solicitar tu fórmula Mommyshops.');
                }
                return;
            }

            const profile = builderState.profile || getProfileForRequest();
            const substitutions = builderState.items.map(item => {
                if (item.selectedIndex === '__original__' || item.alternatives.length === 0) {
                    return {
                        original: item.original,
                        selected: item.original,
                        reason: 'Se mantiene el ingrediente original',
                    };
                }
                const alt = item.alternatives[item.selectedIndex] || {};
                return {
                    original: item.original,
                    selected: alt.name || item.original,
                    reason: alt.reason || 'Alternativa recomendada',
                };
            });

            const payload = {
                base_product_name: builderState.baseProductName,
                safe_ingredients: builderState.safeIngredients || [],
                substitutions,
                profile,
            };

            const labsPayloadSource = builderState.labsFormula && builderState.labsFormula.length
                ? builderState
                : (labsFormulationState.lastResult ? labsFormulationState.lastResult : null);

            if (labsPayloadSource && labsPayloadSource.labsFormula ? labsPayloadSource.labsFormula.length : (labsPayloadSource.new_formula || []).length) {
                const formulaList = labsPayloadSource.labsFormula || labsPayloadSource.new_formula || [];
                payload.labs_formula = formulaList;
                const labsSummary = labsPayloadSource.labsSummary || labsPayloadSource.summary || null;
                const labsMockup = labsPayloadSource.labsMockup || labsPayloadSource.mockup || null;
                if (labsSummary) {
                    payload.labs_summary = labsSummary;
                }
                if (labsMockup) {
                    payload.labs_mockup = labsMockup;
                }
            }

            try {
                const response = await fetch(`${API_BASE}/builder/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        updateBuilderSummary('Inicia sesión para que podamos resguardar tu blend y enviarte actualizaciones.');
                        setStepStatus(5, 'active');
                        setStepStatus(6, 'pending');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const priceValue = Number(data.price);
                const priceText = Number.isFinite(priceValue) ? priceValue.toFixed(2) : data.price;
                const message = `🎉 Guardamos tu blend ($${priceText} USD). ID #${data.id} — te acompañamos en cada ajuste.`;
                updateBuilderSummary(message);
                setStepStatus(5, 'completed');
                setStepStatus(6, 'completed');
            } catch (error) {
                console.error('Error creating custom product', error);
                alert('Nuestro laboratorio tuvo un inconveniente. Intenta otra vez en unos segundos o escríbenos para ayudarte.');
                setStepStatus(6, 'pending');
            }
        }
        
        window.switchTab = function switchTab(tabName, event) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        function previewImage(input) {
            if (input && input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="Preview" style="max-width: 100%; max-height: 300px; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
                    }
                };
                reader.onerror = function() {
                    console.error('Error reading file');
                    const preview = document.getElementById('imagePreview');
                    if (preview) {
                        preview.innerHTML = '<p style="color: red; margin-top: 10px;">Error al cargar la imagen</p>';
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Initialize image preview on file selection
        function initializeImageInput() {
            const imageInputEl = document.getElementById('imageInput');
            if (imageInputEl) {
                imageInputEl.addEventListener('change', function(e) {
                    previewImage(this);
                });
                console.log('Image input initialized');
                } else {
                console.warn('imageInput element not found');
            }
        }

        // Make functions globally available for onclick handlers
        window.analyzeImage = async function analyzeImage() {
            const fileInput = document.getElementById('imageInput');
            const productNameEl = document.getElementById('productName');
            const productName = (productNameEl && productNameEl.value) ? productNameEl.value : 'Unknown Product';
            const userNeedEl = document.getElementById('userNeed');
            const userNeed = (userNeedEl && userNeedEl.value) ? userNeedEl.value : null;
            const profile = getProfileForRequest();

            setCurrentProductType(userNeed);

            if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                alert('Por favor selecciona una imagen primero.');
                return;
            }
            const file = fileInput.files[0];
            const allowedMime = ['image/jpeg', 'image/png', 'image/webp'];
            const nameLower = (file.name || '').toLowerCase();
            const isHeic = nameLower.endsWith('.heic') || file.type === 'image/heic' || file.type === 'image/heif';
            const isPdf = nameLower.endsWith('.pdf') || file.type === 'application/pdf';
            if (!allowedMime.includes(file.type) || isHeic || isPdf) {
                alert('Formato no permitido. Usa .jpg, .jpeg, .png o .webp.\nSugerencia: si tu foto es HEIC (iPhone), conviértela a JPG/PNG antes de subirla.');
                return;
            }
            
            // Profile is optional - allow analysis without it but show a gentle reminder
            if (!profile) {
                const proceed = confirm('💡 Tip: Completa tu perfil para obtener recomendaciones personalizadas.\n\n¿Deseas continuar sin perfil?');
                if (!proceed) {
                    openProfileWizard();
                    return;
                }
            }

            showLoading();
            setStepStatus(2, 'completed');
            setStepStatus(3, 'active');
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('product_name', productName);
            if (userNeed) {
            formData.append('user_need', userNeed);
            }
            if (profile && Object.keys(profile).length > 0) {
                formData.append('profile', JSON.stringify(profile));
            }

            try {
                console.log('Sending image analysis request to:', `${API_BASE}/analysis/image`);
                
                const headers = {};
                // Add ngrok header if using ngrok (production)
                if (API_BASE === '/api' || API_BASE.includes('ngrok')) {
                    headers['ngrok-skip-browser-warning'] = 'true';
                }
                
                const response = await fetch(`${API_BASE}/analysis/image`, {
                    method: 'POST',
                    headers: headers,
                    body: formData,
                    // Don't set Content-Type header - let browser set it with boundary for multipart/form-data
                });

                console.log('Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    // Detectar si Vercel devolvió HTML (error de router)
                    if (errorText.includes('ROUTER_EXTERNAL_TARGET_ERROR') || errorText.includes('<!DOCTYPE html>')) {
                        throw new Error('El servidor backend no está disponible temporalmente. Por favor, intenta de nuevo en unos momentos o verifica tu conexión.');
                    }
                    
                    // Provide friendlier guidance on common OCR failure
                    if (response.status === 400 && /Could not extract text from image/i.test(errorText)) {
                        const tips = [
                            'Verifica que la foto esté enfocada y con buena iluminación.',
                            'Asegúrate de que toda la lista de ingredientes sea legible (sin cortes/reflejos).',
                            'Evita ángulos inclinados; toma la foto perpendicular a la etiqueta.',
                            'Si puedes, convierte a texto y usa la pestaña "Text Analysis".'
                        ];
                        showError('No pudimos leer el texto de la imagen. ' + tips.join(' '));
                        // Sugerir pasar a pestaña de texto
                        setTimeout(() => { if (typeof window.switchTab === 'function') window.switchTab('text'); }, 50);
                        return;
                    }
                    
                    // Intentar parsear como JSON si parece JSON
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorJson.message || errorMessage;
                    } catch {
                        // Si no es JSON, usar el texto truncado
                        errorMessage = errorText.substring(0, 200);
                    }
                    throw new Error(errorMessage);
                }

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const result = await response.json();
                    console.log('Analysis result received:', result);
                    showResults(result);
                } else {
                    // Si no es JSON, puede ser HTML (error de Vercel)
                    const text = await response.text();
                    if (text.includes('ROUTER_EXTERNAL_TARGET_ERROR') || text.includes('<!DOCTYPE html>')) {
                        throw new Error('El servidor backend no está disponible temporalmente. Por favor, intenta de nuevo en unos momentos.');
                    }
                    throw new Error(`Respuesta inesperada del servidor (${response.status})`);
                }
            } catch (error) {
                console.error('Image analysis error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                if (!/Could not extract text from image/i.test(error?.message || '')) {
                    showError('Error al analizar imagen: ' + error.message);
                }
            }
        }

        window.analyzeText = async function analyzeText() {
            const ingredientText = document.getElementById('ingredientText');
            if (!ingredientText) {
                console.error('ingredientText element not found');
                return;
            }
            
            const textValue = ingredientText.value || '';
            const productName = document.getElementById('textProductName');
            const productNameValue = (productName && productName.value) ? productName.value : 'Unknown Product';
            const userNeedEl = document.getElementById('textUserNeed');
            const userNeed = (userNeedEl && userNeedEl.value) ? userNeedEl.value : null;
            const profile = getProfileForRequest();

            setCurrentProductType(userNeed);

            if (!textValue.trim()) {
                alert('Por favor ingresa la lista de ingredientes primero.');
                return;
            }
            
            // Profile is optional - allow analysis without it but show a gentle reminder
            if (!profile) {
                const proceed = confirm('💡 Tip: Completa tu perfil para obtener recomendaciones personalizadas.\n\n¿Deseas continuar sin perfil?');
                if (!proceed) {
                    openProfileWizard();
                    return;
                }
            }

            showLoading();
            setStepStatus(2, 'completed');
            setStepStatus(3, 'active');

            try {
                const requestBody = {
                    text: textValue,
                    product_name: productNameValue
                };
                if (userNeed) {
                    requestBody.user_need = userNeed;
                }
                if (profile && Object.keys(profile).length > 0) {
                    requestBody.profile = profile;
                }
                
                console.log('Sending text analysis request to:', `${API_BASE}/analysis/text`);
                console.log('Request body:', requestBody);
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Add ngrok header if using ngrok (production)
                if (API_BASE === '/api' || API_BASE.includes('ngrok')) {
                    headers['ngrok-skip-browser-warning'] = 'true';
                }
                
                const response = await fetch(`${API_BASE}/analysis/text`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    // Detectar si Vercel devolvió HTML (error de router)
                    if (errorText.includes('ROUTER_EXTERNAL_TARGET_ERROR') || errorText.includes('<!DOCTYPE html>')) {
                        throw new Error('El servidor backend no está disponible temporalmente. Por favor, intenta de nuevo en unos momentos o verifica tu conexión.');
                    }
                    
                    // Intentar parsear como JSON si parece JSON
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorJson.message || errorMessage;
                    } catch {
                        // Si no es JSON, usar el texto truncado
                        errorMessage = errorText.substring(0, 200);
                    }
                    throw new Error(errorMessage);
                }

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const result = await response.json();
                    console.log('Analysis result received:', result);
                    showResults(result);
                } else {
                    // Si no es JSON, puede ser HTML (error de Vercel)
                    const text = await response.text();
                    if (text.includes('ROUTER_EXTERNAL_TARGET_ERROR') || text.includes('<!DOCTYPE html>')) {
                        throw new Error('El servidor backend no está disponible temporalmente. Por favor, intenta de nuevo en unos momentos.');
                    }
                    throw new Error(`Respuesta inesperada del servidor (${response.status})`);
                }
            } catch (error) {
                console.error('Text analysis error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                showError('Error al analizar texto: ' + error.message);
            }
        }

        function showLoading() {
            document.getElementById('results').classList.add('show');
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
        }


        function showResults(result) {
            const loadingEl = document.getElementById('loading');
            const resultsContent = document.getElementById('resultsContent');
            
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
            if (!resultsContent) {
                return;
            }

            resultsContent.style.display = 'block';

            if (!result || !result.success) {
                const message = result && result.error ? result.error : 'Unknown error';
                    resultsContent.innerHTML = `
                    <div class="error">
                        ❌ Analysis failed: ${escapeHtml(message)}
                        </div>
                `;
                builderState = null;
                setStepStatus(3, 'active');
                setStepStatus(4, 'pending');
                return;
            }

            setStepStatus(3, 'completed');
            setStepStatus(4, 'active');
            labsFormulationState.lastPayloadKey = null;
            labsFormulationState.lastResult = null;

            let activeProfile = (result.profile && Object.keys(result.profile).length)
                ? result.profile
                : getStoredProfile();
            let profileCardHtml = renderProfileResult(activeProfile);

            if (result.structured_report) {
                const structuredReport = result.structured_report || {};
                if ((!activeProfile || !Object.keys(activeProfile || {}).length) && structuredReport.profile && Object.keys(structuredReport.profile).length) {
                    activeProfile = structuredReport.profile;
                    profileCardHtml = renderProfileResult(activeProfile);
                }
                const alignment = computeProfileIngredientAlignment(structuredReport, activeProfile);
                const inlineFormula = structuredReport.intelligent_formula || null;
                let labsPlaceholder = buildLabsFormulationPlaceholder(structuredReport);
                if (inlineFormula && !labsPlaceholder) {
                    labsPlaceholder = '<div class="labs-card" id="labsFormulationMount"></div>';
                }
                const sections = [
                    buildSimplifiedAnalysisCard(structuredReport, result, activeProfile, alignment),
                    result.extracted_text ? buildExtractedTextCard(result.extracted_text) : '',
                    labsPlaceholder,
                ].filter(Boolean);

                resultsContent.innerHTML = `
                    <div class="success">✅ ¡Análisis completado! Personalizamos tus resultados.</div>
                    <div class="results-wrapper">
                        ${sections.join('\n')}
                        <div id="builderMount"></div>
                        </div>
                                `;

                renderProductBuilder(structuredReport, result, activeProfile);
                requestAnimationFrame(() => {
                    if (document.querySelector('[data-ingredient-filter]')) {
                        filterIngredientCards('all');
                    }
                });
                if (inlineFormula) {
                    labsFormulationState.lastResult = inlineFormula;
                    syncBuilderWithLabs();
                    const mount = document.getElementById('labsFormulationMount');
                    if (mount) {
                        const inlineBase = extractBaseIngredientNamesFromFormula(inlineFormula);
                        const fallbackBase = inlineBase.length ? inlineBase : extractDetectedIngredientNames(structuredReport);
                        renderLabsFormulationCard(mount, inlineFormula, fallbackBase);
                    }
                }
                const needsAsyncFormula = !inlineFormula || !(Array.isArray(inlineFormula.new_formula) && inlineFormula.new_formula.length);
                if (needsAsyncFormula) {
                    triggerLabsFormulation(structuredReport, activeProfile, result.product_name);
                }
                setupJourneyNavigation();
                return;
            }

            if (result.detailed_report) {
                const cards = parseDetailedReportToCards(result.detailed_report);
                const sections = [
                    buildFallbackResults(result, profileCardHtml),
                    result.extracted_text ? buildExtractedTextCard(result.extracted_text) : '',
                    ...cards,
                ].filter(Boolean);

                resultsContent.innerHTML = `
                    <div class="success">✅ Analysis completed successfully!</div>
                    <div class="results-wrapper">
                        ${sections.join('\n')}
                    </div>
                `;
                builderState = null;
                setupJourneyNavigation();
                return;
            }

            const fallbackSections = [
                buildFallbackResults(result, profileCardHtml),
                result.extracted_text ? buildExtractedTextCard(result.extracted_text) : '',
            ].filter(Boolean);

                resultsContent.innerHTML = `
                <div class="success">✅ Analysis completed successfully!</div>
                <div class="results-wrapper">
                    ${fallbackSections.join('\n')}
                    </div>
                `;
            builderState = null;
            setupJourneyNavigation();
            }
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'block';
            document.getElementById('resultsContent').innerHTML = `
                <div class="error">
                    ❌ ${message}
                </div>
            `;
        }

        function getIngredientClass(score) {
            if (score >= 80) return '';
            if (score >= 60) return 'warning';
            return 'danger';
        }

        function getScoreClass(score) {
            if (score >= 80) return '';
            if (score >= 60) return 'warning';
            return 'danger';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text == null ? '' : text;
            return div.innerHTML;
        }

        function parseDetailedReportToCards(detailedReport) {
            if (!detailedReport) return [];
            
            const cards = [];
            const lines = detailedReport.split('\n');
            let currentSection = null;
            let currentContent = [];
            
            function finishCurrentSection() {
                if (currentSection) {
                    cards.push(renderSectionCard(currentSection, currentContent.join('\n')));
                    currentSection = null;
                    currentContent = [];
                }
            }
            
            function renderSectionCard(title, content) {
                // Extract emoji and title text
                const titleMatch = title.match(/^(\*\*)(.*?)(\*\*)$/);
                const titleText = titleMatch ? titleMatch[2].trim() : title.replace(/\*\*/g, '').trim();
                
                // Parse content based on type
                let renderedContent = parseContentToHtml(content.trim());

                return buildCollapsibleCard({
                    title: escapeHtml(titleText),
                    bodyHtml: `<div style="line-height: 1.6;">${renderedContent}</div>`,
                    defaultOpen: /resumen/i.test(titleText)
                });
            }
            
            function parseContentToHtml(content) {
                if (!content) return '';
                
                let html = content;
                
                // Parse markdown tables - more robust parsing
                const tableRegex = /^\|(.+)\|$/gm;
                const tableRows = [];
                let inTable = false;
                let tableContent = [];
                
                const lines = html.split('\n');
                const processedLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const isTableRow = /^\|.+?\|\s*$/.test(line);
                    const isSeparator = /^\|[\s\-:]+\|\s*$/.test(line);
                    
                    if (isSeparator) {
                        // Skip separator row
                        continue;
                    } else if (isTableRow) {
                        if (!inTable) {
                            inTable = true;
                            tableContent = [];
                        }
                        const cells = line.split('|').map(c => c.trim()).filter(c => c);
                        if (cells.length > 0) {
                            tableContent.push(cells);
                        }
                    } else {
                        if (inTable && tableContent.length > 0) {
                            // Render accumulated table
                            let tableHtml = '<table style="width:100%; border-collapse: collapse; margin: 15px 0; background: white; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">';
                            
                            // First row is header if it contains "Ingrediente" or "Producto"
                            const isHeaderRow = tableContent.length > 0 && 
                                (tableContent[0].some(cell => cell.includes('Ingrediente') || cell.includes('Producto') || cell.includes('EWG') || cell.includes('Eco-Friendly')));
                            
                            tableContent.forEach((row, idx) => {
                                const isHeader = isHeaderRow && idx === 0;
                                tableHtml += '<tr>';
                                row.forEach(cell => {
                                    if (isHeader) {
                                        tableHtml += `<th style="text-align:left; border-bottom:2px solid #A855F7; padding:12px; background:linear-gradient(135deg, #f8f9fa, #f1f3f5); font-weight:600; color:#333;">${escapeHtml(cell)}</th>`;
                                    } else {
                                        tableHtml += `<td style="padding:12px; border-bottom:1px solid #e9ecef; vertical-align:top;">${escapeHtml(cell)}</td>`;
                                    }
                                });
                                tableHtml += '</tr>';
                            });
                            
                            tableHtml += '</table>';
                            processedLines.push(tableHtml);
                            tableContent = [];
                        }
                        inTable = false;
                        processedLines.push(line);
                    }
                }
                
                // Handle table at end of content
                if (inTable && tableContent.length > 0) {
                    let tableHtml = '<table style="width:100%; border-collapse: collapse; margin: 15px 0; background: white; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">';
                    const isHeaderRow = tableContent.length > 0 && 
                        (tableContent[0].some(cell => cell.includes('Ingrediente') || cell.includes('Producto') || cell.includes('EWG') || cell.includes('Eco-Friendly')));
                    
                    tableContent.forEach((row, idx) => {
                        const isHeader = isHeaderRow && idx === 0;
                        tableHtml += '<tr>';
                        row.forEach(cell => {
                            if (isHeader) {
                                tableHtml += `<th style="text-align:left; border-bottom:2px solid #A855F7; padding:12px; background:linear-gradient(135deg, #f8f9fa, #f1f3f5); font-weight:600; color:#333;">${escapeHtml(cell)}</th>`;
                            } else {
                                tableHtml += `<td style="padding:12px; border-bottom:1px solid #e9ecef; vertical-align:top;">${escapeHtml(cell)}</td>`;
                            }
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</table>';
                    processedLines.push(tableHtml);
                }
                
                html = processedLines.join('\n');
                
                // Parse bold text (but preserve existing HTML tags)
                html = html.replace(/\*\*([^*]+)\*\*/g, '<strong style="color: #A855F7; font-weight: 700;">$1</strong>');
                
                // Style subsections like "**Para Sodium Lauryl Sulfate (SLS):**"
                html = html.replace(/<strong style="color: #A855F7; font-weight: 700;">Para (.+?):<\/strong>/g, 
                    '<div style="margin-top: 16px; margin-bottom: 8px;"><strong style="color: #8B5CF6; font-weight: 700; font-size: 1.05em;">Para $1:</strong></div>');
                
                // Parse bullet lists (• bullets)
                html = html.replace(/^• (.+)$/gm, '•BULLET•$1•ENDBULLET•');
                // Group consecutive bullets
                html = html.replace(/(•BULLET•.*?•ENDBULLET•(?:\s*•BULLET•.*?•ENDBULLET•)*)/gs, (match) => {
                    const items = match.match(/•BULLET•(.*?)•ENDBULLET•/g).map(item => 
                        item.replace(/•BULLET•(.*?)•ENDBULLET•/, '<li style="margin: 8px 0; padding-left: 8px;">$1</li>')
                    );
                    return `<ul style="list-style: none; padding-left: 0; margin: 12px 0; line-height: 1.8;">${items.join('')}</ul>`;
                });
                
                // Parse numbered lists (like "1. ", "2. ")
                html = html.replace(/^(\d+)\.\s+(.+)$/gm, '•NUMBER•$1•SEP•$2•ENDNUMBER•');
                // Group consecutive numbered items
                html = html.replace(/(•NUMBER•.*?•ENDNUMBER•(?:\s*•NUMBER•.*?•ENDNUMBER•)*)/gs, (match) => {
                    const items = match.match(/•NUMBER•(\d+)•SEP•(.*?)•ENDNUMBER•/g).map(item => 
                        item.replace(/•NUMBER•\d+•SEP•(.*?)•ENDNUMBER•/, '<li style="margin: 8px 0; padding-left: 8px;">$1</li>')
                    );
                    return `<ol style="padding-left: 20px; margin: 12px 0; line-height: 1.8;">${items.join('')}</ol>`;
                });
                
                // Parse italics
                html = html.replace(/_(.+?)_/g, '<em>$1</em>');
                
                // Convert remaining line breaks to paragraphs (but preserve HTML blocks)
                const finalLines = html.split('\n');
                const finalProcessed = [];
                let currentParagraph = [];
                
                for (let i = 0; i < finalLines.length; i++) {
                    const line = finalLines[i].trim();
                    
                    if (!line) {
                        if (currentParagraph.length > 0) {
                            const paraText = currentParagraph.join(' ');
                            if (paraText && !paraText.startsWith('<')) {
                                finalProcessed.push(`<p style="margin: 12px 0; line-height: 1.6;">${paraText}</p>`);
                            } else if (paraText.startsWith('<')) {
                                finalProcessed.push(paraText);
                            }
                            currentParagraph = [];
                        }
                        continue;
                    }
                    
                    // If it's already HTML, add it directly
                    if (line.startsWith('<') || line.match(/^<[^>]+>/)) {
                        if (currentParagraph.length > 0) {
                            const paraText = currentParagraph.join(' ');
                            if (paraText) {
                                finalProcessed.push(`<p style="margin: 12px 0; line-height: 1.6;">${paraText}</p>`);
                            }
                            currentParagraph = [];
                        }
                        finalProcessed.push(line);
                    } else {
                        currentParagraph.push(line);
                    }
                }
                
                // Handle remaining paragraph
                if (currentParagraph.length > 0) {
                    const paraText = currentParagraph.join(' ');
                    if (paraText) {
                        finalProcessed.push(`<p style="margin: 12px 0; line-height: 1.6;">${paraText}</p>`);
                    }
                }
                
                html = finalProcessed.join('\n');
                
                // Clean up empty paragraphs
                html = html.replace(/<p style="margin: 12px 0; line-height: 1\.6;"><\/p>/g, '');
                
                // Add special styling for product substitute sections (numbered products like "1. Bálsamo Facial...")
                html = html.replace(/(<strong style="color: #A855F7; font-weight: 700;">(\d+)\. (.+?)<\/strong>)/g, 
                    (match, full, num, name) => {
                        return `<div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #f8f9fa, #f1f3f5); border-left: 4px solid #A855F7; border-radius: 8px; margin-bottom: 12px;"><strong style="color: #A855F7; font-weight: 700; font-size: 1.1em;">${num}. ${name}</strong></div>`;
                    });
                
                return html || content; // Fallback to original if parsing fails
            }
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Detect section headers (lines starting with **)
                if (line.startsWith('**') && line.endsWith('**')) {
                    finishCurrentSection();
                    currentSection = line;
                } else if (line === '---') {
                    // Separator, finish current section
                    finishCurrentSection();
                } else if (currentSection) {
                    currentContent.push(line);
                } else if (!currentSection && line) {
                    // Content before first section
                    currentContent.push(line);
                }
            }
            
            // Finish last section
            finishCurrentSection();
            
            return cards;
        }

        // Initialize everything when DOM is ready
        function initializeApp() {
            console.log('Initializing app...');
            setupSignupForm();
            
            // Initialize image input
            initializeImageInput();

            setupProductTypeListeners();
            
            // Initialize journey steps
            initializeJourneySteps();
            
            // Ensure profile is ready
            ensureProfileReady();
        }

        // Check API health on page load
        window.addEventListener('load', async () => {
            // Initialize app components
            initializeApp();
            
            try {
                // Try with trailing slash first, then without
                let response = await fetch(`${API_BASE}/health/`);
                if (!response.ok && response.status === 404) {
                    response = await fetch(`${API_BASE}/health`);
                }
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const health = await response.json();
                console.log('API Health:', health);
            } catch (error) {
                // Only log error, don't show alert - API might be available but CORS or network issue
                console.warn('API health check failed (this is normal if backend is starting):', error.message);
                // Don't show alert - let the user try to use the app anyway
            }
        });
        
        // Also initialize when DOM is ready (for faster initialization)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM already loaded
            initializeApp();
        }
    </script>

    </section>

    <section class="site-section" id="recursos" style="padding:80px 24px;">
        <div style="max-width:1200px;margin:0 auto;">
            <div style="text-align:center;margin-bottom:64px;">
                <p class="lab-badge">Recursos</p>
                <h2 style="font-size:2.5rem;margin-bottom:16px;">Todo lo que necesitas para empezar</h2>
                <p style="color:var(--color-muted);font-size:1.1rem;max-width:600px;margin:0 auto;">Biblioteca de recursos, documentación y herramientas para aprovechar al máximo Mommyshops Labs</p>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:32px;">
                <div style="background:var(--color-card);border-radius:20px;padding:32px;box-shadow:var(--shadow-soft);border:1px solid var(--color-border);transition:transform 0.2s;">
                    <div style="font-size:2.5rem;margin-bottom:16px;">📚</div>
                    <h3 style="font-size:1.5rem;margin-bottom:12px;color:var(--color-dark);">Biblioteca de ingredientes</h3>
                    <p style="color:var(--color-muted);margin-bottom:20px;">Accede a nuestra base de datos con más de 12,000 ingredientes auditados con estándares globales.</p>
                    <a href="#analizador" style="color:var(--color-primary);font-weight:600;display:inline-flex;align-items:center;gap:8px;">
                        Explorar biblioteca →
                    </a>
                </div>
        
                <div style="background:var(--color-card);border-radius:20px;padding:32px;box-shadow:var(--shadow-soft);border:1px solid var(--color-border);transition:transform 0.2s;">
                    <div style="font-size:2.5rem;margin-bottom:16px;">🔬</div>
                    <h3 style="font-size:1.5rem;margin-bottom:12px;color:var(--color-dark);">Estándares regulatorios</h3>
                    <p style="color:var(--color-muted);margin-bottom:20px;">Información sobre OMS, FDA, CIR, ICCR, SCCS y otros estándares que utilizamos en nuestros análisis.</p>
                    <a href="#analizador" style="color:var(--color-primary);font-weight:600;display:inline-flex;align-items:center;gap:8px;">
                        Conocer estándares →
                    </a>
                </div>
                <div style="background:var(--color-card);border-radius:20px;padding:32px;box-shadow:var(--shadow-soft);border:1px solid var(--color-border);transition:transform 0.2s;">
                    <div style="font-size:2.5rem;margin-bottom:16px;">💡</div>
                    <h3 style="font-size:1.5rem;margin-bottom:12px;color:var(--color-dark);">Blog y noticias</h3>
                    <p style="color:var(--color-muted);margin-bottom:20px;">Mantente al día con las últimas tendencias en clean beauty, ingredientes seguros y ciencia cosmética.</p>
                    <a href="#analizador" style="color:var(--color-primary);font-weight:600;display:inline-flex;align-items:center;gap:8px;">
                        Leer blog →
                    </a>
                </div>                
            </div>
        </div>
    </section>

    <div class="profile-toast" id="profileToast">Perfil actualizado 💜</div>

    <div class="profile-wizard-backdrop" id="profileWizard" aria-hidden="true">
        <div class="profile-wizard" role="dialog" aria-modal="true" aria-labelledby="profileWizardTitle">
            <button type="button" class="wizard-close" onclick="closeProfileWizard()">×</button>
            <div class="wizard-progress" id="profileWizardProgress">Paso 1 de 3</div>
            <h3 id="profileWizardTitle">👋 Vamos a crear tu perfil</h3>
            <p class="muted">Responde brevemente y personalizaremos cada análisis.</p>

            <div class="wizard-step is-active" data-step="1">
                <h4>👶 Tipo de piel del bebé</h4>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="skin_type" data-value="seca_atopica" data-mode="single" onclick="handleWizardChip(this)">🌾 Seca/atópica</button>
                    <button type="button" class="wizard-chip" data-field="skin_type" data-value="humeda_grasosa" data-mode="single" onclick="handleWizardChip(this)">💧 Húmeda/grasosa</button>
                    <button type="button" class="wizard-chip" data-field="skin_type" data-value="normal_mixta" data-mode="single" onclick="handleWizardChip(this)">⚖️ Normal/mixta</button>
                    <button type="button" class="wizard-chip" data-field="skin_type" data-value="ultra_sensitive" data-mode="single" onclick="handleWizardChip(this)">💖 Ultra-sensitive</button>
                </div>
                <h4 style="margin-top:18px;">🌦️ Clima y entorno</h4>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="face_shape" data-value="clima_seco_ac" data-mode="single" onclick="handleWizardChip(this)">🏜️ Clima seco/AC</button>
                    <button type="button" class="wizard-chip" data-field="face_shape" data-value="clima_humedo_calor" data-mode="single" onclick="handleWizardChip(this)">🌴 Húmedo/cálido</button>
                    <button type="button" class="wizard-chip" data-field="face_shape" data-value="transicion_estacional" data-mode="single" onclick="handleWizardChip(this)">🍂 Transición estacional</button>
                    <button type="button" class="wizard-chip" data-field="face_shape" data-value="agua_dura" data-mode="single" onclick="handleWizardChip(this)">💧 Agua dura</button>
                    <button type="button" class="wizard-chip" data-field="face_shape" data-value="modo_viaje" data-mode="single" onclick="handleWizardChip(this)">🧳 Modo viaje</button>
                </div>
                <h4 style="margin-top:18px;">🌿 Preocupaciones</h4>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="skin_concerns" data-value="eccema leve" data-mode="multi" onclick="handleWizardChip(this)">💜 Eccema leve</button>
                    <button type="button" class="wizard-chip" data-field="skin_concerns" data-value="dermatitis del pañal" data-mode="multi" onclick="handleWizardChip(this)">🧷 Dermatitis del pañal</button>
                    <button type="button" class="wizard-chip" data-field="skin_concerns" data-value="brote de calor" data-mode="multi" onclick="handleWizardChip(this)">☀️ Brote de calor</button>
                    <button type="button" class="wizard-chip" data-field="skin_concerns" data-value="irritación ocular" data-mode="multi" onclick="handleWizardChip(this)">👁 Irritación ocular</button>
                    <button type="button" class="wizard-chip" data-field="skin_concerns" data-value="piel enrojecida" data-mode="multi" onclick="handleWizardChip(this)">🌺 Piel enrojecida</button>
                </div>
            </div>

            <div class="wizard-step" data-step="2">
                <h4>🎂 Edad y preferencias de fórmula</h4>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="hair_type" data-value="0_3m" data-mode="single" onclick="handleWizardChip(this)">👶 0-3 meses</button>
                    <button type="button" class="wizard-chip" data-field="hair_type" data-value="3_12m" data-mode="single" onclick="handleWizardChip(this)">🍼 3-12 meses</button>
                    <button type="button" class="wizard-chip" data-field="hair_type" data-value="1_3y" data-mode="single" onclick="handleWizardChip(this)">🚼 1-3 años</button>
                    <button type="button" class="wizard-chip" data-field="hair_type" data-value="3_6y" data-mode="single" onclick="handleWizardChip(this)">🧒 3-6 años</button>
                </div>
                <h4 style="margin-top:18px;">✨ Preferencias</h4>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="hair_concerns" data-value="0% fragancia" data-mode="multi" onclick="handleWizardChip(this)">🚫 0 % fragancia</button>
                    <button type="button" class="wizard-chip" data-field="hair_concerns" data-value="fragancia natural 0.3%" data-mode="multi" onclick="handleWizardChip(this)">🌸 Fragancia 0.3 %</button>
                    <button type="button" class="wizard-chip" data-field="hair_concerns" data-value="prebióticos microbiome" data-mode="multi" onclick="handleWizardChip(this)">🧬 Prebióticos</button>
                    <button type="button" class="wizard-chip" data-field="hair_concerns" data-value="refill aluminio" data-mode="multi" onclick="handleWizardChip(this)">♻️ Refill aluminio</button>
                    <button type="button" class="wizard-chip" data-field="hair_concerns" data-value="modo viaje" data-mode="multi" onclick="handleWizardChip(this)">🧳 Modo viaje</button>
                </div>
            </div>

            <div class="wizard-step" data-step="3">
                <h4>🎯 Objetivos del día</h4>
                <p class="muted">Selecciona todos los que apliquen.</p>
                <div class="wizard-chip-group">
                    <button type="button" class="wizard-chip" data-field="overall_goals" data-value="calmar eccema leve" data-mode="multi" onclick="handleWizardChip(this)">💜 Calmar eccema leve</button>
                    <button type="button" class="wizard-chip" data-field="overall_goals" data-value="control de humedad/pañal" data-mode="multi" onclick="handleWizardChip(this)">🧷 Control humedad/pañal</button>
                    <button type="button" class="wizard-chip" data-field="overall_goals" data-value="mantenimiento diario suave" data-mode="multi" onclick="handleWizardChip(this)">🧼 Rutina diaria suave</button>
                    <button type="button" class="wizard-chip" data-field="overall_goals" data-value="microbiome friendly + prebióticos" data-mode="multi" onclick="handleWizardChip(this)">🧬 Microbiome + prebióticos</button>
                    <button type="button" class="wizard-chip" data-field="overall_goals" data-value="sin fragancia / tear-free" data-mode="multi" onclick="handleWizardChip(this)">🚫 Sin fragancia / tear-free</button>
                </div>
                <p class="muted" style="margin-top:16px;">Al guardar, tus análisis se ajustarán a estas necesidades.</p>
            </div>

            <div class="wizard-actions">
                <button type="button" class="btn btn-secondary" id="wizardPrevButton" onclick="prevProfileWizardStep()">Atrás</button>
                <button type="button" class="btn btn-primary" id="wizardPrimaryButton" onclick="nextProfileWizardStep()">Siguiente</button>
            </div>
        </div>
    </div>

    <details class="sticky-assistant" id="assistPanel" role="complementary" aria-label="Asistente Mommyshops" open>
        <summary>
            <button type="button" class="assistant-toggle" onclick="event.preventDefault(); toggleAssistPanel();" aria-label="Contraer o expandir panel">
                <span id="toggleIcon">−</span>
            </button>
            <strong>¿Quieres conocer más?</strong>
        <div class="assistant-actions">
            <button type="button" onclick="openSignupModal()">habla con mommyshops</button>
        </div>
    </details>

    <div class="modal-backdrop" id="signupModal" aria-hidden="true">
        <div class="signup-modal" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
            <h3 id="signupTitle">Inscríbete al laboratorio Mommyshops</h3>
            <p>Déjanos tus datos y te contactaremos con opciones personalizadas.</p>
            <form class="modal-form" id="signupForm">
                <div>
                    <label for="firstName">Nombre</label>
                    <input type="text" id="firstName" name="firstName" required>
                </div>
                <div>
                    <label for="lastName">Apellido</label>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
                <div>
                    <label for="email">Correo</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div>
                    <label for="phone">Teléfono</label>
                    <input type="tel" id="phone" name="phone">
                </div>
                <div>
                    <label for="country">País</label>
                    <select id="country" name="country" required>
                        <option value="">Selecciona tu país</option>
                        <option value="mx">México</option>
                        <option value="co">Colombia</option>
                        <option value="pe">Perú</option>
                        <option value="es">España</option>
                        <option value="us">Estados Unidos</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeSignupModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">inscribete ahora</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lottie && document.getElementById('heroLottie')) {
                window.lottie.loadAnimation({
                    container: document.getElementById('heroLottie'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'https://assets9.lottiefiles.com/private_files/lf30_dgfumnvn.json'
                });
            }
            // Persist open/closed state of assistant
            const assist = document.getElementById('assistPanel');
            if (assist) {
                const k = 'assist_open_state';
                const saved = localStorage.getItem(k);
                if (saved === 'false') assist.removeAttribute('open');
                if (saved === 'true') assist.setAttribute('open', '');
                updateToggleIcon();
                assist.addEventListener('toggle', () => {
                    localStorage.setItem(k, assist.open ? 'true' : 'false');
                    updateToggleIcon();
                });
            }
        });
    </script>
</body>
</html>
